<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coheziv 3.14 — Evaluator de regim (MVP)</title>
  <meta name="description" content="Evaluator conceptual Coeziv 3.14 (Structură–Flux–Reorganizare–Noua Structură, 2π, regim J). Single-file." />
  <style>
    :root{
      --bg: #0b0d12;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.68);
      --muted2: rgba(255,255,255,0.52);
      --accent: #7c5cff;
      --accent2:#35c2ff;
      --good:#34d399;
      --warn:#fbbf24;
      --risk:#fb7185;
      --shadow: 0 18px 60px rgba(0,0,0,0.50);
      --shadow2: 0 12px 30px rgba(0,0,0,0.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(124,92,255,0.25), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(53,194,255,0.22), transparent 55%),
        radial-gradient(900px 600px at 55% 85%, rgba(251,113,133,0.10), transparent 55%),
        linear-gradient(180deg, #07080b 0%, #0b0d12 60%, #090a0e 100%);
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{
      max-width: 1080px;
      margin: 0 auto;
      padding: 28px 18px 70px;
    }
    header{
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom: 18px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-width: 780px;
    }
    .title h1{
      margin:0;
      font-size: 26px;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }
    .title p{
      margin:0;
      color: var(--muted);
      line-height: 1.5;
      font-size: 14px;
    }
    .pillRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 8px 10px;
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 12px;
      backdrop-filter: blur(8px);
    }
    .dot{
      width:8px;height:8px;border-radius:99px;
      background: var(--accent2);
      box-shadow: 0 0 0 3px rgba(53,194,255,0.15);
    }
    .dot.warn{background: var(--warn); box-shadow:0 0 0 3px rgba(251,191,36,0.15)}
    .dot.risk{background: var(--risk); box-shadow:0 0 0 3px rgba(251,113,133,0.15)}
    .layout{
      display:grid;
      grid-template-columns: 1.35fr 0.95fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr; }
    }
    .card{
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .cardHeader{
      padding: 14px 16px;
      border-bottom: 1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .cardHeader .h{
      display:flex; flex-direction:column; gap:4px;
    }
    .cardHeader .h b{font-size: 14px; letter-spacing:-0.01em}
    .cardHeader .h span{font-size: 12px; color: var(--muted2)}
    .stepBadge{
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(124,92,255,0.35);
      background: rgba(124,92,255,0.10);
      white-space:nowrap;
    }
    .cardBody{padding: 16px}
    .progress{
      display:flex;
      gap:10px;
      margin: 0 0 14px;
    }
    .bar{
      height: 8px;
      border-radius: 99px;
      flex: 1;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.06);
      overflow:hidden;
      position:relative;
    }
    .bar > i{
      position:absolute; inset:0;
      transform: translateX(-100%);
      background: linear-gradient(90deg, rgba(124,92,255,0.85), rgba(53,194,255,0.85));
      transition: transform 320ms ease;
    }
    .bar.on > i{transform: translateX(0%)}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 620px){ .grid2{grid-template-columns: 1fr;} }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    select, textarea, input[type="number"], input[type="text"]{
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(5,6,9,0.55);
      color: rgba(255,255,255,0.92);
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
    }
    textarea{resize: vertical; min-height: 96px}
    input[type="range"]{
      width: 100%;
      appearance: none;
      height: 28px;
      background: transparent;
      margin: 0;
      padding: 0;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.08);
    }
    input[type="range"]::-webkit-slider-thumb{
      appearance:none;
      width: 18px; height:18px;
      border-radius: 999px;
      margin-top: -5px;
      background: linear-gradient(180deg, rgba(124,92,255,1), rgba(53,194,255,1));
      border: 1px solid rgba(255,255,255,0.25);
      box-shadow: 0 10px 22px rgba(0,0,0,0.35);
    }
    .field{
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: var(--radius2);
      background: rgba(255,255,255,0.03);
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .hint{
      margin-top: 10px;
      color: rgba(251,113,133,0.95);
      font-size: 12px;
      display:none;
    }
    .actions{
      margin-top: 14px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 11px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.92);
      cursor:pointer;
      user-select:none;
      transition: transform 120ms ease, background 160ms ease, border-color 160ms ease;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.07); }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{
      background: linear-gradient(90deg, rgba(124,92,255,0.95), rgba(53,194,255,0.92));
      border-color: rgba(255,255,255,0.18);
      color: #0b0d12;
      font-weight: 700;
    }
    .btn:disabled{
      opacity: 0.45;
      cursor:not-allowed;
      transform:none;
    }

    /* Right panel */
    .sideGrid{
      display:grid;
      gap: 16px;
    }
    .stat{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
    }
    .stat b{font-size: 12px; color: var(--muted)}
    .stat span{font-size: 13px; color: rgba(255,255,255,0.92)}
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 5px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.85);
      white-space:nowrap;
    }
    .disclaimer{
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(251,113,133,0.25);
      background: rgba(251,113,133,0.06);
      color: rgba(255,255,255,0.86);
      font-size: 12px;
      line-height: 1.45;
    }

    /* Gauge */
    .gauge{
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
    }
    .gaugeTop{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .gaugeTop b{font-size: 13px}
    .gaugeTop span{font-size: 12px; color: var(--muted)}
    .meter{
      position:relative;
      height: 14px;
      border-radius: 999px;
      background:
        linear-gradient(90deg,
          rgba(52,211,153,0.85) 0%,
          rgba(52,211,153,0.85) 34%,
          rgba(251,191,36,0.90) 34%,
          rgba(251,191,36,0.90) 67%,
          rgba(251,113,133,0.92) 67%,
          rgba(251,113,133,0.92) 100%);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
      overflow:hidden;
    }
    .tickRow{
      display:flex;
      justify-content:space-between;
      margin-top: 8px;
      color: var(--muted2);
      font-size: 11px;
    }
    .needle{
      position:absolute;
      top:-7px;
      width: 2px;
      height: 28px;
      background: rgba(255,255,255,0.92);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.12);
      transform: translateX(-50%);
      border-radius: 2px;
      transition: left 320ms ease;
    }
    .needle::after{
      content:"";
      position:absolute;
      left:50%;
      top: -6px;
      width: 10px; height: 10px;
      border-radius: 999px;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.92);
      box-shadow: 0 10px 22px rgba(0,0,0,0.35);
    }

    /* 2π timeline */
    .cycle{
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
    }
    .cycleTop{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .cycleTop b{font-size:13px}
    .cycleTop span{font-size:12px;color:var(--muted)}
    .steps{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    @media (max-width: 560px){ .steps{grid-template-columns: 1fr 1fr;} }
    .s{
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
      min-height: 72px;
      display:flex; flex-direction:column; gap:6px;
    }
    .s small{color: var(--muted2); font-size: 11px}
    .s b{font-size: 12px; letter-spacing:-0.01em}
    .s.on{
      border-color: rgba(124,92,255,0.35);
      background: rgba(124,92,255,0.10);
      box-shadow: 0 12px 30px rgba(124,92,255,0.10);
    }

    /* Output */
    .out{
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
    }
    .out h3{
      margin:0 0 10px;
      font-size: 14px;
      letter-spacing:-0.01em;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    @media (max-width: 560px){ .kv{grid-template-columns: 1fr;} }
    .k{
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
      display:flex; justify-content:space-between; gap:10px; align-items:center;
    }
    .k b{font-size:12px;color:var(--muted)}
    .k span{font-size:12px;color:rgba(255,255,255,0.92)}
    .msg{
      color: rgba(255,255,255,0.88);
      font-size: 13px;
      line-height: 1.55;
      margin: 8px 0 0;
    }
    .notes{
      margin-top: 10px;
      padding-left: 18px;
      color: rgba(255,255,255,0.82);
      font-size: 12px;
      line-height:1.5;
    }
    .notes li{margin: 6px 0}
    .footer{
      margin-top: 16px;
      color: var(--muted2);
      font-size: 12px;
      line-height:1.45;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Coheziv 3.14 — Evaluator de regim (MVP)</h1>
        <p>
          Instrument de analiză conceptuală bazat pe vocabularul Coeziv:
          <b>Structură</b>, <b>Flux</b>, <b>Reorganizare</b>, <b>Noua Structură</b>, ciclul <b>2π</b> și regimuri <b>J</b>.
          Nu este instrument clinic și nu produce diagnostic.
        </p>
        <div class="pillRow">
          <span class="pill"><span class="dot"></span> model conceptual</span>
          <span class="pill"><span class="dot warn"></span> regim J (ordered/mixed/tensed)</span>
          <span class="pill"><span class="dot risk"></span> fără referințe la apă</span>
        </div>
      </div>
      <div class="pillRow">
        <span class="pill">Scurtături: <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> = Evaluează</span>
      </div>
    </header>

    <div class="layout">
      <!-- Main / wizard -->
      <section class="card" aria-label="Wizard">
        <div class="cardHeader">
          <div class="h">
            <b id="stepTitle">1) Structură (S₀)</b>
            <span id="stepSubtitle">Definește domeniul și structura inițială.</span>
          </div>
          <div class="stepBadge" id="stepBadge">Step 1/3</div>
        </div>

        <div class="cardBody">
          <div class="progress" aria-label="Progres">
            <div class="bar" id="p1"><i></i></div>
            <div class="bar" id="p2"><i></i></div>
            <div class="bar" id="p3"><i></i></div>
          </div>

          <div id="stepHost"></div>

          <div class="actions">
            <button class="btn" id="btnBack" type="button">Înapoi</button>
            <div class="row">
              <button class="btn" id="btnCopy" type="button" style="display:none">Copiază rezultat</button>
              <button class="btn" id="btnReset" type="button" style="display:none">Reset</button>
              <button class="btn primary" id="btnNext" type="button">Continuă</button>
            </div>
          </div>

          <div class="hint" id="hintDomain">Selectează domeniul ca să păstrăm meta-coerența aplicării.</div>
        </div>
      </section>

      <!-- Side / results -->
      <aside class="sideGrid" aria-label="Rezumat">
        <section class="card">
          <div class="cardHeader">
            <div class="h">
              <b>Rezumat evaluare</b>
              <span>Se actualizează la „Rezultat”.</span>
            </div>
            <div class="stepBadge" id="statusChip">idle</div>
          </div>
          <div class="cardBody">
            <div class="stat">
              <b>Domeniu</b>
              <span id="sDomain">—</span>
            </div>
            <div class="stat" style="margin-top:10px">
              <b>Regim J</b>
              <span id="sRegime">—</span>
            </div>

            <div class="gauge" style="margin-top:12px">
              <div class="gaugeTop">
                <b>Zonă Coezivă</b>
                <span id="sZoneLabel">—</span>
              </div>
              <div class="meter" role="img" aria-label="Indicator zonă Coezivă">
                <div class="needle" id="needle" style="left:50%"></div>
              </div>
              <div class="tickRow">
                <span>Flexibil</span>
                <span>Tensiune</span>
                <span>Coeziune ridicată</span>
                <span>Supraîncărcare</span>
              </div>
            </div>

            <div class="cycle" style="margin-top:12px">
              <div class="cycleTop">
                <b>Ciclul 2π</b>
                <span id="sPhase">—</span>
              </div>
              <div class="steps" id="cycleSteps">
                <div class="s" data-phase="Structură (S₀)"><small>1</small><b>Structură (S₀)</b><small>stare inițială</small></div>
                <div class="s" data-phase="Flux (F)"><small>2</small><b>Flux (F)</b><small>intrări / presiuni</small></div>
                <div class="s" data-phase="Reorganizare (R)"><small>3</small><b>Reorganizare (R)</b><small>ajustare structură</small></div>
                <div class="s" data-phase="Noua structură (S₁)"><small>4</small><b>Noua structură (S₁)</b><small>stabilizare</small></div>
              </div>
            </div>

            <div class="disclaimer" style="margin-top:12px">
              <b>Disclaimer</b><br/>
              Acest instrument operează ca <b>model conceptual</b>. Nu oferă diagnostic, evaluare clinică sau măsurare experimentală.
            </div>
          </div>
        </section>

        <section class="card">
          <div class="cardHeader">
            <div class="h">
              <b>Output</b>
              <span>Mesaj + trasabilitate (notes).</span>
            </div>
            <div class="stepBadge">Coheziv 3.14</div>
          </div>
          <div class="cardBody">
            <div class="out">
              <h3>Rezultat</h3>
              <div class="kv">
                <div class="k"><b>Zonă</b><span id="oZone">—</span></div>
                <div class="k"><b>Fază 2π</b><span id="oPhase">—</span></div>
                <div class="k"><b>Regim J</b><span id="oRegime">—</span></div>
                <div class="k"><b>Cod zonă</b><span id="oZoneCode" class="mono">—</span></div>
              </div>
              <div class="msg" id="oMsg">Completează pașii și rulează evaluarea.</div>
              <ul class="notes" id="oNotes"></ul>
              <div class="footer">
                Notă: pragurile interne sunt folosite ca repere conceptuale de regim. UI-ul nu afișează temperaturi sau referințe la apă.
              </div>
            </div>
          </div>
        </section>
      </aside>
    </div>
  </div>

<script>
(() => {
  // -----------------------------
  // State (single-file)
  // -----------------------------
  const STORAGE_KEY = "coheziv314_singlefile_pro_v1";

  const defaults = () => ({
    step: 1,
    domain: "",
    structureDesc: "",
    structureLevel: 3,
    fluxType: "informațional",
    fluxIntensity: 3,
    fluxDuration: "mediu",
  });

  let state = load();

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaults();
      const obj = JSON.parse(raw);
      return { ...defaults(), ...obj };
    }catch(_){
      return defaults();
    }
  }

  function save(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(_){}
  }

  const $ = (id) => document.getElementById(id);

  // -----------------------------
  // Coeziv vocabulary-only evaluation
  // No mentions of water / no °C in UI.
  // Internal thresholds are kept as "regime selectors".
  // -----------------------------
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  function evaluateCoheziv(s){
    // validation
    if(!s.domain){
      return { ok:false, error:"Domeniul este obligatoriu (meta-coerență)." };
    }

    const structure = clamp(+s.structureLevel, 1, 5);
    const intensity = clamp(+s.fluxIntensity, 1, 5);

    const durationWeight = { "scurt": 0, "mediu": 1, "prelungit": 2 };
    const typeWeight = {
      "informațional": 1,
      "emoțional": 1,
      "sarcini/cerințe": 2,
      "schimbare externă": 1
    };

    // Internal score used only for regime selection.
    const score = structure + intensity + (durationWeight[s.fluxDuration] ?? 1) + (typeWeight[s.fluxType] ?? 1);

    // Zone (vocabulary labels; no temperature symbols)
    let zoneCode, zoneLabel;

    if(score <= 6){
      zoneCode  = "Z25";
      zoneLabel = "Flexibil";
    } else if(score <= 10){
      zoneCode  = "Z39_86";
      zoneLabel = "Tensiune reversibilă";
    } else if(score <= 12){
      zoneCode  = "Z43";
      zoneLabel = "Coeziune ridicată / rigidizare";
    } else {
      zoneCode  = "Z44_7_PLUS";
      zoneLabel = "Supraîncărcare";
    }

    // Phase 2π (heuristic)
    let phase2pi = "Flux (F)";
    if(score <= 5) phase2pi = "Structură (S₀)";
    else if(score <= 9) phase2pi = "Flux (F)";
    else if(score <= 12) phase2pi = "Reorganizare (R)";
    else phase2pi = "Noua structură (S₁)";

    // Regime J (ordered / mixed / tensed)
    let regimeJ = "ordered";
    if(score <= 8) regimeJ = "ordered";
    else if(score <= 12) regimeJ = "mixed";
    else regimeJ = "tensed";

    const messages = {
      Z25: "Regim flexibil: Structura permite integrarea fluxurilor cu reorganizare minimă. Monitorizează coerența și păstrează limitele explicite.",
      Z39_86: "Tensiune reversibilă: Fluxurile cresc; reorganizarea (R) poate restabili coerența fără schimbări drastice. Clarifică priorități și canale de flux.",
      Z43: "Coeziune ridicată: Structura este coerentă, dar flexibilitatea scade. Aplică reorganizare disciplinată (R) pentru a preveni rigidizarea și acumularea de tensiune.",
      Z44_7_PLUS: "Supraîncărcare: Fluxul depășește capacitatea structurală. Reduce fluxul, restabilește limitele și definește o reorganizare clară înainte de stabilizare (S₁).",
    };

    const notes = [];
    notes.push(`Domeniu: ${s.domain}`);
    notes.push(`Structură (nivel 1–5): ${structure}`);
    notes.push(`Flux: ${s.fluxType} | intensitate (1–5): ${intensity} | durată: ${s.fluxDuration}`);
    if((s.structureDesc || "").trim()) notes.push(`Descriere structură: ${s.structureDesc.trim()}`);

    return {
      ok:true,
      zoneCode, zoneLabel,
      phase2pi,
      regimeJ,
      message: messages[zoneCode],
      notes,
      meta: { model:"Coheziv 3.14", disclaimer:"Model conceptual. Non-clinic." }
    };
  }

  function needleLeft(zoneCode){
    // Place needle across gauge: 0..100
    // Flexibil ~ 12, Tensiune ~ 40, Coeziune ridicată ~ 70, Supraîncărcare ~ 92
    if(zoneCode === "Z25") return 12;
    if(zoneCode === "Z39_86") return 40;
    if(zoneCode === "Z43") return 70;
    return 92;
  }

  function setCycleActive(phase){
    const nodes = document.querySelectorAll('#cycleSteps .s');
    nodes.forEach(n => n.classList.toggle('on', n.getAttribute('data-phase') === phase));
  }

  // -----------------------------
  // Wizard steps (DOM)
  // -----------------------------
  function render(){
    save();
    renderHeader();
    renderProgress();
    renderStep();
    renderSidePreview();
  }

  function renderHeader(){
    const titles = {
      1: ["1) Structură (S₀)", "Definește domeniul și structura inițială."],
      2: ["2) Flux (F)", "Definește tipul, intensitatea și durata fluxului."],
      3: ["3) Rezultat", "Rulează evaluarea și analizează zona, regimul J și faza 2π."]
    };
    $('stepTitle').textContent = titles[state.step][0];
    $('stepSubtitle').textContent = titles[state.step][1];
    $('stepBadge').textContent = `Step ${state.step}/3`;

    $('btnBack').disabled = state.step === 1;

    // Buttons
    const isLast = state.step === 3;
    $('btnCopy').style.display = isLast ? "inline-flex" : "none";
    $('btnReset').style.display = isLast ? "inline-flex" : "none";
    $('btnNext').textContent = isLast ? "Evaluează" : "Continuă";
  }

  function renderProgress(){
    $('p1').classList.toggle('on', state.step >= 1);
    $('p2').classList.toggle('on', state.step >= 2);
    $('p3').classList.toggle('on', state.step >= 3);
  }

  function step1(){
    const root = document.createElement('div');

    root.innerHTML = `
      <div class="grid2">
        <div class="field">
          <label for="domain">Domeniu (obligatoriu)</label>
          <select id="domain">
            <option value="">Alege domeniul…</option>
            <option value="psihologic">psihologic</option>
            <option value="social">social</option>
            <option value="tehnic">tehnic</option>
          </select>
        </div>

        <div class="field">
          <label for="structureLevel">Nivel Structură: <span id="slVal" class="kbd"></span></label>
          <input type="range" id="structureLevel" min="1" max="5" step="1" />
          <div style="margin-top:8px;color:rgba(255,255,255,0.70);font-size:12px">
            1 = flexibil, 5 = rigid.
          </div>
        </div>
      </div>

      <div class="field" style="margin-top:12px">
        <label for="structureDesc">Descriere Structură (S₀)</label>
        <textarea id="structureDesc" placeholder="Ex: roluri, limite, reguli, dependențe, resurse…"></textarea>
      </div>

      <div class="field" style="margin-top:12px">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-size:13px;font-weight:700">Regulator de consistență conceptuală</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.70);margin-top:6px">
              Domeniul trebuie declarat înainte de evaluare.
            </div>
          </div>
          <span class="kbd">meta-coerență</span>
        </div>
      </div>
    `;

    const domain = root.querySelector('#domain');
    const structureLevel = root.querySelector('#structureLevel');
    const structureDesc = root.querySelector('#structureDesc');
    const slVal = root.querySelector('#slVal');

    domain.value = state.domain;
    structureLevel.value = String(state.structureLevel);
    structureDesc.value = state.structureDesc;
    slVal.textContent = String(state.structureLevel);

    domain.addEventListener('change', (e) => {
      state.domain = e.target.value;
      $('hintDomain').style.display = "none";
      renderSidePreview();
      save();
    });

    structureLevel.addEventListener('input', (e) => {
      state.structureLevel = +e.target.value;
      slVal.textContent = String(state.structureLevel);
      renderSidePreview();
      save();
    });

    structureDesc.addEventListener('input', (e) => {
      state.structureDesc = e.target.value;
      save();
    });

    return root;
  }

  function step2(){
    const root = document.createElement('div');

    root.innerHTML = `
      <div class="grid2">
        <div class="field">
          <label for="fluxType">Tip Flux</label>
          <select id="fluxType">
            <option value="informațional">informațional</option>
            <option value="emoțional">emoțional</option>
            <option value="sarcini/cerințe">sarcini/cerințe</option>
            <option value="schimbare externă">schimbare externă</option>
          </select>
        </div>

        <div class="field">
          <label for="fluxDuration">Durată Flux</label>
          <select id="fluxDuration">
            <option value="scurt">scurt</option>
            <option value="mediu">mediu</option>
            <option value="prelungit">prelungit</option>
          </select>
        </div>
      </div>

      <div class="field" style="margin-top:12px">
        <label for="fluxIntensity">Intensitate Flux: <span id="fiVal" class="kbd"></span></label>
        <input type="range" id="fluxIntensity" min="1" max="5" step="1" />
        <div style="margin-top:8px;color:rgba(255,255,255,0.70);font-size:12px">
          1 = mică, 5 = mare.
        </div>
      </div>

      <div class="field" style="margin-top:12px">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-size:13px;font-weight:700">Previzualizare parametri</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.70);margin-top:6px">
              Parametri de intrare pentru evaluare (nu măsurare).
            </div>
          </div>
          <span class="kbd">F (Flux)</span>
        </div>
        <div class="row" style="margin-top:10px">
          <span class="pill">Structură: <span class="kbd" id="pvS">—</span></span>
          <span class="pill">Intensitate: <span class="kbd" id="pvI">—</span></span>
          <span class="pill">Durată: <span class="kbd" id="pvD">—</span></span>
        </div>
      </div>
    `;

    const fluxType = root.querySelector('#fluxType');
    const fluxDuration = root.querySelector('#fluxDuration');
    const fluxIntensity = root.querySelector('#fluxIntensity');
    const fiVal = root.querySelector('#fiVal');

    const pvS = root.querySelector('#pvS');
    const pvI = root.querySelector('#pvI');
    const pvD = root.querySelector('#pvD');

    fluxType.value = state.fluxType;
    fluxDuration.value = state.fluxDuration;
    fluxIntensity.value = String(state.fluxIntensity);
    fiVal.textContent = String(state.fluxIntensity);

    const syncPreview = () => {
      pvS.textContent = String(state.structureLevel);
      pvI.textContent = String(state.fluxIntensity);
      pvD.textContent = String(state.fluxDuration);
    };
    syncPreview();

    fluxType.addEventListener('change', (e) => {
      state.fluxType = e.target.value;
      syncPreview();
      renderSidePreview();
      save();
    });

    fluxDuration.addEventListener('change', (e) => {
      state.fluxDuration = e.target.value;
      syncPreview();
      renderSidePreview();
      save();
    });

    fluxIntensity.addEventListener('input', (e) => {
      state.fluxIntensity = +e.target.value;
      fiVal.textContent = String(state.fluxIntensity);
      syncPreview();
      renderSidePreview();
      save();
    });

    return root;
  }

  function step3(){
    const root = document.createElement('div');

    root.innerHTML = `
      <div class="field">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div style="font-size:13px;font-weight:800">Rulează evaluarea</div>
            <div style="margin-top:6px;font-size:12px;color:rgba(255,255,255,0.70);line-height:1.45">
              Apasă <span class="kbd">Evaluează</span> pentru a genera: Zonă Coezivă, Fază 2π și Regim J.
              Nu se afișează temperaturi și nu apar referințe la apă.
            </div>
          </div>
          <span class="kbd">2π</span>
        </div>
      </div>

      <div class="field" style="margin-top:12px">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-size:13px;font-weight:700">Trasabilitate</div>
            <div style="margin-top:6px;font-size:12px;color:rgba(255,255,255,0.70)">Rezultatul include “notes” cu intrările relevante.</div>
          </div>
          <span class="kbd">notes</span>
        </div>
      </div>
    `;

    return root;
  }

  function renderStep(){
    const host = $('stepHost');
    host.innerHTML = "";
    $('hintDomain').style.display = "none";

    if(state.step === 1) host.appendChild(step1());
    else if(state.step === 2) host.appendChild(step2());
    else host.appendChild(step3());
  }

  function renderSidePreview(){
    $('sDomain').textContent = state.domain ? state.domain : "—";

    // When not evaluated yet, keep side output minimal.
    // We can do a "soft preview" by running evaluation only if domain exists.
    if(!state.domain){
      $('statusChip').textContent = "idle";
      $('sRegime').textContent = "—";
      $('sZoneLabel').textContent = "—";
      $('sPhase').textContent = "—";
      $('needle').style.left = "50%";
      setCycleActive("");
      $('oZone').textContent = "—";
      $('oPhase').textContent = "—";
      $('oRegime').textContent = "—";
      $('oZoneCode').textContent = "—";
      $('oMsg').textContent = "Completează pașii și rulează evaluarea.";
      $('oNotes').innerHTML = "";
      return;
    }

    // Soft preview: compute but do not mark as "ok" unless evaluated on step 3.
    const r = evaluateCoheziv(state);
    if(!r.ok){
      $('statusChip').textContent = "idle";
      return;
    }

    // Light preview in side panel (doesn't change "statusChip" to ok unless step3 action).
    $('sRegime').textContent = r.regimeJ;
    $('sZoneLabel').textContent = r.zoneLabel;
    $('sPhase').textContent = r.phase2pi;
    $('needle').style.left = needleLeft(r.zoneCode) + "%";
    setCycleActive(r.phase2pi);
  }

  function doEvaluate(){
    const r = evaluateCoheziv(state);
    if(!r.ok){
      $('statusChip').textContent = "error";
      $('oMsg').textContent = r.error || "Eroare de validare.";
      $('oNotes').innerHTML = "";
      return null;
    }

    $('statusChip').textContent = "ok";
    $('sDomain').textContent = state.domain;
    $('sRegime').textContent = r.regimeJ;
    $('sZoneLabel').textContent = r.zoneLabel;
    $('sPhase').textContent = r.phase2pi;

    $('needle').style.left = needleLeft(r.zoneCode) + "%";
    setCycleActive(r.phase2pi);

    $('oZone').textContent = r.zoneLabel;
    $('oPhase').textContent = r.phase2pi;
    $('oRegime').textContent = r.regimeJ;
    $('oZoneCode').textContent = r.zoneCode;

    $('oMsg').textContent = r.message;
    $('oNotes').innerHTML = "";
    r.notes.forEach(n => {
      const li = document.createElement('li');
      li.textContent = n;
      $('oNotes').appendChild(li);
    });

    return r;
  }

  function resetAll(){
    state = defaults();
    save();
    $('statusChip').textContent = "idle";
    render();
  }

  async function copyResult(){
    const r = doEvaluate();
    if(!r) return;

    const text = [
      "Coheziv 3.14 — Rezultat (model conceptual)",
      `Domeniu: ${state.domain}`,
      `Zonă Coezivă: ${r.zoneLabel} (${r.zoneCode})`,
      `Fază 2π: ${r.phase2pi}`,
      `Regim J: ${r.regimeJ}`,
      "",
      `Mesaj: ${r.message}`,
      "",
      "Notes:",
      ...r.notes.map(x => `- ${x}`),
      "",
      "Disclaimer: Model conceptual. Non-clinic."
    ].join("\n");

    try{
      await navigator.clipboard.writeText(text);
      $('statusChip').textContent = "copied";
      setTimeout(()=> $('statusChip').textContent = "ok", 900);
    }catch(_){
      prompt("Copiază manual:", text);
    }
  }

  // -----------------------------
  // Events
  // -----------------------------
  $('btnBack').addEventListener('click', () => {
    if(state.step > 1){ state.step -= 1; render(); }
  });

  $('btnNext').addEventListener('click', () => {
    if(state.step === 1){
      if(!state.domain){
        $('hintDomain').style.display = "block";
        return;
      }
      state.step = 2; render(); return;
    }
    if(state.step === 2){
      state.step = 3; render(); return;
    }
    // step 3 => evaluate
    doEvaluate();
  });

  $('btnReset').addEventListener('click', resetAll);
  $('btnCopy').addEventListener('click', copyResult);

  // keyboard shortcut: Ctrl+Enter to evaluate (from any step; will validate domain)
  document.addEventListener('keydown', (e) => {
    const isCtrlEnter = (e.ctrlKey || e.metaKey) && e.key === 'Enter';
    if(!isCtrlEnter) return;
    e.preventDefault();

    if(!state.domain){
      $('hintDomain').style.display = "block";
      return;
    }

    if(state.step < 3){
      state.step = 3;
      render();
    }
    doEvaluate();
  });

  // initial render
  render();

  // Ensure buttons visibility reflects step changes
  const observer = new MutationObserver(() => renderHeader());
  observer.observe($('stepHost'), { childList:true, subtree:true });

})();
</script>
</body>
</html>
