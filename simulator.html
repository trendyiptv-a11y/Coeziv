<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coheziv Auto — Evaluator regim (single-file)</title>
  <meta name="description" content="Evaluator conceptual Coeziv pentru sisteme auto: Structură–Flux–Reorganizare–Noua Structură, 2π, regim J. Single-file." />
  <style>
    :root{
      --bg: #0b0d12;
      --panel: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.68);
      --muted2: rgba(255,255,255,0.52);
      --accent: #7c5cff;
      --accent2:#35c2ff;
      --good:#34d399;
      --warn:#fbbf24;
      --risk:#fb7185;
      --shadow2: 0 12px 30px rgba(0,0,0,0.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(124,92,255,0.25), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(53,194,255,0.22), transparent 55%),
        radial-gradient(900px 600px at 55% 85%, rgba(251,113,133,0.10), transparent 55%),
        linear-gradient(180deg, #07080b 0%, #0b0d12 60%, #090a0e 100%);
      overflow-x:hidden;
    }
    .wrap{max-width: 1120px; margin: 0 auto; padding: 28px 18px 70px;}
    header{
      display:flex; gap:16px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap; margin-bottom: 18px;
    }
    .title{display:flex; flex-direction:column; gap:8px; max-width: 820px;}
    .title h1{margin:0; font-size:26px; letter-spacing:-0.02em; line-height:1.2;}
    .title p{margin:0; color: var(--muted); line-height:1.5; font-size:14px;}
    .pillRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px; border: 1px solid var(--stroke); border-radius: 999px;
      background: rgba(255,255,255,0.04); color: var(--muted); font-size: 12px;
      backdrop-filter: blur(8px);
    }
    .dot{width:8px;height:8px;border-radius:99px;background: var(--accent2); box-shadow:0 0 0 3px rgba(53,194,255,0.15)}
    .dot.warn{background: var(--warn); box-shadow:0 0 0 3px rgba(251,191,36,0.15)}
    .dot.risk{background: var(--risk); box-shadow:0 0 0 3px rgba(251,113,133,0.15)}
    .layout{display:grid; grid-template-columns: 1.35fr 0.95fr; gap: 16px; align-items:start;}
    @media (max-width: 980px){ .layout{grid-template-columns: 1fr;} }

    .card{
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .cardHeader{
      padding: 14px 16px; border-bottom: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .cardHeader .h{display:flex; flex-direction:column; gap:4px;}
    .cardHeader .h b{font-size: 14px; letter-spacing:-0.01em}
    .cardHeader .h span{font-size: 12px; color: var(--muted2)}
    .stepBadge{
      font-size: 12px; color: rgba(255,255,255,0.85);
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(124,92,255,0.35);
      background: rgba(124,92,255,0.10); white-space:nowrap;
    }
    .cardBody{padding: 16px}

    .progress{display:flex; gap:10px; margin: 0 0 14px;}
    .bar{
      height: 8px; border-radius: 99px; flex: 1;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.06);
      overflow:hidden; position:relative;
    }
    .bar > i{
      position:absolute; inset:0; transform: translateX(-100%);
      background: linear-gradient(90deg, rgba(124,92,255,0.85), rgba(53,194,255,0.85));
      transition: transform 320ms ease;
    }
    .bar.on > i{transform: translateX(0%)}

    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap: 12px;}
    @media (max-width: 620px){ .grid2{grid-template-columns: 1fr;} }

    label{display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px;}
    select, textarea, input[type="text"]{
      width: 100%; padding: 11px 12px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(5,6,9,0.55);
      color: rgba(255,255,255,0.92);
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
    }
    textarea{resize: vertical; min-height: 96px}

    input[type="range"]{
      width: 100%; appearance: none; height: 28px; background: transparent; margin: 0; padding: 0;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height: 10px; border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.08);
    }
    input[type="range"]::-webkit-slider-thumb{
      appearance:none; width: 18px; height:18px; border-radius: 999px; margin-top: -5px;
      background: linear-gradient(180deg, rgba(124,92,255,1), rgba(53,194,255,1));
      border: 1px solid rgba(255,255,255,0.25);
      box-shadow: 0 10px 22px rgba(0,0,0,0.35);
    }

    .field{
      padding: 12px; border: 1px solid rgba(255,255,255,0.10);
      border-radius: var(--radius2); background: rgba(255,255,255,0.03);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .kbd{
      font-family: var(--mono);
      font-size: 11px; padding: 5px 8px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.85); white-space:nowrap;
    }
    .hint{margin-top: 10px; color: rgba(251,113,133,0.95); font-size: 12px; display:none;}
    .actions{
      margin-top: 14px; display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding: 11px 14px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.92);
      cursor:pointer; user-select:none;
      transition: transform 120ms ease, background 160ms ease, border-color 160ms ease;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.07); }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{
      background: linear-gradient(90deg, rgba(124,92,255,0.95), rgba(53,194,255,0.92));
      border-color: rgba(255,255,255,0.18);
      color: #0b0d12;
      font-weight: 700;
    }
    .btn:disabled{opacity:0.45; cursor:not-allowed; transform:none;}

    .sideGrid{display:grid; gap: 16px;}
    .stat{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px; border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.03);
    }
    .stat b{font-size: 12px; color: var(--muted)}
    .stat span{font-size: 13px; color: rgba(255,255,255,0.92)}

    .disclaimer{
      padding: 12px; border-radius: var(--radius2);
      border: 1px solid rgba(251,113,133,0.25);
      background: rgba(251,113,133,0.06);
      color: rgba(255,255,255,0.86);
      font-size: 12px; line-height: 1.45;
    }

    .gauge{
      padding: 12px; border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.03);
    }
    .gaugeTop{display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap; margin-bottom:10px;}
    .gaugeTop b{font-size:13px}
    .gaugeTop span{font-size:12px; color: var(--muted)}
    .meter{
      position:relative; height: 14px; border-radius: 999px;
      background: linear-gradient(90deg,
        rgba(52,211,153,0.85) 0%,
        rgba(52,211,153,0.85) 34%,
        rgba(251,191,36,0.90) 34%,
        rgba(251,191,36,0.90) 67%,
        rgba(251,113,133,0.92) 67%,
        rgba(251,113,133,0.92) 100%);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
      overflow:hidden;
    }
    .needle{
      position:absolute; top:-7px; width: 2px; height: 28px;
      background: rgba(255,255,255,0.92);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.12);
      transform: translateX(-50%); border-radius: 2px;
      transition: left 320ms ease;
    }
    .needle::after{
      content:""; position:absolute; left:50%; top: -6px;
      width: 10px; height: 10px; border-radius: 999px;
      transform: translateX(-50%); background: rgba(255,255,255,0.92);
      box-shadow: 0 10px 22px rgba(0,0,0,0.35);
    }
    .tickRow{display:flex; justify-content:space-between; margin-top: 8px; color: var(--muted2); font-size: 11px;}

    .cycle{
      padding: 12px; border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.03);
    }
    .cycleTop{display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap; margin-bottom:10px;}
    .cycleTop b{font-size:13px}
    .cycleTop span{font-size:12px; color: var(--muted)}
    .steps{display:grid; grid-template-columns: repeat(4, 1fr); gap: 8px;}
    @media (max-width: 560px){ .steps{grid-template-columns: 1fr 1fr;} }
    .s{
      padding: 10px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
      min-height: 72px;
      display:flex; flex-direction:column; gap:6px;
    }
    .s small{color: var(--muted2); font-size: 11px}
    .s b{font-size: 12px; letter-spacing:-0.01em}
    .s.on{
      border-color: rgba(124,92,255,0.35);
      background: rgba(124,92,255,0.10);
      box-shadow: 0 12px 30px rgba(124,92,255,0.10);
    }

    .out{
      padding: 12px; border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.03);
    }
    .out h3{margin:0 0 10px; font-size: 14px; letter-spacing:-0.01em;}
    .kv{display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;}
    @media (max-width: 560px){ .kv{grid-template-columns: 1fr;} }
    .k{
      padding: 10px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10); background: rgba(0,0,0,0.10);
      display:flex; justify-content:space-between; gap:10px; align-items:center;
    }
    .k b{font-size:12px; color: var(--muted)}
    .k span{font-size:12px; color: rgba(255,255,255,0.92)}
    .msg{color: rgba(255,255,255,0.88); font-size: 13px; line-height: 1.55; margin: 8px 0 0;}
    .notes{margin-top: 10px; padding-left: 18px; color: rgba(255,255,255,0.82); font-size: 12px; line-height:1.5;}
    .notes li{margin: 6px 0}
    .footer{margin-top: 16px; color: var(--muted2); font-size: 12px; line-height:1.45;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Coheziv Auto — Evaluator de regim (MVP)</h1>
        <p>
          Aplicație single-file pentru sisteme auto (tehnic). Folosește vocabularul Coeziv:
          <b>Structură</b>, <b>Flux</b>, <b>Reorganizare</b>, <b>Noua Structură</b>, ciclul <b>2π</b> și regimuri <b>J</b>.
          Nu menționează apă și nu afișează temperaturi.
        </p>
        <div class="pillRow">
          <span class="pill"><span class="dot"></span> domeniu fix: auto</span>
          <span class="pill"><span class="dot warn"></span> regim J (ordered/mixed/tensed)</span>
          <span class="pill"><span class="dot risk"></span> output: zonă + 2π + notes</span>
        </div>
      </div>
      <div class="pillRow">
        <span class="pill">Scurtături: <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> = Evaluează</span>
      </div>
    </header>

    <div class="layout">
      <!-- Main Wizard -->
      <section class="card" aria-label="Wizard">
        <div class="cardHeader">
          <div class="h">
            <b id="stepTitle">1) Structură (S₀) — sistem auto</b>
            <span id="stepSubtitle">Definește vehiculul, subsistemul și starea structurală.</span>
          </div>
          <div class="stepBadge" id="stepBadge">Step 1/3</div>
        </div>

        <div class="cardBody">
          <div class="progress" aria-label="Progres">
            <div class="bar" id="p1"><i></i></div>
            <div class="bar" id="p2"><i></i></div>
            <div class="bar" id="p3"><i></i></div>
          </div>

          <div id="stepHost"></div>

          <div class="actions">
            <button class="btn" id="btnBack" type="button">Înapoi</button>
            <div class="row">
              <button class="btn" id="btnCopy" type="button" style="display:none">Copiază rezultat</button>
              <button class="btn" id="btnReset" type="button" style="display:none">Reset</button>
              <button class="btn primary" id="btnNext" type="button">Continuă</button>
            </div>
          </div>

          <div class="hint" id="hintRequired">Completează câmpurile obligatorii (Vehicul și Subsistem).</div>
        </div>
      </section>

      <!-- Side panels -->
      <aside class="sideGrid" aria-label="Rezumat">
        <section class="card">
          <div class="cardHeader">
            <div class="h">
              <b>Rezumat evaluare</b>
              <span>Se actualizează la „Rezultat”.</span>
            </div>
            <div class="stepBadge" id="statusChip">idle</div>
          </div>
          <div class="cardBody">
            <div class="stat">
              <b>Vehicul</b>
              <span id="sVehicle">—</span>
            </div>
            <div class="stat" style="margin-top:10px">
              <b>Subsistem</b>
              <span id="sSubsystem">—</span>
            </div>
            <div class="stat" style="margin-top:10px">
              <b>Regim J</b>
              <span id="sRegime">—</span>
            </div>

            <div class="gauge" style="margin-top:12px">
              <div class="gaugeTop">
                <b>Zonă Coezivă</b>
                <span id="sZoneLabel">—</span>
              </div>
              <div class="meter" role="img" aria-label="Indicator zonă Coezivă">
                <div class="needle" id="needle" style="left:50%"></div>
              </div>
              <div class="tickRow">
                <span>Flexibil</span>
                <span>Tensiune</span>
                <span>Coeziune ridicată</span>
                <span>Supraîncărcare</span>
              </div>
            </div>

            <div class="cycle" style="margin-top:12px">
              <div class="cycleTop">
                <b>Ciclul 2π</b>
                <span id="sPhase">—</span>
              </div>
              <div class="steps" id="cycleSteps">
                <div class="s" data-phase="Structură (S₀)"><small>1</small><b>Structură (S₀)</b><small>stare inițială</small></div>
                <div class="s" data-phase="Flux (F)"><small>2</small><b>Flux (F)</b><small>încărcări</small></div>
                <div class="s" data-phase="Reorganizare (R)"><small>3</small><b>Reorganizare (R)</b><small>adaptare</small></div>
                <div class="s" data-phase="Noua structură (S₁)"><small>4</small><b>Noua structură (S₁)</b><small>stabilizare</small></div>
              </div>
            </div>

            <div class="disclaimer" style="margin-top:12px">
              <b>Disclaimer</b><br/>
              Model conceptual pentru clarificare tehnică. Nu înlocuiește diagnoza service, procedurile producătorului sau măsurătorile instrumentate.
            </div>
          </div>
        </section>

        <section class="card">
          <div class="cardHeader">
            <div class="h">
              <b>Output</b>
              <span>Mesaj + trasabilitate (notes).</span>
            </div>
            <div class="stepBadge">Coheziv Auto</div>
          </div>
          <div class="cardBody">
            <div class="out">
              <h3>Rezultat</h3>
              <div class="kv">
                <div class="k"><b>Zonă</b><span id="oZone">—</span></div>
                <div class="k"><b>Fază 2π</b><span id="oPhase">—</span></div>
                <div class="k"><b>Regim J</b><span id="oRegime">—</span></div>
                <div class="k"><b>Cod zonă</b><span id="oZoneCode" style="font-family:var(--mono)">—</span></div>
              </div>
              <div class="msg" id="oMsg">Completează pașii și rulează evaluarea.</div>
              <ul class="notes" id="oNotes"></ul>
              <div class="footer">
                Notă: evaluarea folosește repere interne de regim pentru a produce Zonă Coezivă / 2π / J.
                Nu afișează temperaturi și nu face referințe la apă.
              </div>
            </div>
          </div>
        </section>
      </aside>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "coheziv_auto_singlefile_v1";
  const defaults = () => ({
    step: 1,
    vehicle: "",              // ex: "VW Golf 7 1.6 TDI 2016"
    subsystem: "",            // required
    structureDesc: "",
    structureLevel: 3,        // 1..5: robust/în stare bună -> fragil/îmbătrânit (interpretare UI)
    usage: "urban",
    fluxType: "sarcini/cerințe",
    fluxIntensity: 3,         // 1..5
    fluxDuration: "mediu",
    symptoms: ""
  });

  let state = load();
  const $ = (id) => document.getElementById(id);

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaults();
      const obj = JSON.parse(raw);
      return { ...defaults(), ...obj };
    }catch(_){ return defaults(); }
  }
  function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(_){ } }

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  // --- Coeziv evaluation for AUTO only ---
  // No water / no °C. Use Coeziv vocabulary only.
  function evaluateAuto(s){
    const vehicleOk = (s.vehicle || "").trim().length > 0;
    const subsystemOk = (s.subsystem || "").trim().length > 0;
    if(!vehicleOk || !subsystemOk){
      return { ok:false, error:"Vehicul și Subsistem sunt obligatorii." };
    }

    const structure = clamp(+s.structureLevel, 1, 5);
    const intensity = clamp(+s.fluxIntensity, 1, 5);

    const durationWeight = { "scurt": 0, "mediu": 1, "prelungit": 2 };
    const typeWeight = {
      "informațional": 1,         // ex: alerte/semnale, info din bord
      "emoțional": 1,             // unused, păstrat generic
      "sarcini/cerințe": 2,       // solicitare mecanică
      "schimbare externă": 1      // ex: vreme, drum, altitudine
    };

    const usageWeight = {
      "urban": 1,
      "autostradă": 1,
      "tractare/încărcare": 2,
      "off-road": 2
    };

    // Internal score: selector de regim (nu măsurare).
    // Pentru auto, "structureLevel" îl interpretăm ca: 1=robust/în stare bună, 5=fragil/îmbătrânit.
    // Ca să păstrăm semnificația Coezivă (structură rigidă -> crește riscul), folosim direct valoarea.
    const score =
      structure +
      intensity +
      (durationWeight[s.fluxDuration] ?? 1) +
      (typeWeight[s.fluxType] ?? 2) +
      (usageWeight[s.usage] ?? 1);

    let zoneCode, zoneLabel;
    if(score <= 7){
      zoneCode = "Z25";
      zoneLabel = "Flexibil (funcționare stabilă)";
    } else if(score <= 11){
      zoneCode = "Z39_86";
      zoneLabel = "Tensiune reversibilă (monitorizare/ajustare)";
    } else if(score <= 14){
      zoneCode = "Z43";
      zoneLabel = "Coeziune ridicată / rigidizare (risc de degradare)";
    } else {
      zoneCode = "Z44_7_PLUS";
      zoneLabel = "Supraîncărcare (risc de cedare)";
    }

    let phase2pi = "Flux (F)";
    if(score <= 6) phase2pi = "Structură (S₀)";
    else if(score <= 10) phase2pi = "Flux (F)";
    else if(score <= 14) phase2pi = "Reorganizare (R)";
    else phase2pi = "Noua structură (S₁)";

    let regimeJ = "ordered";
    if(score <= 9) regimeJ = "ordered";
    else if(score <= 14) regimeJ = "mixed";
    else regimeJ = "tensed";

    const msg = {
      Z25: "Regim stabil: Structura subsistemului integrează solicitările curente. Menține rutina de întreținere și limitele de operare.",
      Z39_86: "Tensiune reversibilă: Solicitările sunt semnificative, dar încă gestionabile. Recomandat: reducere de flux (solicitare), verificări țintite și reorganizare minimă (R).",
      Z43: "Coeziune ridicată / rigidizare: Subsistemul funcționează coerent, dar cu rezervă redusă la variații. Recomandat: reorganizare disciplinată (R) — proceduri de service, reglaje, înlocuiri preventive, evitarea suprasolicitării.",
      Z44_7_PLUS: "Supraîncărcare: Solicitările depășesc capacitatea structurală. Recomandat: reducere imediată de flux, diagnostic service, stabilizare (S₁) înainte de reluarea regimului normal."
    }[zoneCode];

    const notes = [];
    notes.push(`Vehicul: ${s.vehicle.trim()}`);
    notes.push(`Subsistem: ${s.subsystem}`);
    notes.push(`Structură (nivel 1–5): ${structure}`);
    notes.push(`Utilizare: ${s.usage}`);
    notes.push(`Flux: ${s.fluxType} | intensitate (1–5): ${intensity} | durată: ${s.fluxDuration}`);
    if((s.structureDesc || "").trim()) notes.push(`Descriere Structură (S₀): ${s.structureDesc.trim()}`);
    if((s.symptoms || "").trim()) notes.push(`Observații / simptome: ${s.symptoms.trim()}`);

    return { ok:true, zoneCode, zoneLabel, phase2pi, regimeJ, message: msg, notes };
  }

  function needleLeft(zoneCode){
    if(zoneCode === "Z25") return 12;
    if(zoneCode === "Z39_86") return 40;
    if(zoneCode === "Z43") return 70;
    return 92;
  }

  function setCycleActive(phase){
    const nodes = document.querySelectorAll('#cycleSteps .s');
    nodes.forEach(n => n.classList.toggle('on', n.getAttribute('data-phase') === phase));
  }

  function renderHeader(){
    const titles = {
      1: ["1) Structură (S₀) — sistem auto", "Definește vehiculul, subsistemul și starea structurală."],
      2: ["2) Flux (F) — solicitare", "Definește tipul fluxului, intensitatea și durata solicitării."],
      3: ["3) Rezultat", "Rulează evaluarea și analizează zona, regimul J și faza 2π."]
    };
    $('stepTitle').textContent = titles[state.step][0];
    $('stepSubtitle').textContent = titles[state.step][1];
    $('stepBadge').textContent = `Step ${state.step}/3`;

    $('btnBack').disabled = state.step === 1;

    const isLast = state.step === 3;
    $('btnCopy').style.display = isLast ? "inline-flex" : "none";
    $('btnReset').style.display = isLast ? "inline-flex" : "none";
    $('btnNext').textContent = isLast ? "Evaluează" : "Continuă";
  }

  function renderProgress(){
    $('p1').classList.toggle('on', state.step >= 1);
    $('p2').classList.toggle('on', state.step >= 2);
    $('p3').classList.toggle('on', state.step >= 3);
  }

  function step1(){
    const root = document.createElement('div');
    root.innerHTML = `
      <div class="grid2">
        <div class="field">
          <label for="vehicle">Vehicul (obligatoriu)</label>
          <input id="vehicle" type="text" placeholder="Ex: VW Golf 7 1.6 TDI 2016" />
          <div style="margin-top:8px;color:rgba(255,255,255,0.70);font-size:12px">
            Folosit doar pentru trasabilitate (notes).
          </div>
        </div>

        <div class="field">
          <label for="subsystem">Subsistem (obligatoriu)</label>
          <select id="subsystem">
            <option value="">Alege subsistem…</option>
            <option value="Motor">Motor</option>
            <option value="Transmisie">Transmisie</option>
            <option value="Frânare">Frânare</option>
            <option value="Răcire">Răcire</option>
            <option value="Electric / baterie / alternator">Electric / baterie / alternator</option>
            <option value="Suspensie / direcție">Suspensie / direcție</option>
            <option value="Climatizare">Climatizare</option>
            <option value="Altul">Altul</option>
          </select>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div class="field">
          <label for="structureLevel">Structură (nivel): <span id="slVal" class="kbd"></span></label>
          <input type="range" id="structureLevel" min="1" max="5" step="1" />
          <div style="margin-top:8px;color:rgba(255,255,255,0.70);font-size:12px">
            1 = structură robustă / în stare bună, 5 = structură fragilă / îmbătrânită.
          </div>
        </div>

        <div class="field">
          <label for="usage">Context utilizare</label>
          <select id="usage">
            <option value="urban">urban</option>
            <option value="autostradă">autostradă</option>
            <option value="tractare/încărcare">tractare/încărcare</option>
            <option value="off-road">off-road</option>
          </select>
        </div>
      </div>

      <div class="field" style="margin-top:12px">
        <label for="structureDesc">Descriere Structură (S₀)</label>
        <textarea id="structureDesc" placeholder="Ex: întreținere recentă, piese înlocuite, istoricul subsistemului, limitări…"></textarea>
      </div>
    `;

    const vehicle = root.querySelector('#vehicle');
    const subsystem = root.querySelector('#subsystem');
    const structureLevel = root.querySelector('#structureLevel');
    const slVal = root.querySelector('#slVal');
    const usage = root.querySelector('#usage');
    const structureDesc = root.querySelector('#structureDesc');

    vehicle.value = state.vehicle;
    subsystem.value = state.subsystem;
    structureLevel.value = String(state.structureLevel);
    slVal.textContent = String(state.structureLevel);
    usage.value = state.usage;
    structureDesc.value = state.structureDesc;

    const onReqChange = () => { $('hintRequired').style.display = "none"; renderSidePreview(); save(); };

    vehicle.addEventListener('input', (e) => { state.vehicle = e.target.value; onReqChange(); });
    subsystem.addEventListener('change', (e) => { state.subsystem = e.target.value; onReqChange(); });

    structureLevel.addEventListener('input', (e) => {
      state.structureLevel = +e.target.value;
      slVal.textContent = String(state.structureLevel);
      renderSidePreview(); save();
    });

    usage.addEventListener('change', (e) => { state.usage = e.target.value; renderSidePreview(); save(); });
    structureDesc.addEventListener('input', (e) => { state.structureDesc = e.target.value; save(); });

    return root;
  }

  function step2(){
    const root = document.createElement('div');
    root.innerHTML = `
      <div class="grid2">
        <div class="field">
          <label for="fluxType">Tip Flux (solicitare)</label>
          <select id="fluxType">
            <option value="sarcini/cerințe">sarcini/cerințe (solicitare mecanică)</option>
            <option value="schimbare externă">schimbare externă (drum, vreme, altitudine)</option>
            <option value="informațional">informațional (alerte/semnale)</option>
          </select>
        </div>

        <div class="field">
          <label for="fluxDuration">Durată flux</label>
          <select id="fluxDuration">
            <option value="scurt">scurt</option>
            <option value="mediu">mediu</option>
            <option value="prelungit">prelungit</option>
          </select>
        </div>
      </div>

      <div class="field" style="margin-top:12px">
        <label for="fluxIntensity">Intensitate flux: <span id="fiVal" class="kbd"></span></label>
        <input type="range" id="fluxIntensity" min="1" max="5" step="1" />
        <div style="margin-top:8px;color:rgba(255,255,255,0.70);font-size:12px">
          1 = mică, 5 = mare (solicitare / presiune operațională).
        </div>
      </div>

      <div class="field" style="margin-top:12px">
        <label for="symptoms">Observații / simptome (opțional)</label>
        <textarea id="symptoms" placeholder="Ex: vibrații, zgomote, pierdere putere, martori bord, miros, variații…"></textarea>
      </div>
    `;

    const fluxType = root.querySelector('#fluxType');
    const fluxDuration = root.querySelector('#fluxDuration');
    const fluxIntensity = root.querySelector('#fluxIntensity');
    const fiVal = root.querySelector('#fiVal');
    const symptoms = root.querySelector('#symptoms');

    fluxType.value = state.fluxType;
    fluxDuration.value = state.fluxDuration;
    fluxIntensity.value = String(state.fluxIntensity);
    fiVal.textContent = String(state.fluxIntensity);
    symptoms.value = state.symptoms;

    fluxType.addEventListener('change', (e) => { state.fluxType = e.target.value; renderSidePreview(); save(); });
    fluxDuration.addEventListener('change', (e) => { state.fluxDuration = e.target.value; renderSidePreview(); save(); });
    fluxIntensity.addEventListener('input', (e) => {
      state.fluxIntensity = +e.target.value;
      fiVal.textContent = String(state.fluxIntensity);
      renderSidePreview(); save();
    });
    symptoms.addEventListener('input', (e) => { state.symptoms = e.target.value; save(); });

    return root;
  }

  function step3(){
    const root = document.createElement('div');
    root.innerHTML = `
      <div class="field">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div style="font-size:13px;font-weight:800">Rulează evaluarea</div>
            <div style="margin-top:6px;font-size:12px;color:rgba(255,255,255,0.70);line-height:1.45">
              Apasă <span class="kbd">Evaluează</span> pentru a genera: Zonă Coezivă, Fază 2π și Regim J.
              Output-ul include „notes” pentru trasabilitate tehnică.
            </div>
          </div>
          <span class="kbd">2π</span>
        </div>
      </div>
    `;
    return root;
  }

  function renderStep(){
    const host = $('stepHost');
    host.innerHTML = "";
    $('hintRequired').style.display = "none";
    if(state.step === 1) host.appendChild(step1());
    else if(state.step === 2) host.appendChild(step2());
    else host.appendChild(step3());
  }

  function renderSidePreview(){
    $('sVehicle').textContent = state.vehicle?.trim() ? state.vehicle.trim() : "—";
    $('sSubsystem').textContent = state.subsystem?.trim() ? state.subsystem.trim() : "—";

    const r = evaluateAuto(state);
    if(!r.ok){
      $('statusChip').textContent = "idle";
      $('sRegime').textContent = "—";
      $('sZoneLabel').textContent = "—";
      $('sPhase').textContent = "—";
      $('needle').style.left = "50%";
      setCycleActive("");
      return;
    }

    // Soft preview (nu scrie în Output până nu evaluezi)
    $('sRegime').textContent = r.regimeJ;
    $('sZoneLabel').textContent = r.zoneLabel;
    $('sPhase').textContent = r.phase2pi;
    $('needle').style.left = needleLeft(r.zoneCode) + "%";
    setCycleActive(r.phase2pi);
  }

  function doEvaluate(){
    const r = evaluateAuto(state);
    if(!r.ok){
      $('statusChip').textContent = "error";
      $('oMsg').textContent = r.error || "Eroare de validare.";
      $('oNotes').innerHTML = "";
      return null;
    }

    $('statusChip').textContent = "ok";
    $('sVehicle').textContent = state.vehicle.trim();
    $('sSubsystem').textContent = state.subsystem;
    $('sRegime').textContent = r.regimeJ;
    $('sZoneLabel').textContent = r.zoneLabel;
    $('sPhase').textContent = r.phase2pi;

    $('needle').style.left = needleLeft(r.zoneCode) + "%";
    setCycleActive(r.phase2pi);

    $('oZone').textContent = r.zoneLabel;
    $('oPhase').textContent = r.phase2pi;
    $('oRegime').textContent = r.regimeJ;
    $('oZoneCode').textContent = r.zoneCode;

    $('oMsg').textContent = r.message;
    $('oNotes').innerHTML = "";
    r.notes.forEach(n => {
      const li = document.createElement('li');
      li.textContent = n;
      $('oNotes').appendChild(li);
    });

    return r;
  }

  function resetAll(){
    state = defaults();
    save();
    $('statusChip').textContent = "idle";
    $('oZone').textContent = "—";
    $('oPhase').textContent = "—";
    $('oRegime').textContent = "—";
    $('oZoneCode').textContent = "—";
    $('oMsg').textContent = "Completează pașii și rulează evaluarea.";
    $('oNotes').innerHTML = "";
    render();
  }

  async function copyResult(){
    const r = doEvaluate();
    if(!r) return;

    const text = [
      "Coheziv Auto — Rezultat (model conceptual)",
      `Vehicul: ${state.vehicle.trim()}`,
      `Subsistem: ${state.subsystem}`,
      `Zonă Coezivă: ${r.zoneLabel} (${r.zoneCode})`,
      `Fază 2π: ${r.phase2pi}`,
      `Regim J: ${r.regimeJ}`,
      "",
      `Mesaj: ${r.message}`,
      "",
      "Notes:",
      ...r.notes.map(x => `- ${x}`),
      "",
      "Disclaimer: Model conceptual. Nu înlocuiește diagnoza service."
    ].join("\n");

    try{
      await navigator.clipboard.writeText(text);
      $('statusChip').textContent = "copied";
      setTimeout(()=> $('statusChip').textContent = "ok", 900);
    }catch(_){
      prompt("Copiază manual:", text);
    }
  }

  function render(){
    save();
    renderHeader();
    renderProgress();
    renderStep();
    renderSidePreview();

    // Buttons state
    $('btnBack').disabled = state.step === 1;
    const isLast = state.step === 3;
    $('btnCopy').style.display = isLast ? "inline-flex" : "none";
    $('btnReset').style.display = isLast ? "inline-flex" : "none";
  }

  // Events
  $('btnBack').addEventListener('click', () => { if(state.step > 1){ state.step -= 1; render(); } });

  $('btnNext').addEventListener('click', () => {
    if(state.step === 1){
      const ok = (state.vehicle || "").trim() && (state.subsystem || "").trim();
      if(!ok){ $('hintRequired').style.display = "block"; return; }
      state.step = 2; render(); return;
    }
    if(state.step === 2){
      state.step = 3; render(); return;
    }
    doEvaluate();
  });

  $('btnReset').addEventListener('click', resetAll);
  $('btnCopy').addEventListener('click', copyResult);

  document.addEventListener('keydown', (e) => {
    const isCtrlEnter = (e.ctrlKey || e.metaKey) && e.key === 'Enter';
    if(!isCtrlEnter) return;
    e.preventDefault();

    const ok = (state.vehicle || "").trim() && (state.subsystem || "").trim();
    if(!ok){ $('hintRequired').style.display = "block"; return; }

    if(state.step < 3){ state.step = 3; render(); }
    doEvaluate();
  });

  // Init
  render();
})();
</script>
</body>
</html>
