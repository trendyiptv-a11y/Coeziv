<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Demo GPS Coeziv</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #222;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      padding: 12px 20px;
      background: #111827;
      color: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 1.1rem;
      margin: 0;
    }

    .badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: #374151;
    }

    main {
      display: grid;
      grid-template-columns: 280px 1fr;
      flex: 1;
      overflow: hidden;
    }

    .panel {
      padding: 16px;
      background: #f9fafb;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .panel h2 {
      margin: 0 0 6px;
      font-size: 0.95rem;
      color: #111827;
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 4px;
    }

    select, input[type="range"] {
      width: 100%;
      margin-bottom: 8px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      background: #2563eb;
      color: #fff;
      border-radius: 8px;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      margin-top: 4px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .small {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .metrics {
      font-size: 0.8rem;
      padding: 8px;
      background: #eef2ff;
      border-radius: 8px;
    }

    .metric-line {
      margin-bottom: 4px;
    }

    .map-container {
      position: relative;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    svg {
      background: #f9fafb;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
    }

    .node-circle {
      fill: #111827;
    }

    .node-label {
      font-size: 0.8rem;
      fill: #111827;
    }

    .edge-line {
      stroke: #9ca3af;
      stroke-width: 2;
    }

    .edge-line.route {
      stroke: #2563eb;
      stroke-width: 4;
    }

    .edge-line.alt {
      stroke-dasharray: 4 4;
    }

    .info-bubble {
      font-size: 0.75rem;
      fill: #111827;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="badge">Model Coeziv · Demo rutare</div>
      <h1>GPS Coeziv – timp vs tensiune structurală</h1>
    </div>
  </header>

  <main>
    <aside class="panel">
      <div>
        <h2>Setări rută</h2>
        <label for="srcSelect">Punct de pornire</label>
        <select id="srcSelect"></select>

        <label for="dstSelect">Destinație</label>
        <select id="dstSelect"></select>

        <label for="alphaRange">Prioritate timp (α)</label>
        <input type="range" id="alphaRange" min="0.5" max="2.0" step="0.1" value="1.0">
        <div class="small">α = <span id="alphaValue">1.0</span></div>

        <label for="betaRange">Prioritate stabilitate / tensiune (β)</label>
        <input type="range" id="betaRange" min="0.0" max="4.0" step="0.2" value="2.0">
        <div class="small">β = <span id="betaValue">2.0</span></div>

        <button id="routeBtn" class="btn">Calculează rută coezivă</button>
      </div>

      <div>
        <h2>Metrici rută</h2>
        <div class="metrics" id="metricsBox">
          <div class="metric-line">Noduri: –</div>
          <div class="metric-line">Timp estimat: –</div>
          <div class="metric-line">Tensiune medie: –</div>
          <div class="metric-line">Cost total coeziv: –</div>
        </div>
      </div>

      <div>
        <h2>Explicație</h2>
        <p class="small">
          Acest demo nu caută doar cel mai scurt drum, ci echilibrul între:
        </p>
        <ul class="small">
          <li><b>timp</b> de parcurs (α);</li>
          <li><b>tensiune structurală</b> a segmentelor (β – zone instabile, aglomerate);</li>
        </ul>
        <p class="small">
          Mărește β pentru a evita segmentele „tensionate” chiar dacă timpul crește puțin.
        </p>
      </div>
    </aside>

    <section class="map-container">
      <svg id="mapSvg" width="600" height="400" viewBox="0 0 600 400">
        <!-- conținutul se umple din JS -->
      </svg>
    </section>
  </main>

  <script>
    const srcSelect = document.getElementById("srcSelect");
    const dstSelect = document.getElementById("dstSelect");
    const alphaRange = document.getElementById("alphaRange");
    const betaRange = document.getElementById("betaRange");
    const alphaValue = document.getElementById("alphaValue");
    const betaValue = document.getElementById("betaValue");
    const routeBtn = document.getElementById("routeBtn");
    const metricsBox = document.getElementById("metricsBox");
    const mapSvg = document.getElementById("mapSvg");

    let graph = null;
    let nodesLayout = {};

    // Layout simplu pentru noduri
    function initLayout(nodes) {
      // Poziții fixe pentru demo (un mic "oraș")
      const layout = {
        "A": { x: 80,  y: 320 },
        "B": { x: 200, y: 260 },
        "C": { x: 360, y: 220 },
        "D": { x: 200, y: 120 },
        "E": { x: 360, y: 140 },
        "F": { x: 520, y: 260 }
      };
      nodes.forEach(n => {
        if (!layout[n]) {
          layout[n] = { x: 100 + Math.random() * 400, y: 100 + Math.random() * 200 };
        }
      });
      return layout;
    }

    function clearSvg() {
      while (mapSvg.firstChild) {
        mapSvg.removeChild(mapSvg.firstChild);
      }
    }

    function drawGraph(routeEdges = []) {
      if (!graph) return;
      clearSvg();

      const edgeGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
      const nodeGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
      mapSvg.appendChild(edgeGroup);
      mapSvg.appendChild(nodeGroup);

      // mai întâi desenăm muchiile
      graph.edges.forEach(edge => {
        const from = nodesLayout[edge.from];
        const to = nodesLayout[edge.to];
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", from.x);
        line.setAttribute("y1", from.y);
        line.setAttribute("x2", to.x);
        line.setAttribute("y2", to.y);

        line.classList.add("edge-line");
        if (routeEdges.includes(edge.id)) {
          line.classList.add("route");
        }

        edgeGroup.appendChild(line);
      });

      // apoi nodurile
      graph.nodes.forEach(n => {
        const pos = nodesLayout[n];
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", pos.x);
        circle.setAttribute("cy", pos.y);
        circle.setAttribute("r", 10);
        circle.classList.add("node-circle");
        nodeGroup.appendChild(circle);

        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("x", pos.x);
        label.setAttribute("y", pos.y - 14);
        label.setAttribute("text-anchor", "middle");
        label.classList.add("node-label");
        label.textContent = n;
        nodeGroup.appendChild(label);
      });
    }

    function updateMetrics(result) {
      if (!result) {
        metricsBox.innerHTML = `
          <div class="metric-line">Noduri: –</div>
          <div class="metric-line">Timp estimat: –</div>
          <div class="metric-line">Tensiune medie: –</div>
          <div class="metric-line">Cost total coeziv: –</div>
        `;
        return;
      }

      const nodes = result.nodes.join(" → ");
      const time = result.total_time_min.toFixed(1) + " min";
      const tension = result.avg_tension.toFixed(2);
      const cost = result.total_cost.toFixed(2);

      metricsBox.innerHTML = `
        <div class="metric-line"><b>Noduri:</b> ${nodes}</div>
        <div class="metric-line"><b>Timp estimat:</b> ${time}</div>
        <div class="metric-line"><b>Tensiune medie:</b> ${tension}</div>
        <div class="metric-line"><b>Cost total coeziv:</b> ${cost}</div>
      `;
    }

    async function fetchGraph() {
      const res = await fetch("/api/graph");
      graph = await res.json();
      nodesLayout = initLayout(graph.nodes);

      // populăm select-urile
      srcSelect.innerHTML = "";
      dstSelect.innerHTML = "";
      graph.nodes.forEach(n => {
        const o1 = document.createElement("option");
        o1.value = n;
        o1.textContent = n;
        srcSelect.appendChild(o1);

        const o2 = document.createElement("option");
        o2.value = n;
        o2.textContent = n;
        dstSelect.appendChild(o2);
      });

      srcSelect.value = "A";
      dstSelect.value = "F";

      drawGraph();
    }

    async function calcRoute() {
      const src = srcSelect.value;
      const dst = dstSelect.value;
      const alpha = parseFloat(alphaRange.value);
      const beta = parseFloat(betaRange.value);

      routeBtn.disabled = true;
      routeBtn.textContent = "Se calculează...";

      try {
        const url = `/api/route?src=${encodeURIComponent(src)}&dst=${encodeURIComponent(dst)}&alpha=${alpha}&beta=${beta}`;
        const res = await fetch(url);
        if (!res.ok) {
          updateMetrics(null);
          drawGraph();
          routeBtn.disabled = false;
          routeBtn.textContent = "Calculează rută coezivă";
          return;
        }
        const result = await res.json();
        updateMetrics(result);

        // simplu: folosim doar id-urile directe (fără _rev) ca să colorăm
        const edgeIds = result.edges.map(eid => eid.replace("_rev", ""));
        drawGraph(edgeIds);
      } catch (e) {
        console.error(e);
      } finally {
        routeBtn.disabled = false;
        routeBtn.textContent = "Calculează rută coezivă";
      }
    }

    alphaRange.addEventListener("input", () => {
      alphaValue.textContent = alphaRange.value;
    });
    betaRange.addEventListener("input", () => {
      betaValue.textContent = betaRange.value;
    });

    routeBtn.addEventListener("click", calcRoute);

    // inițializare
    fetchGraph();
  </script>
</body>
</html>
