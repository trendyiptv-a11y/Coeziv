<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>GPS Coeziv – OSM + Leaflet + OSRM</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #111827;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      padding: 10px 18px;
      background: #111827;
      color: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    header h1 {
      font-size: 1rem;
      margin: 0;
    }

    .badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: #374151;
      display: inline-block;
    }

    main {
      display: grid;
      grid-template-columns: 300px 1fr;
      flex: 1;
      overflow: hidden;
    }

    .panel {
      padding: 14px;
      background: #f9fafb;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .panel h2 {
      margin: 0 0 4px;
      font-size: 0.95rem;
      color: #111827;
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 4px;
    }

    select, input[type="range"] {
      width: 100%;
      margin-bottom: 6px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 11px;
      background: #2563eb;
      color: #fff;
      border-radius: 8px;
      font-size: 0.8rem;
      border: none;
      cursor: pointer;
      margin-top: 4px;
    }

    .btn.secondary {
      background: #4b5563;
      margin-left: 4px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .small {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .metrics, .log {
      font-size: 0.8rem;
      padding: 8px;
      background: #eef2ff;
      border-radius: 8px;
      max-height: 140px;
      overflow-y: auto;
    }

    .log {
      background: #f3f4f6;
    }

    .metric-line {
      margin-bottom: 3px;
    }

    .map-container {
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(17,24,39,0.9);
      color: #f9fafb;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
    }

    .legend span {
      display: block;
      margin-bottom: 2px;
    }

    .route-base {
      color: #9ca3af;
    }
    .route-best {
      color: #3b82f6;
    }
    .origin-dot {
      color: #16a34a;
    }
    .dest-dot {
      color: #dc2626;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      .panel {
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="badge">Model Coeziv · OSM · OSRM</div>
      <h1>GPS Coeziv – timp vs tensiune structurală (demo real)</h1>
    </div>
  </header>

  <main>
    <aside class="panel">
      <div>
        <h2>1. Puncte</h2>
        <p class="small">
          <b>Origine:</b> folosește GPS (buton) sau click pe hartă cu <b>Alt+Click</b>.<br/>
          <b>Destinație:</b> click simplu pe hartă.
        </p>
        <button id="useGpsBtn" class="btn">Folosește poziția mea (GPS)</button>
      </div>

      <div>
        <h2>2. Parametri coezivi</h2>
        <label for="alphaRange">Prioritate timp (α)</label>
        <input type="range" id="alphaRange" min="0.5" max="3.0" step="0.1" value="1.0">
        <div class="small">α = <span id="alphaValue">1.0</span> (timp în minute)</div>

        <label for="betaRange">Prioritate stabilitate / simplitate (β)</label>
        <input type="range" id="betaRange" min="0.0" max="5.0" step="0.2" value="2.0">
        <div class="small">β = <span id="betaValue">2.0</span> (manevre / „tensiune structurală”)</div>

        <button id="routeBtn" class="btn">Calculează rută coezivă</button>
      </div>

      <div>
        <h2>3. Metrici rută aleasă</h2>
        <div class="metrics" id="metricsBox">
          <div class="metric-line">Rute candidate: –</div>
          <div class="metric-line">Rută aleasă: –</div>
          <div class="metric-line">Timp: –</div>
          <div class="metric-line">Tensiune (normalizată): –</div>
          <div class="metric-line">Manevre totale: –</div>
          <div class="metric-line">Cost coeziv: –</div>
        </div>
      </div>

      <div>
        <h2>4. Log</h2>
        <div class="log" id="logBox">
          <div>Click pe hartă pentru destinație. Alt+Click pentru origine.</div>
        </div>
      </div>
    </aside>

    <section class="map-container">
      <div id="map"></div>
      <div class="legend">
        <span><span class="origin-dot">●</span> Origine</span>
        <span><span class="dest-dot">●</span> Destinație</span>
        <span><span class="route-base">━</span> Rute alternative</span>
        <span><span class="route-best">━</span> Rută coezivă aleasă</span>
      </div>
    </section>
  </main>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // --------- Elemente UI ----------
    const alphaRange  = document.getElementById("alphaRange");
    const betaRange   = document.getElementById("betaRange");
    const alphaValue  = document.getElementById("alphaValue");
    const betaValue   = document.getElementById("betaValue");
    const routeBtn    = document.getElementById("routeBtn");
    const useGpsBtn   = document.getElementById("useGpsBtn");
    const metricsBox  = document.getElementById("metricsBox");
    const logBox      = document.getElementById("logBox");

    // --------- Harta Leaflet ----------
    const map = L.map("map").setView([45.75, 21.23], 13); // centru generic (ex: Timișoara)

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let originMarker = null;
    let destMarker   = null;
    let originLatLng = null;
    let destLatLng   = null;

    let routeLayers = []; // rutele desenate (toate)
    let bestRouteLayer = null;

    function log(msg) {
      const div = document.createElement("div");
      div.textContent = msg;
      logBox.prepend(div);
    }

    function clearRoutes() {
      routeLayers.forEach(l => map.removeLayer(l));
      routeLayers = [];
      if (bestRouteLayer) {
        map.removeLayer(bestRouteLayer);
        bestRouteLayer = null;
      }
    }

    function updateMetrics(info) {
      if (!info) {
        metricsBox.innerHTML = `
          <div class="metric-line">Rute candidate: –</div>
          <div class="metric-line">Rută aleasă: –</div>
          <div class="metric-line">Timp: –</div>
          <div class="metric-line">Tensiune (normalizată): –</div>
          <div class="metric-line">Manevre totale: –</div>
          <div class="metric-line">Cost coeziv: –</div>
        `;
        return;
      }

      const {
        routeIndex,
        routesCount,
        timeMin,
        tensionNorm,
        maneuvers,
        cost
      } = info;

      metricsBox.innerHTML = `
        <div class="metric-line"><b>Rute candidate:</b> ${routesCount}</div>
        <div class="metric-line"><b>Rută aleasă:</b> #${routeIndex + 1}</div>
        <div class="metric-line"><b>Timp:</b> ${timeMin.toFixed(1)} min</div>
        <div class="metric-line"><b>Tensiune norm.:</b> ${tensionNorm.toFixed(2)}</div>
        <div class="metric-line"><b>Manevre:</b> ${maneuvers}</div>
        <div class="metric-line"><b>Cost coeziv:</b> ${cost.toFixed(2)}</div>
      `;
    }

    // --------- Geolocație ----------
    useGpsBtn.addEventListener("click", () => {
      if (!navigator.geolocation) {
        log("Geolocația nu este suportată de browser.");
        return;
      }

      log("Cerere poziție GPS...");
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          originLatLng = [lat, lon];
          if (originMarker) map.removeLayer(originMarker);
          originMarker = L.marker(originLatLng, { draggable: true })
                          .addTo(map)
                          .bindPopup("Origine (GPS)").openPopup();
          map.setView(originLatLng, 14);
          log(`Origine setată din GPS: ${lat.toFixed(5)}, ${lon.toFixed(5)}`);
        },
        (err) => {
          log("Eroare GPS: " + err.message);
        }
      );
    });

    // --------- Click pe hartă: destinație / alternativ origine ----------
    map.on("click", (e) => {
      // Dacă ținem Alt apăsat -> setăm originea manual
      if (e.originalEvent.altKey) {
        originLatLng = [e.latlng.lat, e.latlng.lng];
        if (originMarker) map.removeLayer(originMarker);
        originMarker = L.marker(originLatLng, { draggable: true })
                        .addTo(map)
                        .bindPopup("Origine (Alt+Click)").openPopup();
        log(`Origine setată manual: ${originLatLng[0].toFixed(5)}, ${originLatLng[1].toFixed(5)}`);
      } else {
        destLatLng = [e.latlng.lat, e.latlng.lng];
        if (destMarker) map.removeLayer(destMarker);
        destMarker = L.marker(destLatLng, { draggable: true, icon: L.icon({
          iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [0, -30]
        })})
        .addTo(map)
        .bindPopup("Destinație").openPopup();

        log(`Destinație setată: ${destLatLng[0].toFixed(5)}, ${destLatLng[1].toFixed(5)}`);
      }
    });

    // --------- Slider UI ----------
    alphaRange.addEventListener("input", () => {
      alphaValue.textContent = alphaRange.value;
    });
    betaRange.addEventListener("input", () => {
      betaValue.textContent = betaRange.value;
    });

    // --------- Rutare coezivă cu OSRM ----------
    async function computeCohesiveRoute() {
      if (!originLatLng || !destLatLng) {
        log("Setează origine și destinație înainte de rutare.");
        updateMetrics(null);
        return;
      }

      const alpha = parseFloat(alphaRange.value);
      const beta  = parseFloat(betaRange.value);

      const src = originLatLng;
      const dst = destLatLng;

      const coordsParam = `${src[1]},${src[0]};${dst[1]},${dst[0]}`;
      const url =
        `https://router.project-osrm.org/route/v1/driving/${coordsParam}` +
        `?overview=full&geometries=geojson&steps=true&alternatives=true`;

      routeBtn.disabled = true;
      routeBtn.textContent = "Calculează...";

      clearRoutes();
      updateMetrics(null);

      try {
        const res = await fetch(url);
        if (!res.ok) {
          log("Eroare OSRM: " + res.status);
          return;
        }
        const data = await res.json();
        if (!data.routes || data.routes.length === 0) {
          log("Nicio rută găsită.");
          return;
        }

        const routes = data.routes;
        log(`Am primit ${routes.length} rute de la OSRM.`);

        // calculăm "tensiune" = număr de manevre (turn-by-turn)
        let maxManeuvers = 0;
        const enriched = routes.map((r, idx) => {
          let maneuvers = 0;
          r.legs.forEach(leg => {
            if (leg.steps) maneuvers += leg.steps.length;
          });
          if (maneuvers > maxManeuvers) maxManeuvers = maneuvers;

          return {
            index: idx,
            route: r,
            durationSec: r.duration,
            maneuvers
          };
        });

        // normalizare tensiune în [0,1]
        enriched.forEach(obj => {
          obj.tensionNorm =
            maxManeuvers > 0 ? obj.maneuvers / maxManeuvers : 0;
        });

        // cost coeziv = α * timp(min) + β * tensiuneNorm
        enriched.forEach(obj => {
          const tMin = obj.durationSec / 60.0;
          obj.timeMin = tMin;
          obj.cost = alpha * tMin + beta * obj.tensionNorm;
        });

        // alegem ruta cu cost minim
        enriched.sort((a, b) => a.cost - b.cost);
        const best = enriched[0];

        log(`Rută coezivă aleasă: #${best.index + 1}, timp ~ ${best.timeMin.toFixed(1)} min, manevre: ${best.maneuvers}, cost: ${best.cost.toFixed(2)}`);

        // desenăm toate rutele (gri), apoi cea mai bună (albastru)
        routes.forEach((r, idx) => {
          const coords = r.geometry.coordinates.map(c => [c[1], c[0]]);
          const polyline = L.polyline(coords, {
            color: "#9CA3AF",
            weight: 3,
            opacity: 0.7
          });
          polyline.addTo(map);
          routeLayers.push(polyline);
        });

        const bestCoords = best.route.geometry.coordinates.map(c => [c[1], c[0]]);
        bestRouteLayer = L.polyline(bestCoords, {
          color: "#2563EB",
          weight: 6,
          opacity: 0.9
        }).addTo(map);

        // ajustăm view-ul
        map.fitBounds(bestRouteLayer.getBounds(), { padding: [30, 30] });

        updateMetrics({
          routeIndex: best.index,
          routesCount: routes.length,
          timeMin: best.timeMin,
          tensionNorm: best.tensionNorm,
          maneuvers: best.maneuvers,
          cost: best.cost
        });

      } catch (e) {
        log("Eroare la rutare: " + e);
      } finally {
        routeBtn.disabled = false;
        routeBtn.textContent = "Calculează rută coezivă";
      }
    }

    routeBtn.addEventListener("click", computeCohesiveRoute);

    // mesaj inițial
    log("Alt+Click pe hartă pentru a seta originea. Click simplu pentru destinație. Apoi apasă „Calculează rută coezivă”.");
  </script>
</body>
</html>
