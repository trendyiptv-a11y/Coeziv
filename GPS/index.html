<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>GPS Coeziv</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      overflow: hidden;
    }
    #map {
      width: 100%;
      height: 100%;
    }

    .top-bar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.96);
      color: #e5e7eb;
      padding: 10px 14px;
      border-radius: 20px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      max-width: 900px;
      width: calc(100vw - 20px);
    }

    .brand {
      font-size: 0.9rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .search-wrap {
      position: relative;
      flex: 1;
      min-width: 140px;
    }

    .search-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 10px 12px;
      font-size: 0.9rem;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }
    .search-input::placeholder {
      color: #6b7280;
    }

    .suggestions {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: #020617;
      border-radius: 14px;
      border: 1px solid #4b5563;
      box-shadow: 0 14px 28px rgba(0,0,0,0.6);
      max-height: 260px;
      overflow-y: auto;
      font-size: 0.8rem;
      z-index: 1100;
    }
    .suggestion-item {
      padding: 8px 10px;
      cursor: pointer;
      line-height: 1.3;
    }
    .suggestion-item:hover {
      background: #1e293b;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      font-size: 0.9rem;
      background: #2563eb;
      color: white;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .info-badge {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.93);
      color: #e5e7eb;
      padding: 7px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 1000;
      max-width: 95vw;
      flex-wrap: wrap;
      justify-content: center;
    }
    .pill {
      border-radius: 999px;
      padding: 3px 8px;
      background: #111827;
    }
    .dot-origin { color:#4ade80; }
    .dot-dest   { color:#f97373; }
    .dot-route  { color:#60a5fa; }

    .toast {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 60px;
      background: rgba(15,23,42,0.98);
      color: #e5e7eb;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 0.8rem;
      max-width: 90vw;
      text-align: center;
      z-index: 1100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    .toast.show { opacity: 1; }

    @media (max-width: 640px) {
      .top-bar {
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
        border-radius: 22px;
      }
      .brand {
        text-align: center;
      }
      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="top-bar">
    <div class="brand">GPS Coeziv</div>
    <div class="search-wrap">
      <input
        id="addressInput"
        class="search-input"
        type="text"
        placeholder="Introdu destinația..."
        autocomplete="off"
      />
      <div id="suggestions" class="suggestions" style="display:none;"></div>
    </div>
    <button id="startBtn" class="btn">Start</button>
  </div>

  <div class="info-badge">
    <span class="pill"><span class="dot-origin">●</span> Origine</span>
    <span class="pill"><span class="dot-dest">●</span> Destinație</span>
    <span class="pill"><span class="dot-route">━</span> Rută</span>
    <span id="infoRoute" class="pill">–</span>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // -------- Parametri coezivi (invizibili în UI) ----------
    const COHESION_ALPHA = 1.0;  // pondere timp (minute)
    const COHESION_BETA  = 2.0;  // pondere complexitate (manevre)

    const defaultCenter = [45.94, 24.97];
    const defaultZoom   = 6;

    const map = L.map("map").setView(defaultCenter, defaultZoom);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    let originLatLng = null;
    let destLatLng   = null;
    let originMarker = null;
    let destMarker   = null;
    let routeLayers  = [];
    let bestRouteLayer = null;

    const addressInput   = document.getElementById("addressInput");
    const suggestionsBox = document.getElementById("suggestions");
    const startBtn       = document.getElementById("startBtn");
    const toastEl        = document.getElementById("toast");
    const infoRouteEl    = document.getElementById("infoRoute");

    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 2500);
    }

    function setOrigin(lat, lon, label) {
      originLatLng = [lat, lon];
      if (originMarker) map.removeLayer(originMarker);
      originMarker = L.marker(originLatLng, { draggable: true })
        .addTo(map)
        .bindPopup(label || "Origine")
        .openPopup();
    }

    function setDest(lat, lon, label) {
      destLatLng = [lat, lon];
      if (destMarker) map.removeLayer(destMarker);
      destMarker = L.marker(destLatLng, { draggable: true })
        .addTo(map)
        .bindPopup(label || "Destinație")
        .openPopup();
    }

    function clearRoutes() {
      routeLayers.forEach(l => map.removeLayer(l));
      routeLayers = [];
      if (bestRouteLayer) {
        map.removeLayer(bestRouteLayer);
        bestRouteLayer = null;
      }
      infoRouteEl.textContent = "–";
    }

    // --------- Auto-GPS la încărcare ----------
    window.addEventListener("load", () => {
      if (!navigator.geolocation) {
        showToast("Geolocația nu e disponibilă. Alt+Click pe hartă pentru origine.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          setOrigin(lat, lon, "Origine (GPS)");
          map.setView([lat, lon], 14);
          showToast("Origine setată din GPS.");
        },
        () => {
          showToast("GPS indisponibil. Folosește Alt+Click pentru origine.");
        }
      );
    });

    // ---------- Click pe hartă ----------
    map.on("click", (e) => {
      if (e.originalEvent.altKey) {
        // Alt+Click => origine
        setOrigin(e.latlng.lat, e.latlng.lng, "Origine (Alt+Click)");
        showToast("Origine actualizată.");
      } else {
        // Click simplu => destinație
        setDest(e.latlng.lat, e.latlng.lng, "Destinație");
        clearSuggestions();
        addressInput.value = "";
        showToast("Destinație setată.");
      }
    });

    // ---------- Autocomplete cu Nominatim ----------
    let autocompleteTimeout = null;

    addressInput.addEventListener("input", () => {
      const q = addressInput.value.trim();
      destLatLng = null; // dacă modifici textul, anulăm destinația curentă
      if (q.length < 3) {
        clearSuggestions();
        return;
      }
      if (autocompleteTimeout) clearTimeout(autocompleteTimeout);
      autocompleteTimeout = setTimeout(() => fetchSuggestions(q), 350);
    });

    function clearSuggestions() {
      suggestionsBox.innerHTML = "";
      suggestionsBox.style.display = "none";
    }

    async function fetchSuggestions(query) {
      try {
        const url =
          "https://nominatim.openstreetmap.org/search?format=json&limit=5&addressdetails=1&q=" +
          encodeURIComponent(query);
        const res = await fetch(url, {
          headers: { "Accept-Language": "ro" }
        });
        const data = await res.json();
        if (!data || data.length === 0) {
          clearSuggestions();
          return;
        }
        suggestionsBox.innerHTML = "";
        data.forEach((item) => {
          const div = document.createElement("div");
          div.className = "suggestion-item";
          div.textContent = item.display_name;
          div.addEventListener("click", () => chooseSuggestion(item));
          suggestionsBox.appendChild(div);
        });
        suggestionsBox.style.display = "block";
      } catch (e) {
        console.error(e);
      }
    }

    function chooseSuggestion(item) {
      const lat = parseFloat(item.lat);
      const lon = parseFloat(item.lon);
      setDest(lat, lon, item.display_name);
      map.setView([lat, lon], 14);
      addressInput.value = item.display_name;
      clearSuggestions();
      showToast("Destinație aleasă.");
    }

    // Închidem lista de sugestii când facem click în afara ei
    document.addEventListener("click", (e) => {
      const clickInside =
        e.target === addressInput || suggestionsBox.contains(e.target);
      if (!clickInside) {
        clearSuggestions();
      }
    });

    // ---------- Rutare coezivă ----------
    async function computeCohesiveRoute() {
      if (!originLatLng) {
        showToast("Setează originea (GPS sau Alt+Click).");
        return;
      }

      if (!destLatLng) {
        if (addressInput.value.trim().length < 3) {
          showToast("Introdu destinația și alege din listă.");
          return;
        }
        // dacă userul a scris dar nu a ales, îl forțăm să aleagă
        showToast("Alege destinația din lista de sugestii.");
        if (suggestionsBox.style.display === "none") {
          // re-cerem sugestii
          fetchSuggestions(addressInput.value.trim());
        }
        return;
      }

      const src = originLatLng;
      const dst = destLatLng;
      const coordsParam = `${src[1]},${src[0]};${dst[1]},${dst[0]}`;
      const url =
        `https://router.project-osrm.org/route/v1/driving/${coordsParam}` +
        `?overview=full&geometries=geojson&steps=true&alternatives=true`;

      startBtn.disabled = true;
      startBtn.textContent = "Calculez...";
      clearRoutes();

      try {
        const res = await fetch(url);
        if (!res.ok) {
          showToast("Eroare la serviciul de rutare.");
          return;
        }
        const data = await res.json();
        if (!data.routes || data.routes.length === 0) {
          showToast("Nicio rută găsită.");
          return;
        }

        const routes = data.routes;

        let maxManeuvers = 0;
        const enriched = routes.map((r, idx) => {
          let maneuvers = 0;
          r.legs.forEach(leg => {
            if (leg.steps) maneuvers += leg.steps.length;
          });
          if (maneuvers > maxManeuvers) maxManeuvers = maneuvers;
          return {
            index: idx,
            route: r,
            durationSec: r.duration,
            distanceM: r.distance,
            maneuvers
          };
        });

        enriched.forEach(obj => {
          obj.tensionNorm = maxManeuvers > 0 ? obj.maneuvers / maxManeuvers : 0;
        });

        enriched.forEach(obj => {
          const tMin = obj.durationSec / 60.0;
          obj.timeMin = tMin;
          obj.cost = COHESION_ALPHA * tMin + COHESION_BETA * obj.tensionNorm;
        });

        enriched.sort((a, b) => a.cost - b.cost);
        const best = enriched[0];

        // desenăm toate rutele (gri)
        routes.forEach(r => {
          const coords = r.geometry.coordinates.map(c => [c[1], c[0]]);
          const polyline = L.polyline(coords, {
            color: "#9CA3AF",
            weight: 3,
            opacity: 0.6
          }).addTo(map);
          routeLayers.push(polyline);
        });

        // ruta optimă (albastru)
        const bestCoords = best.route.geometry.coordinates.map(c => [c[1], c[0]]);
        bestRouteLayer = L.polyline(bestCoords, {
          color: "#2563EB",
          weight: 7,
          opacity: 0.98
        }).addTo(map);

        map.fitBounds(bestRouteLayer.getBounds(), { padding: [40, 40] });

        const km = best.distanceM / 1000.0;
        infoRouteEl.textContent =
          `${km.toFixed(1)} km · ${best.timeMin.toFixed(0)} min · ${best.maneuvers} manevre`;

        showToast(`Rută aleasă (~${best.timeMin.toFixed(0)} min, ${best.maneuvers} manevre).`);
      } catch (e) {
        console.error(e);
        showToast("Eroare la rutare.");
      } finally {
        startBtn.disabled = false;
        startBtn.textContent = "Start";
      }
    }

    startBtn.addEventListener("click", computeCohesiveRoute);
  </script>
</body>
</html>
