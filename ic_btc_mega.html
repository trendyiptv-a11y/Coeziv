<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Mega-ciclu Bitcoin – Model Coeziv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="Interpretare coezivă a mega-ciclului Bitcoin, din 2010 până azi: ciclu, structură și flux în cadrul modelului Coeziv."
  />

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-soft: #02091c;
      --bg-elevated: #050b1f;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.18);
      --accent-strong: #0ea5e9;
      --accent-stronger: #22d3ee;
      --text: #e5e7eb;
      --text-strong: #f9fafb;
      --text-soft: #9ca3af;
      --muted: #6b7280;
      --up: #22c55e;
      --up-soft: rgba(34, 197, 94, 0.16);
      --down: #f97373;
      --down-soft: rgba(248, 113, 113, 0.16);
      --stress: #f97316;
      --stress-soft: rgba(249, 115, 22, 0.18);
      --border: rgba(148, 163, 184, 0.35);
      --border-soft: rgba(148, 163, 184, 0.16);
      --radius-xl: 1.6rem;
      --radius-lg: 1.2rem;
      --radius-pill: 999px;
      --shadow-soft: 0 20px 60px rgba(0, 0, 0, 0.65);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      color: var(--text);
      font-family: var(--font-main);
      -webkit-font-smoothing: antialiased;
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    main.page {
      width: 100%;
      max-width: 1120px;
      padding: 1.6rem 1.1rem 2.6rem;
    }

    @media (min-width: 768px) {
      main.page {
        padding: 1.9rem 1.4rem 3rem;
      }
    }

    a.back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 1rem;
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      text-decoration: none;
      color: var(--text-soft);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    a.back-link span.icon {
      font-size: 0.9rem;
      transform: translateY(-0.5px);
    }

    a.back-link:hover {
      border-color: rgba(96, 165, 250, 0.8);
      color: #e5e7eb;
    }

    header.hero {
      margin-bottom: 1.5rem;
    }

    header.hero h1 {
      margin: 0 0 0.65rem;
      font-size: 1.85rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-strong);
    }

    header.hero p {
      margin: 0;
      font-size: 0.94rem;
      color: var(--text-soft);
      max-width: 50rem;
      line-height: 1.6;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.9rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.3rem 0.8rem;
      border-radius: var(--radius-pill);
      font-size: 0.78rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
    }

    .pill-dot {
      width: 0.42rem;
      height: 0.42rem;
      border-radius: 999px;
      background: var(--accent-stronger);
    }

    .pill.up .pill-dot {
      background: var(--up);
    }

    .pill.down .pill-dot {
      background: var(--down);
    }

    .pill.struct .pill-dot {
      background: var(--accent-strong);
    }

    .pill.flux .pill-dot {
      background: var(--stress);
    }

    .cards-grid {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 1rem;
      margin-bottom: 1.4rem;
    }

    @media (max-width: 900px) {
      .cards-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      position: relative;
      border-radius: var(--radius-xl);
      background: radial-gradient(circle at top left, #020617 0, #020617 35%, #020617 100%);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      padding: 1.15rem 1.3rem 1.2rem;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at 0% -20%, rgba(56, 189, 248, 0.4), transparent 55%);
      opacity: 0.5;
      mix-blend-mode: soft-light;
      pointer-events: none;
    }

    .card-header {
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.8rem;
      margin-bottom: 0.75rem;
      z-index: 1;
    }

    .card-title {
      font-size: 0.83rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
      margin-bottom: 0.25rem;
    }

    .card-sub {
      font-size: 0.8rem;
      color: var(--text-soft);
      line-height: 1.5;
    }

    .card-mega .card-title {
      color: #a5b4fc;
    }

    .card-mega::before {
      background: radial-gradient(circle at 0% -30%, rgba(129, 140, 248, 0.6), transparent 55%);
    }

    .value-row {
      position: relative;
      display: flex;
      align-items: baseline;
      gap: 0.35rem;
      margin-bottom: 0.35rem;
      z-index: 1;
    }

    .value-main {
      font-size: 2.15rem;
      font-weight: 650;
      color: var(--text-strong);
    }

    .value-suffix {
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .meta-row {
      position: relative;
      z-index: 1;
      font-size: 0.8rem;
      color: var(--text-soft);
      line-height: 1.6;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.7rem;
      border-radius: var(--radius-pill);
      font-size: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.92);
      color: var(--text-soft);
      white-space: nowrap;
    }

    .badge .badge-dot {
      width: 0.42rem;
      height: 0.42rem;
      border-radius: 999px;
      background: currentColor;
    }

    .badge.phase {
      border-color: rgba(129, 140, 248, 0.7);
      color: #c4b5fd;
      background: rgba(30, 64, 175, 0.3);
    }

    .badge.up {
      border-color: rgba(34, 197, 94, 0.7);
      color: var(--up);
      background: var(--up-soft);
    }

    .badge.cooling {
      border-color: rgba(56, 189, 248, 0.7);
      color: var(--accent-stronger);
      background: rgba(15, 23, 42, 0.95);
    }

    .badge.stress {
      border-color: rgba(249, 115, 22, 0.8);
      color: var(--stress);
      background: var(--stress-soft);
    }

    .badge.neutral {
      border-color: rgba(148, 163, 184, 0.6);
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.9);
    }

    .section-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
      margin: 1.5rem 0 0.4rem;
    }

    .section-sub {
      font-size: 0.82rem;
      color: var(--text-soft);
      margin: 0 0 0.7rem;
    }

    .chart-card {
      margin-top: 0.4rem;
      border-radius: var(--radius-xl);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.65), #020617);
      border: 1px solid var(--border);
      padding: 1.05rem 1.15rem 1.25rem;
      box-shadow: var(--shadow-soft);
    }

    .chart-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 7;
      border-radius: 1.3rem;
      overflow: hidden;
      background: radial-gradient(circle at top, #020617, #020617 40%, #000 100%);
      border: 1px solid rgba(30, 64, 175, 0.7);
    }

    .chart-wrapper canvas {
      position: absolute;
      inset: 0;
      width: 100% !important;
      height: 100% !important;
    }

    .note {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: var(--text-soft);
      line-height: 1.7;
    }

    .highlight-box {
      margin-top: 1rem;
      border-radius: var(--radius-lg);
      padding: 0.9rem 1rem;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(56, 189, 248, 0.35);
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .highlight-box strong {
      color: var(--text-strong);
    }

    .error-box {
      margin-top: 0.8rem;
      padding: 0.7rem 0.9rem;
      border-radius: var(--radius-lg);
      background: rgba(127, 29, 29, 0.25);
      border: 1px solid rgba(248, 113, 113, 0.7);
      color: #fecaca;
      font-size: 0.8rem;
      display: none;
    }

    @media (max-width: 640px) {
      .card {
        border-radius: 1.2rem;
        padding: 1rem 0.9rem 1.1rem;
      }

      .chart-card {
        padding: 0.9rem 0.85rem 1.1rem;
        border-radius: 1.2rem;
      }

      .chart-wrapper {
        border-radius: 1rem;
      }

      header.hero h1 {
        font-size: 1.45rem;
      }
    }
  </style>
</head>
<body>
  <main class="page">
    <a href="index.html" class="back-link">
      <span class="icon">←</span>
      <span>Înapoi la indicele IC_BTC</span>
    </a>

    <header class="hero">
      <h1>Mega-ciclul Bitcoin – Model Coeziv</h1>
      <p>
        Interpretare structurală a mega-ciclului Bitcoin, din 2010 până azi, prin
        <strong>ICC_BTC (ciclu)</strong>, <strong>IC_BTC (structură)</strong> și
        <strong>ICF_BTC (flux)</strong>. Modelul nu încearcă să „prezică” prețul,
        ci să arate unde ne aflăm în arcada istorică a ciclurilor Bitcoin.
      </p>

      <div class="pill-row">
        <div class="pill">
          <span class="pill-dot"></span>
          <span>ICC_BTC – poziție în mega-ciclu (baze, expansiune, distribuție, reset)</span>
        </div>
        <div class="pill struct">
          <span class="pill-dot"></span>
          <span>IC_BTC – structură: trend vs flux total, volatilitate relativă</span>
        </div>
        <div class="pill flux">
          <span class="pill-dot"></span>
          <span>ICF_BTC – flux & tensiune: stres sistemic vs flux calm</span>
        </div>
      </div>
    </header>

    <!-- CARDURI PRINCIPALE -->
    <section class="cards-grid">
      <!-- Scor compus mega-ciclu -->
      <article class="card card-mega">
        <div class="card-header">
          <div>
            <div class="card-title">Scor mega-ciclu coeziv (0–100)</div>
            <div class="card-sub">
              Combinație între <strong>ciclu</strong>, <strong>structură</strong> și <strong>flux</strong>
              (ferestră internă a modelului).
            </div>
          </div>
          <div class="badge phase" id="megaScoreBadge">
            <span class="badge-dot"></span>
            <span id="megaScoreLabel">se încarcă...</span>
          </div>
          <div class="badge up" id="megaRareBadge" style="display:none;">
            <span class="badge-dot"></span>
            <span>semnal rar</span>
          </div>
        </div>

        <div class="value-row">
          <div class="value-main" id="megaScoreValue">–</div>
          <div class="value-suffix">/100</div>
        </div>

        <div class="meta-row" id="megaScoreText">
          Scorul se calculează după încărcarea datelor.
        </div>
      </article>

      <!-- ICC_BTC – ciclu -->
      <article class="card">
        <div class="card-header">
          <div>
            <div class="card-title">ICC_BTC CICLU (0–100)</div>
            <div class="card-sub">
              Poziționare în mega-ciclu: baze, expansiune, distribuție, reset.
            </div>
          </div>
          <div class="badge phase" id="iccBadge">
            <span class="badge-dot"></span>
            <span id="iccPhaseLabel">fază necunoscută</span>
          </div>
        </div>

        <div class="value-row">
          <div class="value-main" id="iccValue">–</div>
          <div class="value-suffix">/100</div>
        </div>

        <div class="meta-row" id="iccText">
          Se încarcă interpretarea fazei de ciclu…
        </div>
      </article>

      <!-- Card: Formarea bazei noului mega-ciclu (CONDȚIONAT ICC_BTC < 20) -->
      <article class="card" id="baseMegaCycleCard" style="display:none;">
        <div class="card-header">
          <div>
            <div class="card-title">
              Baza noului mega-ciclu (ICC_BTC foarte jos)
            </div>
            <div class="card-sub">
              Card special — vizibil doar când ICC_BTC indică început de bază structurală.
            </div>
          </div>
        </div>

        <div class="meta-row">
          <p style="margin:0 0 0.4rem;">
            Când <strong>ICC_BTC</strong> coboară în zona foarte joasă
            (de obicei sub <strong>20/100</strong>), modelul Coeziv indică faptul că
            ciclul anterior și-a consumat energia și a intrat în faza de
            <strong>resetare structurală profundă</strong>. Aici se formează
            <strong>baza reală</strong> a următorului mega-ciclu.
          </p>

          <p style="margin:0 0 0.4rem;">
            În această perioadă, piața este caracterizată de volatilitate redusă sau
            neregulată, scădere a levierului, fluxuri lente și coerente și presiuni
            de acumulare. Istoric, acestea sunt condițiile în care apar
            <strong>marile acumulări pe termen lung</strong>.
          </p>

          <p style="margin:0;">
            În termeni simpli:
            <strong>
              când ICC_BTC este foarte jos, piața nu este „moartă”, ci își pregătește
              fundația pentru următorul mare bull market.
            </strong>
          </p>
        </div>
      </article>

      <!-- IC_BTC STRUCTURAL -->
      <article class="card">
        <div class="card-header">
          <div>
            <div class="card-title">IC_BTC STRUCTURAL (0–100)</div>
            <div class="card-sub">
              Regim structural: trend vs flux total, volatilitate relativă.
            </div>
          </div>
          <div class="badge cooling" id="structBadge">
            <span class="badge-dot"></span>
            <span id="structLabel">–</span>
          </div>
        </div>

        <div class="value-row">
          <div class="value-main" id="icStructValue">–</div>
          <div class="value-suffix">/100</div>
        </div>

        <div class="meta-row" id="structText">
          Se încarcă interpretarea structurii…
        </div>
      </article>

      <!-- ICF_BTC FLUX -->
      <article class="card">
        <div class="card-header">
          <div>
            <div class="card-title">ICF_BTC FLUX (0–100)</div>
            <div class="card-sub">
              Flux & tensiune: stres sistemic, mișcări violente vs flux calm.
            </div>
          </div>
          <div class="badge stress" id="fluxBadge">
            <span class="badge-dot"></span>
            <span id="fluxLabel">–</span>
          </div>
        </div>

        <div class="value-row">
          <div class="value-main" id="fluxValue">–</div>
          <div class="value-suffix">/100</div>
        </div>

        <div class="meta-row" id="fluxText">
          Se încarcă interpretarea fluxului…
        </div>
      </article>
    </section>

    <!-- SPARKLINE ICC_BTC – ultimi ~10 ani -->
    <section class="chart-card">
      <div class="section-title">Evoluția ICC_BTC în mega-ciclu</div>
      <div class="section-sub">
        Linie simplificată a <strong>ICC_BTC</strong> pe ultimii ~10 ani (scor ciclic 0–100).
        Nu este un grafic de preț, ci un grafic de <strong>poziție în ciclu</strong>.
      </div>

      <div class="chart-wrapper">
        <canvas id="iccSparkline"></canvas>
      </div>

      <p class="note">
        Zonele joase corespund bazelor mari de ciclu, iar zonele foarte ridicate
        corespund extensiilor de tip top / euforie. Modelul Coeziv privește această
        serie ca pe o „hartă internă” a ciclului, nu ca pe un oscillator clasic.
      </p>
    </section>

    <!-- Interpretare text mega-ciclu -->
    <section class="highlight-box" id="megaNarrativeBox">
      Se încarcă interpretarea mega-ciclului…
    </section>

    <div class="error-box" id="errorBox"></div>
  </main>

  <script>
    function clamp(x, min, max) {
      return Math.min(max, Math.max(min, x));
    }

    function safeNumber(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function showError(msg) {
      const box = document.getElementById("errorBox");
      box.textContent = msg;
      box.style.display = "block";
      console.error("[Mega BTC]", msg);
    }

    function classifyMegaScore(v) {
      if (v == null || !Number.isFinite(v)) {
        return {
          label: "necunoscut",
          text: "Nu am putut calcula scorul compus de mega-ciclu."
        };
      }
      if (v < 20) {
        return {
          label: "bază adâncă",
          text: "Scor foarte jos – zona bazelor mari de ciclu, unde istoric s-au format punctele de resetare majoră."
        };
      } else if (v < 45) {
        return {
          label: "fază intermediară",
          text: "Scor mediu spre scăzut – piața nu mai este în top, dar nici într-o bază clară; perioadă de tranziție."
        };
      } else if (v < 70) {
        return {
          label: "expansiune",
          text: "Scor mediu spre ridicat – fază de expansiune a mega-ciclului, cu episoade bull și corecții intermediare."
        };
      } else if (v < 85) {
        return {
          label: "expansiune avansată",
          text: "Scor ridicat – fază avansată a mega-ciclului, în care randamentele marginale scad, iar riscul de top crește."
        };
      }
      return {
        label: "zonă extremă",
        text: "Scor foarte ridicat – regiune asociată istoric cu euforie, extensii finale și episoade de supraîncălzire."
      };
    }

    function classifyStructure(v) {
      if (v == null || !Number.isFinite(v)) {
        return {
          label: "necunoscută",
          text: "Nu am putut evalua structura trendului."
        };
      }
      if (v < 25) {
        return {
          label: "foarte slabă",
          text: "Structură foarte slabă – trendul de fond este în răcire, tipic pentru baze adânci sau tranziții de ciclu."
        };
      } else if (v < 45) {
        return {
          label: "în răcire",
          text: "Structură în răcire – trendul își pierde coeziunea, cu risc de tranziție spre faze bear / redistribuție."
        };
      } else if (v < 65) {
        return {
          label: "medie",
          text: "Structură medie – nici bull clar, nici bear clar; piața poate oscila între sub-cicluri bull și bear."
        };
      } else if (v < 85) {
        return {
          label: "puternică",
          text: "Regim structural puternic – trendul dominant este clar și bine susținut de flux."
        };
      }
      return {
        label: "extremă",
        text: "Structură extrem de puternică – zone unde piața poate deveni supra-încinsă și vulnerabilă la resetări."
      };
    }

    function classifyFlux(v) {
      if (v == null || !Number.isFinite(v)) {
        return {
          label: "necunoscut",
          text: "Nu am putut evalua fluxul și tensiunea pieței."
        };
      }
      if (v < 30) {
        return {
          label: "calm",
          text: "Flux relativ calm – mișcări mai lente, fără stres sistemic evident."
        };
      } else if (v < 55) {
        return {
          label: "normal",
          text: "Flux moderat – alternanță între faze de impuls și corecții, fără tensiune extremă."
        };
      } else if (v < 75) {
        return {
          label: "tensionat",
          text: "Flux tensionat – mișcări mai abrupte, episoade de stres în lichiditate și levier."
        };
      }
      return {
        label: "stres sistemic",
        text: "Flux foarte tensionat – zone unde istoric au apărut capitulări, resetări sau extensii speculative."
      };
    }

    function classifyCycle(v) {
      if (v == null || !Number.isFinite(v)) {
        return {
          label: "necunoscut",
          text: "Nu am putut evalua poziția în mega-ciclu."
        };
      }
      if (v < 20) {
        return {
          label: "bază de mega-ciclu",
          text: "Scor foarte jos – tipic bazelor mari de mega-ciclu, unde se acumulează pozițiile pe termen lung."
        };
      } else if (v < 40) {
        return {
          label: "expansiune timpurie",
          text: "Scor în creștere – fază de ieșire din bază, cu primele impulsuri bull mai coerente."
        };
      } else if (v < 65) {
        return {
          label: "fază intermediară",
          text: "Scor intermediar – piața nu mai este în bază, dar nici în top; combinație de sub-cicluri bull și corecții."
        };
      } else if (v < 80) {
        return {
          label: "distribuție avansată",
          text: "Scor ridicat – structură încă solidă, ciclu avansat; istoric, zonele unde apar redistribuții și topuri locale."
        };
      }
      return {
        label: "zonă extremă",
        text: "Scor foarte ridicat – regiune în care istoric s-au concentrat maximele de ciclu și episoadele de euforie extremă."
      };
    }

    let iccChart = null;

    function buildIccSparkline(points) {
      const ctx = document.getElementById("iccSparkline").getContext("2d");
      if (iccChart) iccChart.destroy();

      const labels = points.map(p => p.label);
      const data = points.map(p => p.v);

      iccChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "ICC_BTC (ciclu 0–100)",
              data,
              borderWidth: 1.8,
              tension: 0.24,
              pointRadius: 0,
              borderColor: "#38bdf8",
              backgroundColor: "rgba(56, 189, 248, 0.15)"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "index",
            intersect: false
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label(ctx) {
                  const v = ctx.parsed.y;
                  return `ICC_BTC: ${v.toFixed(1)}/100`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: "#9ca3af",
                maxTicksLimit: 8,
                font: { size: 10 }
              },
              grid: { color: "rgba(30,64,175,0.35)" }
            },
            y: {
              min: 0,
              max: 100,
              ticks: {
                color: "#9ca3af",
                stepSize: 20,
                font: { size: 10 }
              },
              grid: {
                color: "rgba(30,64,175,0.35)",
                drawBorder: false
              }
            }
          }
        }
      });
    }

    function buildNarrative(megaScore, icc, icStruct, flux) {
      const box = document.getElementById("megaNarrativeBox");
      if (!box) return;

      const megaCls = classifyMegaScore(megaScore);
      const cycleCls = classifyCycle(icc);
      const structCls = classifyStructure(icStruct);
      const fluxCls = classifyFlux(flux);

      const html = `
        <p>
          <strong>Modelul Coeziv</strong> plasează în prezent Bitcoin într-o fază de mega-ciclu
          descrisă ca <strong>${megaCls.label}</strong>, cu un scor compus de
          <strong>${megaScore.toFixed(1)}/100</strong>.
        </p>
        <p>
          <strong>ICC_BTC ciclu:</strong> ${icc.toFixed(2)}/100 – ${cycleCls.text}
        </p>
        <p>
          <strong>IC_BTC structural:</strong> ${icStruct.toFixed(2)}/100 – ${structCls.text}
        </p>
        <p>
          <strong>ICF_BTC flux:</strong> ${flux.toFixed(2)}/100 – ${fluxCls.text}
        </p>
        <p>
          <strong>Scor mega-ciclu:</strong> ${megaCls.text}
        </p>
        <p>
          În termeni simpli, suntem într-o fază în care piața nu mai este într-o bază
          adâncă, dar nici nu mai are structura coerentă a unui bull timpuriu. Următorii
          ani pot însemna o combinație între episoade de redistribuție, perioade de
          consolidare și, mai târziu, resetări mai profunde care pot ancora baza
          următorului mega-ciclu.
        </p>
      `;

      box.innerHTML = html;
    }

    async function main() {
      try {
        const res = await fetch("data/ic_btc_series.json");
        if (!res.ok) {
          throw new Error("Nu am putut încărca data/ic_btc_series.json");
        }
        const data = await res.json();

        const series = Array.isArray(data.series) ? data.series : data;
        if (!Array.isArray(series) || !series.length) {
          throw new Error("Seria ic_btc_series este goală sau invalidă.");
        }

        const last = series[series.length - 1];

        const icc = safeNumber(last.ic_cycle ?? last.icc ?? last.icc_btc);
        const icStruct = safeNumber(last.ic_struct ?? last.ic_btc ?? last.ic);
        const flux = safeNumber(last.ic_flux ?? last.icf_btc ?? last.icf);

        let megaScore = safeNumber(last.mega_score);
        if (!Number.isFinite(megaScore)) {
          const normIcc = icc != null ? clamp(icc, 0, 100) : 50;
          const normStruct = icStruct != null ? clamp(icStruct, 0, 100) : 50;
          const normFlux = flux != null ? clamp(flux, 0, 100) : 50;

          megaScore = 0.45 * normIcc + 0.35 * normStruct + 0.2 * normFlux;
        }

        megaScore = clamp(megaScore, 0, 100);

        const megaCls = classifyMegaScore(megaScore);
        const cycleCls = classifyCycle(icc);
        const structCls = classifyStructure(icStruct);
        const fluxCls = classifyFlux(flux);

        // Populate cards
        if (icc != null) {
          document.getElementById("iccValue").textContent = icc.toFixed(2);
        }
        document.getElementById("iccPhaseLabel").textContent = cycleCls.label;
        document.getElementById("iccText").textContent = cycleCls.text;

        // === Afișare condiționată: Baza noului mega-ciclu ===
        const baseCard = document.getElementById("baseMegaCycleCard");
        if (baseCard) {
          if (icc != null && Number.isFinite(icc) && icc < 20) {
            baseCard.style.display = "block";
          } else {
            baseCard.style.display = "none";
          }
        }

        if (icStruct != null) {
          document.getElementById("icStructValue").textContent = icStruct.toFixed(2);
        }
        document.getElementById("structLabel").textContent = structCls.label;
        document.getElementById("structText").textContent = structCls.text;

        if (flux != null) {
          document.getElementById("fluxValue").textContent = flux.toFixed(2);
        }
        document.getElementById("fluxLabel").textContent = fluxCls.label;
        document.getElementById("fluxText").textContent = fluxCls.text;

        document.getElementById("megaScoreValue").textContent = megaScore.toFixed(1);
        document.getElementById("megaScoreLabel").textContent = megaCls.label;
        document.getElementById("megaScoreText").textContent = megaCls.text;

        // Badge "semnal rar" pentru scorul de mega-ciclu (zone extreme)
        const megaRare = document.getElementById("megaRareBadge");
        if (megaRare) {
          if (Number.isFinite(megaScore) && (megaScore < 20 || megaScore > 80)) {
            megaRare.style.display = "flex";
          } else {
            megaRare.style.display = "none";
          }
        }

        // Sparkline – ultimii ~10 ani
        const mapped = series
          .map(p => {
            const t = p.t ?? p.time ?? p.timestamp ?? p.date;
            const v = safeNumber(p.ic_cycle ?? p.icc ?? p.icc_btc);
            if (!Number.isFinite(v) || t == null) return null;

            let ts = Number(t);
            if (!Number.isFinite(ts)) return null;
            if (String(t).length <= 10) {
              // probabil secunde
              ts = ts * 1000;
            }

            return { ts, v };
          })
          .filter(Boolean)
          .sort((a, b) => a.ts - b.ts);

        if (mapped.length > 20) {
          const lastTs = mapped[mapped.length - 1].ts;
          const tenYearsMs = 10 * 365 * 24 * 60 * 60 * 1000;
          const cutoff = lastTs - tenYearsMs;

          const filtered = mapped.filter(p => p.ts >= cutoff);

          const step = Math.max(1, Math.floor(filtered.length / 400));
          const sampled = filtered.filter((_, idx) => idx % step === 0);

          const points = sampled.map(p => {
            const d = new Date(p.ts);
            const label = d.getUTCFullYear().toString();
            return { label, v: p.v };
          });

          buildIccSparkline(points);
        }

        buildNarrative(megaScore, icc ?? 50, icStruct ?? 50, flux ?? 50);
      } catch (err) {
        console.error(err);
        showError(
          "A apărut o eroare la încărcarea datelor pentru mega-ciclu. " +
          "Verifică existența fișierului data/ic_btc_series.json sau încearcă din nou."
        );
      }
    }

    main();
  </script>
</body>
</html>
