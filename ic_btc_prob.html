<!DOCTYPE html><html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Probabilitate Coezivă BTC</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #020617;
      color: #e5e7eb;
      line-height: 1.5;
      padding: 1rem;
    }
    .card {
      background: #0f172a;
      padding: 1.2rem;
      border-radius: 1rem;
      border: 1px solid rgba(148,163,184,0.2);
      margin-bottom: 1.2rem;
    }
    h2 { margin-top: 0; }
    .label {
      color: #94a3b8;
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
    }
    .value {
      font-size: 2rem;
      font-weight: 600;
    }
    .row {
      display: flex;
      justify-content: space-between;
      margin-top: 0.6rem;
    }
  </style>
</head>
<body><div class="card">
  <h2>Probabilități Coezive BTC</h2>
  <div class="label">Ultima zi: <span id="lastDateLabel">–</span></div>  <div class="row">
    <div>
      <div class="label">Probabilitate UP</div>
      <div class="value" id="probUp">–</div>
    </div>
    <div>
      <div class="label">Probabilitate DOWN</div>
      <div class="value" id="probDown">–</div>
    </div>
  </div>
</div><div class="card">
  <h3>Regim Coeziv BTC</h3>
  <div class="label">Stare:</div>
  <div id="regimeLabel" style="font-size:1.1rem; font-weight:500;">–</div>
</div><div class="card">
  <h3>Context Macro Global</h3>
  <div class="label">Scor risc global:</div>
  <div class="value" id="macroScore">–</div>
  <div id="macroInterpret" style="margin-top:0.4rem; color:#94a3b8; font-size:0.9rem;"></div>
</div><script>
function deriveRegimeLabel(icStruct, icDir) {
  const s = Number.isFinite(icStruct) ? icStruct : null;
  const d = Number.isFinite(icDir) ? icDir : null;

  if (s == null || d == null) return "regim neclar (date incomplete)";

  const isBull = d > 55;
  const isBear = d < 45;

  if (s < 20) {
    if (isBull) return "acumulare bullish";
    if (isBear) return "acumulare bearish";
    return "bază / acumulare neutră";
  }
  if (s < 50) {
    if (isBull) return "bull structural timpuriu";
    if (isBear) return "bear structural timpuriu";
    return "tranziție bull–bear (structură medie)";
  }
  if (s < 70) {
    if (isBull) return "bull structural matur";
    if (isBear) return "corecție într-un bull structural";
    return "tranziție cu structură puternică";
  }

  if (isBull) return "bull târziu / zonă de top";
  if (isBear) return "bear agresiv după top";
  return "top volatil / reechilibrare";
}

function computeMacroScore(macro) {
  const x = Number(macro?.score_risk ?? 0);
  return Number.isFinite(x) ? x : 0;
}

function computeCoezivProb(btcState, macroState) {
  const icStruct = Number(btcState.ic_struct ?? 0);
  const icDir = Number(btcState.ic_dir ?? 50);

  let regime =
    btcState.regime_coeziv_label ||
    btcState.regime_label ||
    btcState.regime ||
    null;

  if (!regime) regime = deriveRegimeLabel(icStruct, icDir);

  const probUp = Math.round(
    0.45 * (icDir / 100) +
    0.35 * (icStruct / 100) +
    0.20 * ((macroState.score_risk ?? 0) + 1) / 2
  ) * 100;

  const up = Math.max(0, Math.min(100, probUp));
  const down = 100 - up;

  return {
    probUp: up,
    probDown: down,
    regime: regime
  };
}

async function main() {
  const [btcState, macroState] = await Promise.all([
    fetch("/btc_state_latest.json").then(r => r.json()),
    fetch("/macro_state_latest.json").then(r => r.json())
  ]);

  let lastDate =
    btcState.date ||
    btcState.last_date ||
    btcState.lastDate ||
    null;

  if (!lastDate && btcState.timestamp) {
    const ts = Number(btcState.timestamp);
    if (Number.isFinite(ts)) {
      const ms = ts > 10_000_000_000 ? ts * 1000 : ts;
      lastDate = new Date(ms).toISOString().slice(0, 10);
    }
  }

  document.getElementById("lastDateLabel").textContent = lastDate || "–";

  const macroScore = computeMacroScore(macroState);
  document.getElementById("macroScore").textContent = macroScore.toFixed(2);

  document.getElementById("macroInterpret").textContent =
    macroScore > 0 ?
      "risk-on (favorabil activelor de risc)" :
      "risk-off (aversiune la risc)";

  const model = computeCoezivProb(btcState, macroState);

  document.getElementById("probUp").textContent = model.probUp + "%";
  document.getElementById("probDown").textContent = model.probDown + "%";
  document.getElementById("regimeLabel").textContent = model.regime;
}

main();
</script></body>
</html>
