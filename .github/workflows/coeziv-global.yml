name: Update Coeziv Global & BTC State

on:
  workflow_run:
    workflows: ["Convert CSV to JSON"]
    types:
      - completed
  workflow_dispatch:

# ✅ Protecție anti-concurență – nu lasă mai multe run-uri simultane pe același branch
concurrency:
  group: update-coeziv-main
  cancel-in-progress: false

jobs:
  update-coeziv:
    runs-on: ubuntu-latest

    steps:
      # 0️⃣ Checkout repo cu tot istoricul (necesar pentru pull --rebase)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1️⃣ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 2️⃣ Instalează dependențele (ajustează dacă nu folosești requirements.txt)
      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas
          fi

      # 3️⃣ Update global state (dacă ai un script global)
      #   Ajustează numele scriptului sau elimină acest pas dacă nu îl folosești.
      - name: Update Global State from daily
        run: |
          if [ -f scripts/update_global_coeziv_state.py ]; then
            python scripts/update_global_coeziv_state.py
          else
            echo "scripts/update_global_coeziv_state.py nu există – sar peste pas."
          fi

      # 3️⃣ bis – Update BTC state (snapshot Coeziv oficial)
      - name: Update BTC State Latest from daily
        run: |
          python scripts/update_btc_state_latest_from_daily.py

      # 3️⃣ ter – Construiește seria IC BTC (istoric IC/ICD/flux)
      - name: Export IC BTC Series
        run: |
          python scripts/export_ic_btc_series.py

      # 3️⃣ quater – Build Mega Cycle Coeziv (BTC)
      # Folosește scriptul build_ic_btc_mega_state.py ca să genereze
      # data/ic_btc_mega_latest.json pe baza ic_btc_series.json
      - name: Build IC BTC Mega State
        run: |
          python scripts/build_ic_btc_mega_state.py

      # 4️⃣ Commit JSON-urile generate (doar dacă există modificări)
      - name: Commit updated JSONs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git status

          git add data/*.json || echo "No data json files to add"

          git commit -m "Update coeziv global & btc state" || echo "No changes"

      # ✅ Sync cu remote (rezolvă non–fast-forward înainte de push)
      - name: Sync with remote branch
        run: |
          git pull --rebase origin main

      # 5️⃣ Push
      - name: Push changes
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
