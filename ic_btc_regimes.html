<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Regimuri bull / bear – model coeziv BTC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js + Luxon (pentru axa de timp) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>

  <style>
    :root {
      --bg: #050816;
      --bg-soft: #0b1020;
      --card: #111827;
      --card-soft: #1f2937;
      --border-subtle: rgba(156, 163, 175, 0.18);
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.15);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --bull: rgba(34, 197, 94, 0.18);
      --bear: rgba(248, 113, 113, 0.18);
      --bull-pill-bg: rgba(34, 197, 94, 0.16);
      --bull-pill-text: #bbf7d0;
      --bear-pill-bg: rgba(248, 113, 113, 0.16);
      --bear-pill-text: #fecaca;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.9);
      --radius-xl: 22px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px 12px 42px;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #020617 55%, #000 100%);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .page {
      max-width: 1160px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.7rem;
      margin: 0 0 6px;
      letter-spacing: 0.01em;
    }

    .subheadline {
      font-size: 0.9rem;
      color: var(--text-muted);
      line-height: 1.5;
      max-width: 720px;
    }

    .badge-row {
      margin-top: 18px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.78rem;
      letter-spacing: 0.02em;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at top left, rgba(79, 70, 229, 0.3), rgba(15, 23, 42, 0.9));
      color: #e5e7eb;
    }

    .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #60a5fa;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.35);
    }

    .note-pill {
      background: rgba(15, 23, 42, 0.85);
      border-color: rgba(55, 65, 81, 0.8);
      color: #e5e7eb;
    }

    .pill-bull {
      background: var(--bull-pill-bg);
      border-color: rgba(34, 197, 94, 0.4);
      color: var(--bull-pill-text);
    }

    .pill-bear {
      background: var(--bear-pill-bg);
      border-color: rgba(248, 113, 113, 0.4);
      color: var(--bear-pill-text);
    }

    .pill-bull::before,
    .pill-bear::before {
      content: "";
      width: 7px;
      height: 7px;
      border-radius: 999px;
    }

    .pill-bull::before {
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.35);
    }

    .pill-bear::before {
      background: #f97373;
      box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.35);
    }

    .pill-bull,
    .pill-bear {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .back-row {
      margin: 24px 0 14px;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 0.82rem;
      cursor: pointer;
      text-decoration: none;
    }

    .back-btn span:first-child {
      font-size: 1rem;
      transform: translateY(-0.5px);
    }

    .back-btn:hover {
      border-color: rgba(248, 250, 252, 0.85);
      background: radial-gradient(circle at top left, rgba(248, 250, 252, 0.06), rgba(15, 23, 42, 0.95));
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
      margin-bottom: 14px;
    }

    @media (max-width: 840px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.25), rgba(15, 23, 42, 0.96));
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      padding: 16px 18px 14px;
      box-shadow: var(--shadow-soft);
    }

    .card-muted {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.85), rgba(2, 6, 23, 0.98));
    }

    .card-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .card-value-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
    }

    .card-value {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .pill-small {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      border: 1px solid transparent;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-small.bull {
      background: var(--bull-pill-bg);
      border-color: rgba(34, 197, 94, 0.4);
      color: var(--bull-pill-text);
    }

    .pill-small.bear {
      background: var(--bear-pill-bg);
      border-color: rgba(248, 113, 113, 0.4);
      color: var(--bear-pill-text);
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
    }

    .pill-dot.bull {
      background: #22c55e;
    }

    .pill-dot.bear {
      background: #f97373;
    }

    .card-help {
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.45;
    }

    .chart-card {
      margin-top: 12px;
      padding: 18px 18px 18px;
    }

    .chart-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .chart-subtitle {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .chart-wrapper {
      position: relative;
      height: 360px;
    }

    @media (min-width: 900px) {
      .chart-wrapper {
        height: 420px;
      }
    }

    canvas {
      border-radius: 18px;
      background: radial-gradient(circle at top, #020617, #020617);
    }

    .table-card {
      margin-top: 16px;
    }

    .table-header {
      font-size: 0.92rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .table-sub {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .table-wrap {
      max-height: 260px;
      overflow: auto;
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.96);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 0.98);
      backdrop-filter: blur(10px);
      z-index: 2;
    }

    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.85);
    }

    th {
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 0.74rem;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.7);
    }

    .regime-type-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.76rem;
    }

    .regime-type-pill.bull {
      background: var(--bull-pill-bg);
      color: var(--bull-pill-text);
    }

    .regime-type-pill.bear {
      background: var(--bear-pill-bg);
      color: var(--bear-pill-text);
    }

    .legend-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }

    .legend-dot.bear {
      background: #f97373;
    }

    .legend-inline {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .footnote {
      margin-top: 10px;
      font-size: 0.78rem;
      color: var(--text-muted);
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Regimuri bull / bear – model coeziv BTC</h1>
    <p class="subheadline">
      Perioadele bull și bear sunt estimate automat din indicii coezivi interni
      (structură vs direcționalitate), calculați pe date zilnice BTCUSDT (~2010–prezent).
      Pe grafic vezi doar <strong>prețul BTC</strong>, cu fundal verde pentru bull market și roșu pentru bear market.
      Nu este recomandare financiară.
    </p>

    <div class="badge-row">
      <div class="badge note-pill">
        <span class="dot"></span>
        <span>Model coeziv – structură &amp; direcționalitate, praguri adaptate la date</span>
      </div>
      <div class="badge pill-bull">
        Bull: structură puternică + mișcări în direcția trendului
      </div>
      <div class="badge pill-bear">
        Bear: structură puternică + mișcări contra trendului
      </div>
    </div>

    <div class="back-row">
      <button class="back-btn" onclick="window.location.href='ic_btc.html';">
        <span>←</span><span>Înapoi la indice IC_BTC</span>
      </button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-label">Număr regimuri bull detectate</div>
        <div class="card-value-row">
          <div class="card-value" id="bullCount">0</div>
          <div class="pill-small bull">
            <span class="pill-dot bull"></span>
            bull
          </div>
        </div>
        <div class="card-help">
          Perioade în care structura este ridicată iar direcționalitatea
          favorizează trendul principal. Durata minimă ≈ 20 zile.
        </div>
      </div>

      <div class="card card-muted">
        <div class="card-label">Număr regimuri bear detectate</div>
        <div class="card-value-row">
          <div class="card-value" id="bearCount">0</div>
          <div class="pill-small bear">
            <span class="pill-dot bear"></span>
            bear
          </div>
        </div>
        <div class="card-help">
          Perioade în care structura rămâne ridicată, dar direcționalitatea
          este inversă față de trendul dominant (presiune descendentă).
        </div>
      </div>

      <div class="card card-muted">
        <div class="card-label">Cel mai lung bull (zile)</div>
        <div class="card-value-row">
          <div class="card-value" id="longestBull">–</div>
        </div>
        <div class="card-help">
          Durata aproximativă a celui mai lung regim bull detectat pe BTCUSDT.
        </div>
      </div>

      <div class="card card-muted">
        <div class="card-label">Cel mai lung bear (zile)</div>
        <div class="card-value-row">
          <div class="card-value" id="longestBear">–</div>
        </div>
        <div class="card-help">
          Durata aproximativă a celui mai lung regim bear detectat.
        </div>
      </div>
    </div>

    <div class="card chart-card">
      <div class="chart-title">Regimuri bull &amp; bear pe preț BTC</div>
      <div class="chart-subtitle">
        Fundal verde = bull market, fundal roșu = bear market.
        Linia albastră reprezintă prețul BTCUSDT (close, timeframe 1D).
      </div>
      <div class="chart-wrapper">
        <canvas id="regimeChart"></canvas>
      </div>
    </div>

    <div class="card table-card">
      <div class="table-header">Perioade bull &amp; bear detectate</div>
      <div class="table-sub">
        <span class="legend-inline">
          <span class="legend-dot"></span><span>bull market</span>
        </span>
        &nbsp;·&nbsp;
        <span class="legend-inline">
          <span class="legend-dot bear"></span><span>bear market</span>
        </span>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Tip</th>
              <th>Început</th>
              <th>Sfârșit</th>
              <th>Durată (zile)</th>
            </tr>
          </thead>
          <tbody id="regimeTableBody">
            <!-- rânduri generate din JS -->
          </tbody>
        </table>
      </div>

      <p class="footnote">
        Pragurile sunt adaptate automat la distribuția indicilor coezivi (nu valori fixe).
        Bull ≈ structură IC_BTC în percentila superioară + direcționalitate ridicată,
        bear ≈ structură la fel de ridicată dar direcționalitate foarte scăzută,
        cu durată minimă ≈ 20 zile. Nu reprezintă recomandare financiară.
      </p>
    </div>
  </div>

  <script>
    const DateTime = luxon.DateTime;
    const MS_PER_DAY = 24 * 60 * 60 * 1000;

    // ---------------- Utilitare math / statistici ----------------

    function ema(values, period) {
      const k = 2 / (period + 1);
      const out = new Array(values.length).fill(null);
      let emaPrev = null;
      for (let i = 0; i < values.length; i++) {
        const v = values[i];
        if (v == null || isNaN(v)) continue;
        if (emaPrev == null) {
          emaPrev = v;
        } else {
          emaPrev = v * k + emaPrev * (1 - k);
        }
        out[i] = emaPrev;
      }
      return out;
    }

    function rollingStd(values, window) {
      const out = new Array(values.length).fill(null);
      let sum = 0;
      let sumSq = 0;
      const q = [];
      for (let i = 0; i < values.length; i++) {
        const v = values[i];
        if (v == null || isNaN(v)) {
          q.push(0);
          sum += 0;
          sumSq += 0;
        } else {
          q.push(v);
          sum += v;
          sumSq += v * v;
        }
        if (q.length > window) {
          const old = q.shift();
          sum -= old;
          sumSq -= old * old;
        }
        if (q.length === window) {
          const mean = sum / window;
          const variance = sumSq / window - mean * mean;
          out[i] = Math.sqrt(Math.max(variance, 0));
        }
      }
      return out;
    }

    function percentile(arr, p) {
      const clean = arr.filter(v => Number.isFinite(v)).sort((a, b) => a - b);
      if (!clean.length) return null;
      const idx = Math.floor((clean.length - 1) * (p / 100));
      return clean[idx];
    }

    function clamp(v, min, max) {
      return Math.min(max, Math.max(min, v));
    }

    // ---------------- Model coeziv: calcul IC structural & direcțional ----------------

    function computeCohesiveIndices(ohlc) {
      const closes = ohlc.map(d => d.close);
      const timestamps = ohlc.map(d => d.timestamp);

      // Volatilitate relativă pe randamente logaritmice (fereastră 20 zile)
      const logReturns = [null];
      for (let i = 1; i < closes.length; i++) {
        const r = Math.log(closes[i] / closes[i - 1]);
        logReturns.push(r);
      }
      const vol20 = rollingStd(logReturns, 20);

      // EMA-uri pentru trend scurt / lung
      const emaShort = ema(closes, 30);
      const emaLong = ema(closes, 90);

      // Normalizăm volatilitatea în [0, 1]
      const maxVol = Math.max(...vol20.filter(v => Number.isFinite(v))) || 1;
      const minVol = Math.min(...vol20.filter(v => Number.isFinite(v))) || 0;

      const icStruct = new Array(closes.length).fill(null);
      const icDir = new Array(closes.length).fill(null);

      for (let i = 0; i < closes.length; i++) {
        const v = vol20[i];
        const es = emaShort[i];
        const el = emaLong[i];

        if (!Number.isFinite(v) || !Number.isFinite(es) || !Number.isFinite(el)) {
          continue;
        }

        // IC_BTC structural: coeziunea trendului vs flux total (volatilitate)
        const volNorm = clamp((v - minVol) / (maxVol - minVol || 1), 0, 1);
        const struct = 100 * (1 - volNorm); // volatilitate mică => structură mare
        icStruct[i] = struct;

        // IC_BTC direcțional: cât de bine se aliniază mișcările cu trendul mare
        const trendDir = es - el;        // diferența EMA scurtă vs EMA lungă
        const dailyMove = closes[i] - closes[i - 1] || 0;
        // produsul dintre direcția trendului și mișcarea zilnică
        const align = trendDir * dailyMove;

        // normalizare aproximativă în [0, 1]
        const alignNorm = 0.5 + 0.5 * Math.tanh(align / (closes[i] * 0.001 || 1));
        const dir = clamp(alignNorm * 100, 0, 100);
        icDir[i] = dir;
      }

      return { timestamps, closes, icStruct, icDir };
    }

    // ---------------- Detectare regimuri bull / bear ----------------

    function detectRegimes(data, thresholds) {
      const { timestamps, icStruct, icDir } = data;
      const segments = [];

      let currentType = null;
      let startIdx = null;

      function closeSegment(endIdx) {
        if (currentType == null || startIdx == null) return;
        const startTs = timestamps[startIdx];
        const endTs = timestamps[endIdx];
        const durationDays = Math.round((endTs - startTs) / MS_PER_DAY) + 1;
        if (durationDays >= thresholds.minDays) {
          segments.push({
            type: currentType,
            start: startTs,
            end: endTs,
            duration: durationDays
          });
        }
      }

      for (let i = 0; i < timestamps.length; i++) {
        const s = icStruct[i];
        const d = icDir[i];
        if (!Number.isFinite(s) || !Number.isFinite(d)) continue;

        const isBull = s >= thresholds.structBull && d >= thresholds.dirBull;
        const isBear = s >= thresholds.structBear && d <= thresholds.dirBear;

        let newType = null;
        if (isBull && !isBear) newType = "bull";
        else if (isBear && !isBull) newType = "bear";

        if (newType !== currentType) {
          if (currentType !== null && startIdx !== null) {
            closeSegment(i - 1);
          }
          currentType = newType;
          startIdx = newType ? i : null;
        }
      }

      if (currentType !== null && startIdx !== null) {
        closeSegment(timestamps.length - 1);
      }

      return segments;
    }

    // ---------------- Plugin Chart.js pentru fundal bull / bear ----------------

    const regimeBackgroundPlugin = {
      id: "regimeBackground",
      beforeDraw(chart, args, opts) {
        const regimes = opts && opts.regimes;
        if (!regimes || !regimes.length) return;

        const { ctx, chartArea, scales } = chart;
        const xAxis = scales.x;
        if (!xAxis) return;

        ctx.save();
        for (const r of regimes) {
          const xStart = xAxis.getPixelForValue(r.start);
          const xEnd = xAxis.getPixelForValue(r.end);
          const width = xEnd - xStart;
          if (!isFinite(width) || width <= 0) continue;

          ctx.fillStyle = r.type === "bull"
            ? "rgba(34,197,94,0.16)"
            : "rgba(248,113,113,0.16)";

          ctx.fillRect(
            xStart,
            chartArea.top,
            width,
            chartArea.bottom - chartArea.top
          );
        }
        ctx.restore();
      }
    };

    Chart.register(regimeBackgroundPlugin);

    // ---------------- Helpers UI ----------------

    function formatDate(ts) {
      return DateTime.fromMillis(ts).toFormat("yyyy-LL-dd");
    }

    function updateStats(regimes) {
      const bull = regimes.filter(r => r.type === "bull");
      const bear = regimes.filter(r => r.type === "bear");

      const bullCountEl = document.getElementById("bullCount");
      const bearCountEl = document.getElementById("bearCount");
      const longestBullEl = document.getElementById("longestBull");
      const longestBearEl = document.getElementById("longestBear");

      bullCountEl.textContent = bull.length;
      bearCountEl.textContent = bear.length;

      const longestBull = bull.reduce((max, r) => Math.max(max, r.duration), 0);
      const longestBear = bear.reduce((max, r) => Math.max(max, r.duration), 0);

      longestBullEl.textContent = longestBull ? longestBull : "–";
      longestBearEl.textContent = longestBear ? longestBear : "–";
    }

    function renderRegimeTable(regimes) {
      const tbody = document.getElementById("regimeTableBody");
      tbody.innerHTML = "";

      if (!regimes.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.style.color = "var(--text-muted)";
        td.textContent = "Nu au fost detectate regimuri bull / bear pentru pragurile curente.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      for (const r of regimes) {
        const tr = document.createElement("tr");

        const tdType = document.createElement("td");
        const pill = document.createElement("span");
        pill.className = "regime-type-pill " + r.type;
        pill.innerHTML = `<span class="pill-dot ${r.type}"></span>${r.type} market`;
        tdType.appendChild(pill);

        const tdStart = document.createElement("td");
        tdStart.textContent = formatDate(r.start);

        const tdEnd = document.createElement("td");
        tdEnd.textContent = formatDate(r.end);

        const tdDur = document.createElement("td");
        tdDur.textContent = r.duration;

        tr.appendChild(tdType);
        tr.appendChild(tdStart);
        tr.appendChild(tdEnd);
        tr.appendChild(tdDur);
        tbody.appendChild(tr);
      }
    }

    function createPriceChart(ctx, data, regimes) {
      const { timestamps, closes } = data;

      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: timestamps,
          datasets: [
            {
              label: "BTCUSDT close",
              data: closes,
              yAxisID: "y",
              tension: 0.18,
              borderWidth: 2,
              pointRadius: 0,
              pointHitRadius: 4,
              borderColor: "rgba(96,165,250,1)",
              backgroundColor: "rgba(59,130,246,0.12)"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              labels: {
                color: "#e5e7eb",
                usePointStyle: true,
                font: { size: 11 }
              }
            },
            tooltip: {
              mode: "index",
              intersect: false,
              callbacks: {
                title(items) {
                  if (!items.length) return "";
                  const ts = items[0].parsed.x;
                  return DateTime.fromMillis(ts).toFormat("yyyy-LL-dd");
                },
                label(ctx) {
                  const v = ctx.parsed.y;
                  if (!Number.isFinite(v)) return "";
                  return " Preț BTC: " + v.toLocaleString("en-US", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                  }) + " USDT";
                }
              }
            },
            regimeBackground: {
              regimes
            }
          },
          scales: {
            x: {
              type: "time",
              time: {
                unit: "year",
                tooltipFormat: "yyyy-LL-dd"
              },
              grid: {
                color: "rgba(55,65,81,0.7)",
                drawBorder: false
              },
              ticks: {
                color: "#9ca3af",
                maxRotation: 0,
                autoSkipPadding: 16
              }
            },
            y: {
              position: "left",
              grid: {
                color: "rgba(31,41,55,0.8)",
                drawBorder: false
              },
              ticks: {
                color: "#9ca3af",
                callback(value) {
                  if (value >= 1000) {
                    return value.toLocaleString("en-US", {
                      maximumFractionDigits: 0
                    });
                  }
                  return value;
                }
              },
              title: {
                display: true,
                text: "Preț BTCUSDT (close, 1D)",
                color: "#e5e7eb",
                font: { size: 11 }
              }
            }
          },
          interaction: {
            mode: "index",
            intersect: false
          }
        }
      });

      return chart;
    }

    // ---------------- Initializare: încărcăm btc_ohlc.json, calculăm IC, praguri & regimuri ----------------

    async function init() {
      try {
        const res = await fetch("btc_ohlc.json", { cache: "no-store" });
        if (!res.ok) {
          throw new Error("Nu pot încărca btc_ohlc.json");
        }
        const json = await res.json();

        // sortăm după timp, doar ca siguranță
        const ohlc = json
          .slice()
          .sort((a, b) => a.timestamp - b.timestamp);

        const modelData = computeCohesiveIndices(ohlc);

        // praguri adaptate automat la distribuția indicilor
        const sVals = modelData.icStruct.filter(v => Number.isFinite(v));
        const dVals = modelData.icDir.filter(v => Number.isFinite(v));

        const structP70 = percentile(sVals, 70);
        const dirP60 = percentile(dVals, 60);
        const dirP40 = percentile(dVals, 40);

        const thresholds = {
          structBull: structP70,
          structBear: structP70,
          dirBull: dirP60,
          dirBear: dirP40,
          minDays: 20
        };

        const regimes = detectRegimes(modelData, thresholds);

        updateStats(regimes);
        renderRegimeTable(regimes);

        const ctx = document.getElementById("regimeChart").getContext("2d");
        createPriceChart(ctx, modelData, regimes);
      } catch (err) {
        console.error(err);
        alert("Nu am putut încărca datele pentru regimuri bull/bear. Verifică fișierul btc_ohlc.json.");
      }
    }

    init();
  </script>
</body>
</html>
