<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Indice Coeziv Bitcoin ‚Äì IC_BTC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="Indice Coeziv Bitcoin ‚Äì structurƒÉ, direc»õionalitate, flux »ôi ciclu pe date istorice BTCUSDT 1D (~14 ani). Model conceptual, nu recomandare financiarƒÉ."
  />

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Chart.js + date adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <style>
    :root {
      --bg-main: #020617;
      --bg-card: rgba(15, 23, 42, 0.88);
      --bg-card-soft: rgba(15, 23, 42, 0.78);
      --border-subtle: rgba(148, 163, 184, 0.3);
      --accent-primary: #38bdf8; /* cyan */
      --accent-secondary: #e879f9; /* fuchsia */
      --accent-green: #4ade80;
      --accent-red: #f97373;
      --accent-amber: #fbbf24;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --radius-lg: 22px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 55px rgba(15, 23, 42, 0.9);
      --glass-blur: 22px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      background: radial-gradient(circle at top, #020617 0, #020617 35%, #000 100%);
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    body {
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 1100px;
      padding: 18px 14px 40px;
    }

    @media (min-width: 768px) {
      .page {
        padding: 28px 18px 52px;
      }
    }

    .pill-label {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 4px 12px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.95), rgba(30, 64, 175, 0.7));
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.8);
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #cbd5f5;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #4ade80, #22c55e 40%, #16a34a 100%);
      box-shadow: 0 0 12px rgba(74, 222, 128, 0.9);
    }

    h1 {
      margin: 10px 0 6px;
      font-size: clamp(1.5rem, 2.4vw + 0.8rem, 2.15rem);
      letter-spacing: 0.02em;
    }

    .subtitle {
      margin-top: 2px;
      font-size: 0.9rem;
      color: var(--text-muted);
      max-width: 640px;
    }

    .grid-main {
      display: flex;
      flex-direction: column;
      gap: 18px;
      margin-top: 18px;
    }

    .card {
      position: relative;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent 40%),
        radial-gradient(circle at top right, rgba(244, 114, 182, 0.1), transparent 45%),
        var(--bg-card);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      box-shadow: var(--shadow-soft);
      padding: 16px 14px 15px;
    }

    .card-soft {
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.08), transparent 42%),
        var(--bg-card-soft);
    }

    @media (min-width: 768px) {
      .card {
        padding: 18px 18px 16px;
      }
    }

    .card-header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px 12px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 1.02rem;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 0.84rem;
      color: var(--text-muted);
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 14px;
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .meta-row span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .meta-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #4b5563;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.45rem;
      padding: 0.7rem 1.3rem;
      border-radius: var(--radius-pill);
      border: none;
      outline: none;
      cursor: pointer;
      background: linear-gradient(135deg, #2563eb, #0ea5e9);
      color: white;
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      box-shadow: 0 15px 30px rgba(37, 99, 235, 0.35);
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, opacity 0.12s;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(37, 99, 235, 0.45);
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.9);
    }

    .btn-primary:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.8);
    }

    .btn-icon {
      font-size: 1rem;
    }

    .status-line {
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .status-line strong {
      color: #e5e7eb;
      font-weight: 500;
    }

    .status-ok {
      color: var(--accent-green);
    }

    .status-error {
      color: var(--accent-red);
    }

    .pill-regime {
      margin-top: 10px;
      padding: 8px 11px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at left, rgba(34, 197, 94, 0.18), transparent 50%),
        rgba(15, 23, 42, 0.96);
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 0.8rem;
    }

    .pill-regime-title {
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      font-size: 0.75rem;
      color: #d1fae5;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-regime-title span.badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #22c55e, #15803d);
      box-shadow: 0 0 10px rgba(52, 211, 153, 0.9);
    }

    .pill-regime-text {
      color: var(--text-muted);
      line-height: 1.4;
    }

    .pill-regime--warning {
      background: radial-gradient(circle at left, rgba(234, 179, 8, 0.18), transparent 52%),
        rgba(15, 23, 42, 0.96);
    }

    .pill-regime--danger {
      background: radial-gradient(circle at left, rgba(248, 113, 113, 0.2), transparent 52%),
        rgba(15, 23, 42, 0.96);
    }

    .pill-regime--warning .pill-regime-title {
      color: #fef3c7;
    }

    .pill-regime--danger .pill-regime-title {
      color: #fee2e2;
    }

    .pill-regime--warning .badge-dot {
      background: radial-gradient(circle at 30% 30%, #facc15, #b45309);
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.9);
    }

    .pill-regime--danger .badge-dot {
      background: radial-gradient(circle at 30% 30%, #f97373, #b91c1c);
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.95);
    }

    .range-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 12px;
    }

    .range-label {
      font-size: 0.78rem;
      color: var(--text-soft);
      margin-right: 4px;
      padding-right: 6px;
      border-right: 1px solid rgba(55, 65, 81, 0.8);
    }

    .btn-range {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
      font-size: 0.78rem;
      padding: 5px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.12s ease-out, color 0.12s ease-out, border-color 0.12s ease-out,
        box-shadow 0.12s ease-out, transform 0.12s ease-out;
    }

    .btn-range:hover {
      border-color: rgba(248, 250, 252, 0.55);
      color: #e5e7eb;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .btn-range.active {
      background: linear-gradient(135deg, #0ea5e9, #6366f1);
      color: white;
      border-color: transparent;
      box-shadow: 0 14px 28px rgba(37, 99, 235, 0.55);
      transform: translateY(-1px);
    }

    .chart-wrapper {
      position: relative;
      width: 100%;
      height: 280px;
      margin-top: 12px;
    }

    @media (min-width: 900px) {
      .chart-wrapper {
        height: 320px;
      }
    }

    canvas {
      border-radius: 16px;
    }

    .metrics-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 14px;
    }

    @media (min-width: 640px) {
      .metrics-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .metric-card {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.96));
      padding: 9px 11px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.84rem;
    }

    .metric-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .metric-name {
      font-weight: 500;
      color: #e5e7eb;
      font-size: 0.82rem;
    }

    .metric-value {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .metric-caption {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 9px;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: lowercase;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .badge--success {
      background: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.45);
      color: #bbf7d0;
    }

    .badge--warning {
      background: rgba(245, 158, 11, 0.1);
      border-color: rgba(245, 158, 11, 0.4);
      color: #fed7aa;
    }

    .badge--danger {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.45);
      color: #fecaca;
    }

    .badge--neutral {
      background: rgba(148, 163, 184, 0.15);
      border-color: rgba(148, 163, 184, 0.4);
      color: #e5e7eb;
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .section-text {
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .section-text p {
      margin: 0 0 8px;
    }

    .section-columns {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 4px;
    }

    @media (min-width: 768px) {
      .section-columns {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .section-list {
      font-size: 0.84rem;
      color: var(--text-muted);
      padding-left: 18px;
      margin: 4px 0 0;
    }

    .section-list li {
      margin-bottom: 4px;
    }

    .small-muted {
      font-size: 0.76rem;
      color: var(--text-soft);
      margin-top: 10px;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .footer-note strong {
      color: #e5e7eb;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <main class="page">
    <!-- Intro -->
    <header>
      <div class="pill-label">
        <span class="pill-dot"></span>
        Gratuit ¬∑ Model coeziv BTC
      </div>
      <h1>Indice Coeziv Bitcoin ‚Äì structurƒÉ, flux & ciclu</h1>
      <p class="subtitle">
        Date zilnice <strong>BTCUSDT</strong>, timeframe <strong>1D</strong>, pe ~14 ani de istoric.
        Indici conceptuali de structurƒÉ, direc»õionalitate, flux »ôi ciclu ‚Äì model orientativ, nu
        reprezintƒÉ recomandare financiarƒÉ.
      </p>
    </header>

    <section class="grid-main">
      <!-- CONTROLS & REGIM GENERAL -->
      <section class="card card-soft">
        <div class="card-header">
          <div>
            <div class="card-title">√éncarcƒÉ date BTC & calculeazƒÉ IC</div>
            <div class="card-subtitle">
              Seria: <strong>BTCUSDT</strong>, timeframe: <strong>1D</strong>, sursƒÉ:
              <code style="font-size: 0.78rem; background: rgba(15,23,42,0.9); padding: 1px 6px; border-radius: 6px;">btc_ohlc.json</code>
            </div>
          </div>
          <button id="btnLoad" class="btn-primary">
            <span class="btn-icon">‚ü≥</span>
            <span>√éncarcƒÉ date BTC &amp; calculeazƒÉ IC</span>
          </button>
        </div>

        <div class="meta-row">
          <span><span class="meta-dot"></span>Istoric extins (~14 ani, din 2010)</span>
          <span><span class="meta-dot"></span>FƒÉrƒÉ chei API, fƒÉrƒÉ conturi</span>
          <span><span class="meta-dot"></span>Calcul local, √Æn browser</span>
        </div>

        <p id="status" class="status-line">
          <strong>Status:</strong> a»ôteaptƒÉ √ÆncƒÉrcarea datelor BTC.
        </p>

        <div id="statusDate" class="status-line" style="margin-top: 4px;">
          Date disponibile p√¢nƒÉ la: <strong id="lastDateText">‚Äì</strong>.
        </div>

        <!-- Regim general -->
        <div id="regimeBox" class="pill-regime" style="display: none;">
          <div class="pill-regime-title">
            <span class="badge-dot"></span>
            <span id="regimeTitle">Regim general</span>
          </div>
          <div id="regimeText" class="pill-regime-text">
            ‚Äì
          </div>
        </div>

        <!-- Range controls -->
        <div class="range-row">
          <span class="range-label">Interval grafic:</span>
          <button class="btn-range active" data-range="all">Tot istoricul</button>
          <button class="btn-range" data-range="5y">Ultimii 5 ani</button>
          <button class="btn-range" data-range="1y">Ultimul an</button>
          <button class="btn-range" data-range="90d">Ultimele 90 zile</button>
        </div>

        <p class="small-muted">
          Indicii sunt normaliza»õi √Æn intervalul 0‚Äì100 »ôi netezi»õi moderat (EMA) pentru o structurƒÉ
          vizualƒÉ mai clarƒÉ, fƒÉrƒÉ a altera trendul de fond.
        </p>
      </section>

      <!-- STRUCTURAL + DIRECTIONAL -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Indice structural &amp; direc»õional (0‚Äì100)</div>
            <div class="card-subtitle">IC_BTC structural vs ICD_BTC direc»õional</div>
          </div>
        </div>

        <div class="chart-wrapper">
          <canvas id="chartStructDir"></canvas>
        </div>

        <div class="metrics-row">
          <article class="metric-card">
            <div class="metric-header">
              <span class="metric-name">IC_BTC structural</span>
              <span id="badgeStruct" class="badge badge--neutral">‚Äì</span>
            </div>
            <div class="metric-value" id="valStruct">‚Äì</div>
            <div class="metric-caption">
              Regim structural (trend vs flux total, volatilitate relativƒÉ).
            </div>
          </article>

          <article class="metric-card">
            <div class="metric-header">
              <span class="metric-name">ICD_BTC direc»õional</span>
              <span id="badgeDir" class="badge badge--neutral">‚Äì</span>
            </div>
            <div class="metric-value" id="valDir">‚Äì</div>
            <div class="metric-caption">
              Coeziunea mi»ôcƒÉrilor zilnice cu direc»õia trendului dominant.
            </div>
          </article>
        </div>
      </section>

      <!-- FLUX + CICLU -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Flux &amp; ciclu (0‚Äì100)</div>
            <div class="card-subtitle">ICF_BTC flux vs ICC_BTC ciclu structural</div>
          </div>
        </div>

        <div class="chart-wrapper">
          <canvas id="chartFluxCycle"></canvas>
        </div>

        <div class="metrics-row">
          <article class="metric-card">
            <div class="metric-header">
              <span class="metric-name">ICF_BTC flux</span>
              <span id="badgeFlux" class="badge badge--neutral">‚Äì</span>
            </div>
            <div class="metric-value" id="valFlux">‚Äì</div>
            <div class="metric-caption">
              Calmul vs stresul fluxului (volatilitate relativƒÉ). Valori ridicate ‚âà flux calm,
              valori foarte mici ‚âà stres sistemic.
            </div>
          </article>

          <article class="metric-card">
            <div class="metric-header">
              <span class="metric-name">ICC_BTC ciclu</span>
              <span id="badgeCycle" class="badge badge--neutral">‚Äì</span>
            </div>
            <div class="metric-value" id="valCycle">‚Äì</div>
            <div class="metric-caption">
              Faza ciclului structural (acumulare / intermediar / avansat) bazatƒÉ pe rela»õia dintre
              trendul scurt »ôi trendul lung.
            </div>
          </article>
        </div>
      </section>

      <!-- INTERPRETARE -->
      <section class="card card-soft">
        <div class="section-title">Interpretare rapidƒÉ (to»õi indicii)</div>
        <div class="section-columns">
          <div class="section-text">
            <p><strong>IC_BTC structural</strong> mƒÉsoarƒÉ coeziunea trendului vs flux total.</p>
            <ul class="section-list">
              <li><strong>&gt; 80</strong> ‚Äì trend consistent, structurƒÉ coezivƒÉ, zgomot relativ mic.</li>
              <li><strong>20 ‚Äì 80</strong> ‚Äì zonƒÉ de tranzi»õie / reorganizare structuralƒÉ.</li>
              <li>
                <strong>&lt; 20</strong> ‚Äì fazƒÉ criticƒÉ: stres sistemic, volatilitate mare, structurƒÉ
                fragilƒÉ.
              </li>
            </ul>
          </div>

          <div class="section-text">
            <p><strong>ICD_BTC direc»õional</strong> mƒÉsoarƒÉ c√¢t de bine se aliniazƒÉ mi»ôcƒÉrile zilnice
              cu direc»õia trendului mare.</p>
            <ul class="section-list">
              <li><strong>&gt; 80</strong> ‚Äì aliniere ridicatƒÉ, trend clar »ôi bine definit.</li>
              <li><strong>20 ‚Äì 80</strong> ‚Äì structurƒÉ mixtƒÉ / consolidare.</li>
              <li><strong>&lt; 20</strong> ‚Äì contra-trend frecvent, structurƒÉ fragilƒÉ.</li>
            </ul>
          </div>

          <div class="section-text">
            <p><strong>ICF_BTC flux</strong> mƒÉsoarƒÉ calitatea fluxului (volatilitate relativƒÉ).</p>
            <ul class="section-list">
              <li><strong>&gt; 70</strong> ‚Äì flux calm, mi»ôcƒÉri relativ controlate.</li>
              <li><strong>30 ‚Äì 70</strong> ‚Äì zonƒÉ normalƒÉ de func»õionare.</li>
              <li><strong>&lt; 30</strong> ‚Äì stres accentuat, episoade de volatilitate mare.</li>
            </ul>
          </div>

          <div class="section-text">
            <p><strong>ICC_BTC ciclu</strong> urmƒÉre»ôte faza ciclului structurii.</p>
            <ul class="section-list">
              <li><strong>&gt; 60</strong> ‚Äì fazƒÉ de expansiune / avansat.</li>
              <li><strong>40 ‚Äì 60</strong> ‚Äì fazƒÉ intermediarƒÉ / neutru.</li>
              <li><strong>&lt; 40</strong> ‚Äì fazƒÉ de contrac»õie / resetare.</li>
            </ul>
          </div>
        </div>

        <p class="footer-note">
          <strong>Disclaimer:</strong> indicii sunt conceptuali »ôi se bazeazƒÉ pe rela»õii structurale
          (trend, flux, volatilitate). Nu reprezintƒÉ sfat sau recomandare de investi»õii.
        </p>
      </section>

      <!-- METADATE -->
      <section class="card">
        <div class="section-title">Detalii tehnice & metadate</div>
        <div class="section-text">
          <p>
            Surse de date: <strong>btc_ohlc.json</strong> (istoric BTCUSDT 1D), calcul IC realizat
            local √Æn browser. Modelul folose»ôte medii mobile (EMA), volatilitate pe ferestre
            mobile »ôi normalizƒÉri √Æn intervalul 0‚Äì100.
          </p>
          <p>
            Exemple de parametri folosi»õi:
          </p>
          <ul class="section-list">
            <li>Trend scurt vs trend lung: EMA 50 vs EMA 200 pe pre»õul de √Ænchidere.</li>
            <li>Volatilitate relativƒÉ: deviere standard pe ~30 zile a randamentelor logaritmice.</li>
            <li>
              Direc»õionalitate: alinierea semnului randamentelor zilnice cu direc»õia trendului
              dominant (ferestrƒÉ ~20 zile).
            </li>
            <li>Netezire suplimentarƒÉ: EMA moderatƒÉ pe seriile de indici.</li>
          </ul>
        </div>
      </section>
    </section>
  </main>

  <script>
    // ----------------- UTILITARE MATH -----------------
    function ema(values, period) {
      const result = new Array(values.length).fill(null);
      if (!values.length || period <= 1) return values.slice();

      const alpha = 2 / (period + 1);
      let prev;

      for (let i = 0; i < values.length; i++) {
        const v = values[i];
        if (v == null || Number.isNaN(v)) {
          result[i] = null;
          continue;
        }
        if (prev == null) {
          prev = v;
        } else {
          prev = alpha * v + (1 - alpha) * prev;
        }
        result[i] = prev;
      }
      return result;
    }

    function rollingStd(values, window) {
      const out = new Array(values.length).fill(null);
      if (window <= 1) return out;

      let sum = 0;
      let sumSq = 0;
      const q = [];

      for (let i = 0; i < values.length; i++) {
        const v = values[i] ?? 0;
        q.push(v);
        sum += v;
        sumSq += v * v;

        if (q.length > window) {
          const old = q.shift();
          sum -= old;
          sumSq -= old * old;
        }

        if (q.length === window) {
          const mean = sum / window;
          const variance = sumSq / window - mean * mean;
          out[i] = Math.sqrt(Math.max(variance, 0));
        } else {
          out[i] = null;
        }
      }

      return out;
    }

    function smoothPoints(points, span) {
      if (!points.length || span <= 1) return points.slice();
      const alpha = 2 / (span + 1);
      let prev = points[0].y;
      return points.map((p, idx) => {
        if (idx === 0) {
          prev = p.y;
        } else {
          prev = prev + alpha * (p.y - prev);
        }
        return { x: p.x, y: prev };
      });
    }

    function clampSeries(points) {
      return points.map(p => ({
        x: p.x,
        y: Math.min(100, Math.max(0, p.y))
      }));
    }

    // ----------------- MODEL COEZIV -----------------
    let fullCandles = [];
    let seriesStruct = [];
    let seriesDir = [];
    let seriesFlux = [];
    let seriesCycle = [];
    let marketRegimes = []; // segmente bull / bear pentru fundal

    let chartStructDir = null;
    let chartFluxCycle = null;

    const btnLoad = document.getElementById("btnLoad");
    const statusEl = document.getElementById("status");
    const statusDateEl = document.getElementById("statusDate");
    const lastDateTextEl = document.getElementById("lastDateText");

    const valStructEl = document.getElementById("valStruct");
    const valDirEl = document.getElementById("valDir");
    const valFluxEl = document.getElementById("valFlux");
    const valCycleEl = document.getElementById("valCycle");

    const badgeStructEl = document.getElementById("badgeStruct");
    const badgeDirEl = document.getElementById("badgeDir");
    const badgeFluxEl = document.getElementById("badgeFlux");
    const badgeCycleEl = document.getElementById("badgeCycle");

    const regimeBoxEl = document.getElementById("regimeBox");
    const regimeTitleEl = document.getElementById("regimeTitle");
    const regimeTextEl = document.getElementById("regimeText");

    const rangeButtons = document.querySelectorAll(".btn-range");

    btnLoad.addEventListener("click", async () => {
      await loadAndCompute();
    });

    rangeButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        if (!seriesStruct.length) return;
        rangeButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        applyRange(btn.dataset.range || "all");
      });
    });

    async function loadAndCompute() {
      btnLoad.disabled = true;
      statusEl.innerHTML =
        '<strong>Status:</strong> √Æncarc datele BTC &amp; calculez indicii...';
      statusEl.classList.remove("status-error", "status-ok");

      try {
        const res = await fetch("btc_ohlc.json", { cache: "no-store" });
        if (!res.ok) {
          throw new Error("Nu pot √ÆncƒÉrca btc_ohlc.json (" + res.status + ").");
        }
        const raw = await res.json();
        if (!Array.isArray(raw)) {
          throw new Error("Format invalid √Æn btc_ohlc.json.");
        }

        fullCandles = raw
          .map((c) => ({
            t: new Date(c.timestamp),
            open: Number(c.open),
            high: Number(c.high),
            low: Number(c.low),
            close: Number(c.close),
            volume: Number(c.volume ?? 0),
          }))
          .filter((c) => !Number.isNaN(c.close) && c.t instanceof Date && !isNaN(c.t))
          .sort((a, b) => a.t - b.t);

        if (!fullCandles.length) {
          throw new Error("Nu am gƒÉsit date valide √Æn btc_ohlc.json.");
        }

        computeIndices(fullCandles);

        // detectƒÉm regimurile bull/bear pe baza IC-ului
        marketRegimes = detectRegimesFromIC(seriesStruct, seriesDir);

        const lastCandle = fullCandles[fullCandles.length - 1];
        const formatter = new Intl.DateTimeFormat("ro-RO", { dateStyle: "medium" });
        lastDateTextEl.textContent = formatter.format(lastCandle.t);
        statusDateEl.innerHTML =
          'Date disponibile p√¢nƒÉ la: <strong>' +
          lastDateTextEl.textContent +
          "</strong>.";

        statusEl.innerHTML =
          "<strong>Status:</strong> gata. Indicii au fost calcula»õi pe √Æntreg istoricul (~" +
          Math.round(fullCandles.length / 365) +
          " ani).";
        statusEl.classList.add("status-ok");
        statusEl.classList.remove("status-error");

        if (!chartStructDir || !chartFluxCycle) {
          initCharts();
        } else {
          updateChartsData();
        }

        const activeRangeBtn =
          document.querySelector(".btn-range.active") || rangeButtons[0];
        applyRange(activeRangeBtn.dataset.range || "all");

        updateMetricsUI();
      } catch (err) {
        console.error(err);
        statusEl.innerHTML =
          "<strong>Status:</strong> eroare la √ÆncƒÉrcare ‚Äì " + err.message;
        statusEl.classList.add("status-error");
        statusEl.classList.remove("status-ok");
      } finally {
        btnLoad.disabled = false;
      }
    }

    // üî• computeIndices cu clamp 0‚Äì100
    function computeIndices(candles) {
      const closes = candles.map((c) => c.close);
      const logRet = closes.map((c, i) =>
        i === 0 || !closes[i - 1] ? 0 : Math.log(c / closes[i - 1])
      );

      const ema50 = ema(closes, 50);
      const ema200 = ema(closes, 200);

      const vol30 = rollingStd(logRet, 30).map((v) =>
        v == null ? null : v * Math.sqrt(365) * 100
      ); // anualizat %

      const len = candles.length;
      const rawStruct = [];
      const rawDir = [];
      const rawFlux = [];
      const rawCycle = [];

      const dirWindow = 20;

      for (let i = 0; i < len; i++) {
        if (i < 200 || i < 30 || i < dirWindow + 200) continue;

        const t = candles[i].t.getTime();
        const short = ema50[i];
        const long = ema200[i];
        const vol = vol30[i];

        if (!short || !long || !vol) continue;

        // --- IC STRUCTURAL: trend vs volatilitate ---
        const trendDiff = short - long;
        const trendStrength = (Math.abs(trendDiff) / Math.max(long, 1e-8)) * 100; // %
        const structRaw = 50 + (trendStrength - vol) * 0.6;

        // --- IC DIREC»öIONAL: aliniere semn randamente cu trend ---
        let trendDir = Math.sign(trendDiff || 0);
        if (trendDir === 0) {
          trendDir = Math.sign(ema50[i] - ema50[i - 5] || 0) || 1;
        }

        let match = 0;
        let total = 0;
        for (let j = i - dirWindow + 1; j <= i; j++) {
          const r = logRet[j];
          if (!r) continue;
          total++;
          if (Math.sign(r) === trendDir) match++;
        }
        const align = total ? match / total : 0.5;
        const dirRaw = align * 100;

        // --- IC FLUX: 100 - vol normalizat ---
        const volLow = 25;
        const volHigh = 130;
        const normVol = Math.max(0, Math.min(1, (vol - volLow) / (volHigh - volLow)));
        const fluxRaw = 100 - normVol * 100;

        // --- IC CICLU: func»õie de raport EMA50 / EMA200 ---
        const ratio = short / Math.max(long, 1e-8);
        const cycleRaw = 50 + 35 * Math.tanh((ratio - 1) * 4);

        rawStruct.push({ x: t, y: structRaw });
        rawDir.push({ x: t, y: dirRaw });
        rawFlux.push({ x: t, y: fluxRaw });
        rawCycle.push({ x: t, y: cycleRaw });
      }

      // clamp 0‚Äì100
      let cStruct = clampSeries(rawStruct);
      let cDir = clampSeries(rawDir);
      let cFlux = clampSeries(rawFlux);
      let cCycle = clampSeries(rawCycle);

      // smooth vizual
      seriesStruct = smoothPoints(cStruct, 16);
      seriesDir = smoothPoints(cDir, 16);
      seriesFlux = smoothPoints(cFlux, 12);
      seriesCycle = smoothPoints(cCycle, 20);
    }

    // ---------- Detectare regimuri bull / bear din IC (model coeziv) ----------
    function detectRegimesFromIC(structSeries, dirSeries) {
      const n = Math.min(structSeries.length, dirSeries.length);
      const segments = [];
      const MIN_LEN = 45; // minim ~45z ca sƒÉ fie regim semnificativ

      function labelFor(s, d) {
        if (s == null || d == null || Number.isNaN(s) || Number.isNaN(d)) {
          return "neutral";
        }
        // structurƒÉ mare + direc»õional bun => bull
        if (s >= 60 && d >= 55) return "bull";
        // structurƒÉ mare + direc»õional slab => bear coerent
        if (s >= 60 && d <= 45) return "bear";
        // structurƒÉ foarte joasƒÉ => tranzi»õie / reset
        if (s < 40) return "transition";
        return "neutral";
      }

      let current = null;

      function closeSegment(endIdx) {
        if (!current) return;
        const length = endIdx - current.startIdx + 1;
        if (length >= MIN_LEN && (current.type === "bull" || current.type === "bear")) {
          const startPoint = structSeries[current.startIdx];
          const endPoint   = structSeries[endIdx];
          segments.push({
            type: current.type,
            startIdx: current.startIdx,
            endIdx,
            startTs: startPoint.x,
            endTs: endPoint.x,
            length
          });
        }
        current = null;
      }

      for (let i = 0; i < n; i++) {
        const s = structSeries[i]?.y;
        const d = dirSeries[i]?.y;
        const label = labelFor(s, d);

        if (!current) {
          if (label === "bull" || label === "bear") {
            current = { type: label, startIdx: i };
          }
        } else {
          if (label === current.type) {
            continue;
          } else {
            closeSegment(i - 1);
            if (label === "bull" || label === "bear") {
              current = { type: label, startIdx: i };
            }
          }
        }
      }

      if (current) closeSegment(n - 1);

      return segments;
    }

    // ---------- Plugin Chart.js: colorare fundal bull / bear ----------
    const regimeBackgroundPlugin = {
      id: "regimeBackground",
      beforeDatasetsDraw(chart, args, opts) {
        if (!marketRegimes.length) return;

        const { ctx, chartArea, scales } = chart;
        const xScale = scales.x;
        if (!xScale || !chartArea) return;

        const xMin = xScale.min;
        const xMax = xScale.max;
        if (xMin == null || xMax == null) return;

        ctx.save();

        marketRegimes.forEach(seg => {
          if (seg.endTs < xMin || seg.startTs > xMax) return;

          const startVal = Math.max(seg.startTs, xMin);
          const endVal   = Math.min(seg.endTs, xMax);

          const xStart = xScale.getPixelForValue(startVal);
          const xEnd   = xScale.getPixelForValue(endVal);
          const width  = xEnd - xStart;
          if (width <= 0) return;

          if (seg.type === "bull") {
            ctx.fillStyle = "rgba(34,197,94,0.08)";
          } else if (seg.type === "bear") {
            ctx.fillStyle = "rgba(248,113,113,0.08)";
          } else {
            return;
          }

          ctx.fillRect(
            xStart,
            chartArea.top,
            width,
            chartArea.bottom - chartArea.top
          );
        });

        ctx.restore();
      }
    };

    Chart.register(regimeBackgroundPlugin);

    // ----------------- CHARTS -----------------
    function initCharts() {
      const ctx1 = document.getElementById("chartStructDir").getContext("2d");
      const ctx2 = document.getElementById("chartFluxCycle").getContext("2d");

      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: {
            top: 0,
            bottom: 10,
          },
        },
        interaction: {
          mode: "index",
          intersect: false,
        },
        plugins: {
          legend: {
            labels: {
              color: "#e5e7eb",
              padding: 16,
              usePointStyle: true,
              boxWidth: 8,
            },
          },
          tooltip: {
            backgroundColor: "rgba(15,23,42,0.96)",
            borderColor: "rgba(148,163,184,0.6)",
            borderWidth: 1,
            titleColor: "#e5e7eb",
            bodyColor: "#cbd5f5",
            padding: 10,
            displayColors: true,
            callbacks: {
              label: function (ctx) {
                const label = ctx.dataset.label || "";
                const v = ctx.parsed.y != null ? ctx.parsed.y.toFixed(2) : "-";
                return label + ": " + v;
              },
            },
          },
          regimeBackground: {} // plugin-ul folose»ôte marketRegimes global
        },
        scales: {
          x: {
            type: "time",
            time: {
              unit: "year",
            },
            grid: {
              color: "rgba(31,41,55,0.7)",
            },
            ticks: {
              color: "#9ca3af",
              maxRotation: 40,
              autoSkip: true,
            },
          },
          y: {
            min: 0,
            max: 100,
            grid: {
              color: "rgba(31,41,55,0.7)",
            },
            ticks: {
              color: "#9ca3af",
              stepSize: 20,
            },
          },
        },
      };

      chartStructDir = new Chart(ctx1, {
        type: "line",
        data: {
          datasets: [
            {
              label: "IC_BTC structural (0‚Äì100)",
              data: seriesStruct,
              borderColor: "rgba(56,189,248,1)",
              backgroundColor: "rgba(56,189,248,0.2)",
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.25,
            },
            {
              label: "ICD_BTC direc»õional (0‚Äì100)",
              data: seriesDir,
              borderColor: "rgba(248,113,113,1)",
              backgroundColor: "rgba(248,113,113,0.18)",
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.25,
            },
          ],
        },
        options: commonOptions,
      });

      chartFluxCycle = new Chart(ctx2, {
        type: "line",
        data: {
          datasets: [
            {
              label: "ICF_BTC flux (0‚Äì100)",
              data: seriesFlux,
              borderColor: "rgba(74,222,128,1)",
              backgroundColor: "rgba(34,197,94,0.18)",
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.23,
            },
            {
              label: "ICC_BTC ciclu (0‚Äì100)",
              data: seriesCycle,
              borderColor: "rgba(196,181,253,1)",
              backgroundColor: "rgba(167,139,250,0.2)",
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.23,
            },
          ],
        },
        options: commonOptions,
      });
    }

    function updateChartsData() {
      if (!chartStructDir || !chartFluxCycle) return;
      chartStructDir.data.datasets[0].data = seriesStruct;
      chartStructDir.data.datasets[1].data = seriesDir;
      chartFluxCycle.data.datasets[0].data = seriesFlux;
      chartFluxCycle.data.datasets[1].data = seriesCycle;
      chartStructDir.update();
      chartFluxCycle.update();
    }

    function applyRange(rangeKey) {
      if (!seriesStruct.length) return;

      const lastX = seriesStruct[seriesStruct.length - 1].x;
      let fromX = seriesStruct[0].x;

      const dayMs = 24 * 60 * 60 * 1000;

      switch (rangeKey) {
        case "90d":
          fromX = lastX - 90 * dayMs;
          break;
        case "1y":
          fromX = lastX - 365 * dayMs;
          break;
        case "5y":
          fromX = lastX - 5 * 365 * dayMs;
          break;
        case "all":
        default:
          fromX = seriesStruct[0].x;
      }

      const filterRange = (points) =>
        points.filter((p) => p.x >= fromX && p.x <= lastX);

      const sStruct = filterRange(seriesStruct);
      const sDir = filterRange(seriesDir);
      const sFlux = filterRange(seriesFlux);
      const sCycle = filterRange(seriesCycle);

      chartStructDir.data.datasets[0].data = sStruct;
      chartStructDir.data.datasets[1].data = sDir;
      chartFluxCycle.data.datasets[0].data = sFlux;
      chartFluxCycle.data.datasets[1].data = sCycle;

      chartStructDir.options.scales.x.min = fromX;
      chartStructDir.options.scales.x.max = lastX;
      chartFluxCycle.options.scales.x.min = fromX;
      chartFluxCycle.options.scales.x.max = lastX;

      chartStructDir.update();
      chartFluxCycle.update();
    }

    // ----------------- UI METRICS + REGIM -----------------
    function classifyScore(kind, value) {
      if (value == null || Number.isNaN(value)) {
        return { label: "‚Äì", cls: "badge--neutral" };
      }

      if (kind === "flux") {
        if (value > 70) return { label: "calm", cls: "badge--success" };
        if (value < 30) return { label: "stres", cls: "badge--danger" };
        return { label: "normal", cls: "badge--warning" };
      }

      if (kind === "cycle") {
        if (value > 60) return { label: "fazƒÉ avansatƒÉ", cls: "badge--success" };
        if (value < 40) return { label: "resetare", cls: "badge--danger" };
        return { label: "fazƒÉ intermediarƒÉ", cls: "badge--warning" };
      }

      // structural & directional
      if (value > 80) return { label: "stabil", cls: "badge--success" };
      if (value < 20) return { label: "critic", cls: "badge--danger" };
      return { label: "tranzi»õie / reorganizare", cls: "badge--warning" };
    }

    function updateMetricsUI() {
      if (!seriesStruct.length) return;

      const lastStruct = seriesStruct[seriesStruct.length - 1].y;
      const lastDir = seriesDir[seriesDir.length - 1].y;
      const lastFlux = seriesFlux[seriesFlux.length - 1].y;
      const lastCycle = seriesCycle[seriesCycle.length - 1].y;

      valStructEl.textContent = lastStruct.toFixed(2);
      valDirEl.textContent = lastDir.toFixed(2);
      valFluxEl.textContent = lastFlux.toFixed(2);
      valCycleEl.textContent = lastCycle.toFixed(2);

      function setBadge(el, kind, value) {
        const clsBase = ["badge--success", "badge--warning", "badge--danger", "badge--neutral"];
        clsBase.forEach((c) => el.classList.remove(c));
        const { label, cls } = classifyScore(kind, value);
        el.textContent = label;
        el.classList.add(cls);
      }

      setBadge(badgeStructEl, "struct", lastStruct);
      setBadge(badgeDirEl, "dir", lastDir);
      setBadge(badgeFluxEl, "flux", lastFlux);
      setBadge(badgeCycleEl, "cycle", lastCycle);

      // Regim general
      let regimeType = "transition";
      if (lastStruct >= 80 && lastDir >= 80 && lastFlux >= 60) {
        regimeType = "stable";
      } else if (lastStruct < 20 || lastDir < 20 || lastFlux < 30) {
        regimeType = "critical";
      }

      regimeBoxEl.style.display = "block";
      regimeBoxEl.classList.remove("pill-regime--warning", "pill-regime--danger");

      if (regimeType === "stable") {
        regimeTitleEl.textContent = "Regim coeziv stabil";
        regimeTextEl.textContent =
          "StructurƒÉ coezivƒÉ, trend relativ consistent, flux controlat »ôi stres moderat. Context de stabilitate structuralƒÉ (nu √ÆnseamnƒÉ direc»õie garantatƒÉ a pre»õului).";
      } else if (regimeType === "critical") {
        regimeBoxEl.classList.add("pill-regime--danger");
        regimeTitleEl.textContent = "FazƒÉ criticƒÉ";
        regimeTextEl.textContent =
          "Stres ridicat √Æn structurƒÉ (IC_BTC sau ICD_BTC foarte scƒÉzut / flux tensionat). Episoade de volatilitate mare »ôi structurƒÉ fragilƒÉ.";
      } else {
        regimeBoxEl.classList.add("pill-regime--warning");
        regimeTitleEl.textContent = "FazƒÉ de tranzi»õie / reorganizare";
        regimeTextEl.textContent =
          "StructurƒÉ mixtƒÉ: trendul »ôi fluxul se reorganizeazƒÉ. De obicei corespunde unor zone de consolidare, schimbare de regim sau realiniere a structurii.";
      }
    }
  </script>
  <a href="ic_btc_regimes.html"
   style="display:inline-flex;align-items:center;gap:6px;
          padding:6px 10px;border-radius:999px;
          border:1px solid rgba(148,163,184,0.4);
          font-size:0.8rem;text-decoration:none;color:#e5e7eb;
          background:rgba(15,23,42,0.9);">
  üîç Regimuri bull / bear
</a>
</body>
</html>
