<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <title>Simulator Premium – Fiziologia Oxigenului cu f_IW (v1.4)</title>

  <style>
    :root {
      --bg: #eef2f7;
      --card: #ffffff;
      --sidebar: #0f172a;
      --sidebar-light: #1e293b;
      --text: #0f172a;
      --accent: #3b82f6;
      --accent-dark: #2563eb;
      --border: #e5e7eb;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #020617;
        --card: #0f172a;
        --sidebar: #020617;
        --sidebar-light: #0b1521;
        --text: #e2e8f0;
        --accent: #60a5fa;
        --accent-dark: #3b82f6;
        --border: #1f2933;
      }
    }

    body {
      margin: 0;
      background: var(--bg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 240px;
      background: var(--sidebar);
      color: #cbd5e1;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      box-shadow: 3px 0 12px rgba(0,0,0,0.25);
      box-sizing: border-box;
    }
    .sidebar h2 {
      font-size: 1.05rem;
      margin: 0 0 1rem;
      color: #93c5fd;
    }
    .side-btn {
      background: var(--sidebar-light);
      border: 1px solid #334155;
      padding: 0.7rem;
      margin-bottom: 0.6rem;
      text-align: left;
      border-radius: 8px;
      color: #e2e8f0;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.92rem;
    }
    .side-btn:hover {
      background: #475569;
    }

    /* MAIN AREA */
    .main-area {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background: var(--bg);
    }

    .topbar {
      height: 58px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 1.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      z-index: 5;
      box-sizing: border-box;
    }
    .topbar-title {
      font-size: 1.05rem;
      font-weight: 600;
    }
    .pdf-btn {
      margin-left: auto;
      background: var(--accent);
      border: none;
      color: white;
      padding: 0.45rem 0.9rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.85rem;
    }
    .pdf-btn:hover {
      background: var(--accent-dark);
    }

    .content-wrap {
      padding: 1.5rem;
      box-sizing: border-box;
    }

    .panel {
      display: none;
      background: var(--card);
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.1);
      animation: fade 0.25s ease-out;
      box-sizing: border-box;
      max-width: 1100px;
      margin: 0 auto 1.5rem;
    }
    .tab-active {
      display: block;
    }

    @keyframes fade {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* PRINT – doar manualul */
    @media print {
      body * { visibility: hidden; }
      #manualTab, #manualTab * { visibility: visible; }
      #manualTab {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        box-shadow: none;
        border-radius: 0;
      }
    }

    /* SIMULATOR STYLES */

    #simulatorTab .sim-header {
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1rem;
    }
    #simulatorTab .sim-header h1 {
      margin: 0 0 0.3rem;
      font-size: 1.25rem;
    }
    #simulatorTab .sim-header p {
      margin: 0;
      font-size: 0.9rem;
      color: #6b7280;
    }
    #simulatorTab .sim-main {
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1.15fr);
      gap: 1.5rem;
    }
    @media (max-width: 980px) {
      #simulatorTab .sim-main {
        grid-template-columns: 1fr;
      }
    }
    #simulatorTab .card {
      background: var(--card);
      border-radius: 14px;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 12px 28px rgba(15,23,42,0.08);
      border: 1px solid var(--border);
    }
    #simulatorTab h2 {
      margin-top: 0;
      font-size: 1.02rem;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.4rem;
      margin-bottom: 0.8rem;
    }
    #simulatorTab .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #4b5563;
      margin-top: 0.7rem;
      margin-bottom: 0.25rem;
    }
    #simulatorTab .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem 1rem;
    }
    #simulatorTab .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.75rem 1rem;
    }
    @media (max-width: 900px) {
      #simulatorTab .grid-2,
      #simulatorTab .grid-3 {
        grid-template-columns: 1fr;
      }
    }
    #simulatorTab .field {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    #simulatorTab label {
      font-size: 0.82rem;
      color: #374151;
    }
    #simulatorTab .units {
      font-size: 0.72rem;
      color: #6b7280;
    }
    #simulatorTab input,
    #simulatorTab select {
      padding: 0.35rem 0.45rem;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.88rem;
      width: 100%;
      box-sizing: border-box;
      background: #f9fafb;
      color: var(--text);
    }
    #simulatorTab input:focus,
    #simulatorTab select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
      background: #ffffff;
    }
    #simulatorTab input[type="range"] {
      padding: 0;
      background: transparent;
    }
    #simulatorTab .btn-row {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    #simulatorTab button {
      padding: 0.45rem 0.85rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }
    #simulatorTab .btn-primary {
      background: var(--accent);
      color: #ffffff;
    }
    #simulatorTab .btn-primary:hover {
      background: var(--accent-dark);
    }
    #simulatorTab .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    #simulatorTab .btn-secondary:hover {
      background: #d1d5db;
    }
    #simulatorTab .result-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.86rem;
      padding: 0.22rem 0;
      border-bottom: 1px dashed #e5e7eb;
    }
    #simulatorTab .result-row:last-child {
      border-bottom: none;
    }
    #simulatorTab .result-label {
      color: #374151;
    }
    #simulatorTab .result-value {
      font-variant-numeric: tabular-nums;
      font-weight: 500;
      margin-left: 0.7rem;
      white-space: nowrap;
    }
    #simulatorTab .section-block {
      margin-top: 0.7rem;
      padding-top: 0.45rem;
      border-top: 1px solid #e5e7eb;
    }
    #simulatorTab .badge {
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 500;
      margin-left: 0.4rem;
    }
    #simulatorTab .badge-ok    { background: #dcfce7; color: #166534; }
    #simulatorTab .badge-warn  { background: #fef9c3; color: #92400e; }
    #simulatorTab .badge-bad   { background: #fee2e2; color: #b91c1c; }
    #simulatorTab .pill {
      display: inline-block;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 0.1rem 0.5rem;
      font-size: 0.7rem;
      color: #374151;
      margin-left: 0.25rem;
    }
    #simulatorTab .note {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.7rem;
    }

    /* MANUAL STYLES */

    #manualTab .manual-header {
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1rem;
    }
    #manualTab .manual-header h1 {
      margin: 0 0 0.3rem;
      font-size: 1.3rem;
    }
    #manualTab .manual-header p {
      margin: 0;
      font-size: 0.9rem;
      color: #6b7280;
    }
    #manualTab .manual-main {
      max-width: 960px;
      margin: 0 auto;
    }
    #manualTab h2 {
      font-size: 1.1rem;
      margin-top: 1.75rem;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.25rem;
    }
    #manualTab h3 {
      font-size: 1rem;
      margin-top: 1.25rem;
      margin-bottom: 0.25rem;
    }
    #manualTab h4 {
      font-size: 0.95rem;
      margin-top: 1rem;
      margin-bottom: 0.15rem;
    }
    #manualTab p {
      margin: 0.35rem 0;
      font-size: 0.92rem;
    }
    #manualTab ul,
    #manualTab ol {
      margin: 0.25rem 0 0.5rem 1.25rem;
      font-size: 0.9rem;
    }
    #manualTab li {
      margin: 0.1rem 0;
    }
    #manualTab .formula {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.88rem;
      background: #f9fafb;
      border-left: 3px solid var(--accent);
      padding: 0.35rem 0.6rem;
      margin: 0.35rem 0;
      overflow-x: auto;
    }
    #manualTab .note {
      font-size: 0.8rem;
      color: #4b5563;
      background: #e5f0ff;
      border-left: 3px solid var(--accent);
      padding: 0.4rem 0.6rem;
      margin: 0.75rem 0;
      border-radius: 4px;
    }
    #manualTab table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0 1rem;
      font-size: 0.9rem;
    }
    #manualTab th,
    #manualTab td {
      border: 1px solid #e5e7eb;
      padding: 0.35rem 0.5rem;
      text-align: left;
    }
    #manualTab th {
      background: #f3f4f6;
      font-weight: 600;
    }
    #manualTab .small {
      font-size: 0.8rem;
      color: #6b7280;
    }
  </style>
</head>

<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>Navigare</h2>
    <button class="side-btn" onclick="showTab('simulatorTab')">▣ Simulator</button>
    <button class="side-btn" onclick="showTab('manualTab')">☰ Manual</button>
  </aside>

  <!-- MAIN -->
  <div class="main-area">
    <div class="topbar">
      <div class="topbar-title">Simulator de Fiziologie a Oxigenului – Premium v1.4 (cu f_IW)</div>
      <button class="pdf-btn" onclick="printManual()">PDF Manual</button>
    </div>

    <div class="content-wrap">

      <!-- SIMULATOR TAB -->
      <div id="simulatorTab" class="panel tab-active">
        <div class="sim-header">
          <h1>Simulator coeziv de transfer al oxigenului</h1>
          <p>v1.4 – efort + oxigenoterapie + șunt + factor apă interfațională f<sub>IW</sub>. Model integrat pentru uz educațional.</p>
        </div>

        <div class="sim-main">
          <!-- INTRĂRI -->
          <section class="card">
            <h2>Parametri de intrare</h2>

            <div class="section-title">1. Mediul și gazometria</div>
            <div class="grid-3">
              <div class="field">
                <label for="fio2">FIO₂</label>
                <input id="fio2" type="number" step="0.01" value="0.21">
                <div class="units">fracție inspirată (0.21 aer, 0.5 O₂ 50%)</div>
              </div>
              <div class="field">
                <label for="pb">PB (presiune barometrică)</label>
                <input id="pb" type="number" step="1" value="760">
                <div class="units">mmHg (≈760 nivelul mării)</div>
              </div>
              <div class="field">
                <label for="paco2">PaCO₂</label>
                <input id="paco2" type="number" step="1" value="40">
                <div class="units">mmHg</div>
              </div>
            </div>

            <div class="grid-3" style="margin-top:0.75rem;">
              <div class="field">
                <label for="pao2">PaO₂ (din gazometrie)</label>
                <input id="pao2" type="number" step="1" value="95">
                <div class="units">mmHg</div>
              </div>
              <div class="field">
                <label for="sao2">SaO₂ măsurată (opțional)</label>
                <input id="sao2" type="number" step="0.1" value="">
                <div class="units">% (dacă e goală, se calculează din PaO₂)</div>
              </div>
              <div class="field">
                <label for="vo2">VO₂ (consum O₂)</label>
                <input id="vo2" type="number" step="10" value="250">
                <div class="units">ml/min (≈3.5 ml/kg/min în repaus)</div>
              </div>
            </div>

            <div class="section-title">2. Hemoglobină, debit cardiac, DL</div>
            <div class="grid-3">
              <div class="field">
                <label for="hb">Hemoglobină [Hb]</label>
                <input id="hb" type="number" step="0.1" value="15">
                <div class="units">g/dL</div>
              </div>
              <div class="field">
                <label for="q">Debit cardiac Q</label>
                <input id="q" type="number" step="0.1" value="5">
                <div class="units">L/min</div>
              </div>
              <div class="field">
                <label for="dl">DL,O₂ (capacitate difuziune clasică)</label>
                <input id="dl" type="number" step="1" value="30">
                <div class="units">ml/min/mmHg (≈30 normal)</div>
              </div>
            </div>

            <div class="section-title">3. Curba Hb–O₂</div>
            <div class="grid-3">
              <div class="field">
                <label for="p50">P₅₀ <span class="pill">avansat</span></label>
                <input id="p50" type="number" step="0.5" value="26.5">
                <div class="units">mmHg (≈26–27 la pH 7.4)</div>
              </div>
              <div class="field">
                <label for="hillN">Exponent Hill n</label>
                <input id="hillN" type="number" step="0.1" value="2.7">
                <div class="units">≈2.7 fiziologic</div>
              </div>
              <div class="field">
                <label for="weight">Greutate pacient (opțional)</label>
                <input id="weight" type="number" step="1" value="">
                <div class="units">kg (pt. estimare VO₂ dacă lipsește)</div>
              </div>
            </div>

            <div class="section-title">3b. Factor apă interfațională (f<sub>IW</sub>)</div>
            <div class="grid-3">
              <div class="field">
                <label for="fiwRange">f<sub>IW</sub> (slider)</label>
                <input id="fiwRange" type="range" min="0.5" max="1.5" step="0.01" value="1.00" oninput="onIWChangeFromRange()">
                <div class="units">0.5 – 1.5 (1.0 = DL doar geometric)</div>
              </div>
              <div class="field">
                <label for="fiw">f<sub>IW</sub> (numeric)</label>
                <input id="fiw" type="number" step="0.01" value="1.00" oninput="onIWChangeFromBox()">
                <div class="units">poți scrie direct (ex. 0.8, 1.2)</div>
              </div>
              <div class="field">
                <label>Notă</label>
                <div class="units">
                  f<sub>IW</sub> modula DL: valori &gt;1 cresc DL efectiv, &lt;1 îl reduc (inflamație, dezorganizare interfață).
                </div>
              </div>
            </div>

            <div class="section-title">4. Nivel de efort (profil generic)</div>
            <div class="grid-3">
              <div class="field">
                <label for="effortLevel">Nivel de efort</label>
                <select id="effortLevel" onchange="applyEffortLevel()">
                  <option value="custom">Manual / necunoscut</option>
                  <option value="rest">Repaus</option>
                  <option value="light">Ușor</option>
                  <option value="moderate">Moderat</option>
                  <option value="intense">Intens</option>
                </select>
                <div class="units">Sugestii pentru Q, VO₂ și DL la plămân sănătos</div>
              </div>
              <div class="field">
                <label>
                  <input type="checkbox" id="lungHealthy" checked>
                  Plămân structural normal (DL geometric crește la efort)
                </label>
                <div class="units">Debifează în fibroză/edem/ARDS (DL nu crește la efort).</div>
              </div>
              <div class="field">
                <label for="effortWeight">Greutate pt. profil efort</label>
                <input id="effortWeight" type="number" step="1" value="70">
                <div class="units">kg</div>
              </div>
            </div>

            <div class="section-title">5. Oxigenoterapie (profil FiO₂)</div>
            <div class="grid-2">
              <div class="field">
                <label for="o2Mode">Mod de administrare O₂</label>
                <select id="o2Mode" onchange="applyOxygenMode()">
                  <option value="air">Aer ambiental (fără O₂)</option>
                  <option value="nc2">Canulă nazală 2 L/min (~24%)</option>
                  <option value="nc4">Canulă nazală 4 L/min (~28%)</option>
                  <option value="venturi28">Venturi 28%</option>
                  <option value="venturi40">Venturi 40%</option>
                  <option value="mask40">Masca simplă 40%</option>
                  <option value="mask60">Masca simplă 60%</option>
                  <option value="nrbreather">Masca cu rezervor (~90%)</option>
                </select>
                <div class="units">Setează automat FIO₂ aproximativă.</div>
              </div>
              <div class="field">
                <label>Notă</label>
                <div class="units">
                  PaO₂ trebuie introdusă din gazometria efectivă sub O₂ pentru a evalua răspunsul real.
                </div>
              </div>
            </div>

            <div class="section-title">6. Șunt (Qs/Qt)</div>
            <div class="grid-2">
              <div class="field">
                <label for="shunt">Șunt ipotetic Qs/Qt</label>
                <input id="shunt" type="number" step="1" value="0">
                <div class="units">% din debit (0–40%). Folosit pentru simulare amestec capilar–venos.</div>
              </div>
              <div class="field">
                <label>Explicație</label>
                <div class="units">
                  Simulatorul estimează și Qs/Qt din date (CcO₂, CaO₂, CvO₂) și îl compară cu valoarea introdusă.
                </div>
              </div>
            </div>

            <div class="btn-row">
              <button class="btn-primary" onclick="computeAll()">Calculează</button>
              <button class="btn-secondary" onclick="loadNormalRest()">Adult sănătos – repaus</button>
              <button class="btn-secondary" onclick="loadNormalExercise()">Adult sănătos – efort</button>
              <button class="btn-secondary" onclick="loadFibrosisRest()">Fibroză moderată – repaus</button>
              <button class="btn-secondary" onclick="loadFibrosisExercise()">Fibroză moderată – efort</button>
            </div>

            <div class="note">
              Simulator educațional pentru raționament fiziopatologic. Nu este dispozitiv medical și nu înlocuiește ghidurile sau decizia clinică.
            </div>
          </section>

          <!-- IEȘIRI -->
          <section class="card">
            <h2>Rezultate & interpretare</h2>

            <div class="section-block">
              <div class="section-title">1. Gaz alveolar și gradient A–a</div>
              <div class="result-row">
                <div class="result-label">PAO₂ (ecuația gazului alveolar)</div>
                <div class="result-value" id="resPAO2">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">PaO₂ (intrare)</div>
                <div class="result-value" id="resPaO2">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">Gradient A–a (PAO₂ − PaO₂)</div>
                <div class="result-value" id="resAagrad">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">SaO₂ utilizată (măsurată/calculată)</div>
                <div class="result-value" id="resSaO2">–</div>
              </div>
            </div>

            <div class="section-block">
              <div class="section-title">2. Conținut arterial, livrare și extracție</div>
              <div class="result-row">
                <div class="result-label">CaO₂ (conținut arterial O₂)</div>
                <div class="result-value" id="resCaO2">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">DO₂ (livrare O₂ = Q × CaO₂)</div>
                <div class="result-value" id="resDO2">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">VO₂ (intrare/estimat)</div>
                <div class="result-value" id="resVO2">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">Raport VO₂ / DO₂ (extracție globală)</div>
                <div class="result-value" id="resVO2DO2">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">Status rezervă de transport</div>
                <div class="result-value" id="resTransportStatus">–</div>
              </div>
            </div>

            <div class="section-block">
              <div class="section-title">3. Componenta venoasă</div>
              <div class="result-row">
                <div class="result-label">CvO₂ (conținut venos de O₂)</div>
                <div class="result-value" id="resCvO2">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">SvO₂ estimat</div>
                <div class="result-value" id="resSvO2">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">PvO₂ estimat (din curba Hb–O₂)</div>
                <div class="result-value" id="resPvO2">–</div>
              </div>
            </div>

            <div class="section-block">
              <div class="section-title">4. Difuziune (DL geometric + factor apă interfațională f<sub>IW</sub>)</div>
              <div class="result-row">
                <div class="result-label">DL clasic (geometric, intrare)</div>
                <div class="result-value" id="resDLclassic">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">f<sub>IW</sub> (factor apă interfațională)</div>
                <div class="result-value" id="resFIW">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">DL efectiv = DL × f<sub>IW</sub></div>
                <div class="result-value" id="resDLeff">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">VO₂ maxim difuzabil (DL efectiv × ΔP)</div>
                <div class="result-value" id="resVO2maxDiff">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">Raport VO₂ / VO₂_max_diff</div>
                <div class="result-value" id="resVO2ratio">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">Status rezervă de difuziune</div>
                <div class="result-value" id="resDiffStatus">–</div>
              </div>
            </div>

            <div class="section-block">
              <div class="section-title">5. Răspuns la oxigenoterapie (heuristic)</div>
              <div class="result-row">
                <div class="result-label">Interpretare răspuns la O₂</div>
                <div class="result-value" id="resO2Response">–</div>
              </div>
            </div>

            <div class="section-block">
              <div class="section-title">6. Analiza șuntului (Qs/Qt)</div>
              <div class="result-row">
                <div class="result-label">CcO₂ (capilar ideal, din PAO₂)</div>
                <div class="result-value" id="resCcO2">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">Qs/Qt estimat din date</div>
                <div class="result-value" id="resShuntEst">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">CaO₂ prezis pt. șunt introdus</div>
                <div class="result-value" id="resCaO2ShuntSel">–</div>
              </div>
              <div class="result-row">
                <div class="result-label">Status șunt</div>
                <div class="result-value" id="resShuntStatus">–</div>
              </div>
            </div>

            <div class="note">
              Heuristică: VO₂/DO₂ ≈ 0.25 în repaus, până spre 0.4 la efort; VO₂/VO₂_max_diff &lt; 0.5 sugerează rezervă bună de difuziune; Qs/Qt &gt; 20% sub FiO₂ crescută indică șunt semnificativ (ex. ARDS, pneumonie, edem sever). f<sub>IW</sub> modula DL geometric: &lt;1 = dezorganizare interfațială, &gt;1 = organizare coezivă eficientă.
            </div>
          </section>
        </div>
      </div>

      <!-- MANUAL TAB -->
      <div id="manualTab" class="panel">
        <div class="manual-header">
          <h1>Manual de utilizare – Simulator integrat de fiziologie a oxigenului (v1.4, cu f<sub>IW</sub>)</h1>
          <p>Document pentru medici, rezidenți și fiziologi clinici.</p>
        </div>

        <div class="manual-main">
          <section>
            <h2>1. Scopul simulatorului</h2>
            <p>
              Simulatorul integrează într-un singur cadru:
            </p>
            <ul>
              <li>ventilația alveolară;</li>
              <li>difuziunea prin membrana alveolo-capilară (DL, componentă geometrică);</li>
              <li>un factor suplimentar de apă interfațională f<sub>IW</sub> care modulează DL funcțional;</li>
              <li>transportul oxigenului prin circulație (Fick circulator);</li>
              <li>relația hemoglobină–oxigen (curba Hill);</li>
              <li>extracția tisulară globală (VO₂/DO₂);</li>
              <li>șuntul (Qs/Qt);</li>
              <li>nivelul de efort (repaus → intens);</li>
              <li>răspunsul la oxigenoterapie.</li>
            </ul>
            <p>Este conceput pentru:</p>
            <ul>
              <li>înțelegerea mecanismelor hipoxemiei (cauză mecanică, nu doar valoare);</li>
              <li>analiza diferențială între difuziune, V/Q mismatch, șunt, anemie și limitare circulatorie;</li>
              <li>explorarea rolului apei interfațiale ca modulator al DL funcțional;</li>
              <li>predare, training și discuții de caz;</li>
              <li>simularea scenariilor de efort, oxigenoterapie, boală pulmonară sau cardiacă.</li>
            </ul>
            <p class="note">
              Simulatorul este un <strong>instrument educațional</strong>. Nu este dispozitiv medical și nu înlocuiește investigațiile
              paraclinice, ghidurile sau decizia clinică.
            </p>
          </section>

          <section>
            <h2>2. Structura modelului</h2>

            <h3>2.1. Ecuația gazului alveolar</h3>
            <div class="formula">
              PAO₂ = FiO₂ × (P<sub>B</sub> − P<sub>H₂O</sub>) − PaCO₂ / R
            </div>
            <p>
              <strong>Unde:</strong> FiO₂ – fracția inspirată de oxigen, P<sub>B</sub> – presiune barometrică, P<sub>H₂O</sub> – presiunea vaporilor de apă
              (≈ 47 mmHg), R – respiratory quotient (≈ 0.8).
            </p>

            <h3>2.2. Conținutul arterial și venos de oxigen</h3>
            <div class="formula">
              CaO₂ = 1.34 × Hb × SaO₂ + 0.0031 × PaO₂
            </div>
            <div class="formula">
              CvO₂ = CaO₂ − VO₂ / (Q × 10)
            </div>
            <div class="formula">
              SvO₂ = CvO₂ / (1.34 × Hb)
            </div>
            <div class="formula">
              PvO₂ = Hill⁻¹(SvO₂; P₅₀, n)
            </div>
            <p>
              Curba Hb–O₂ este modelată prin ecuația Hill, cu parametrii P<sub>50</sub> (≈ 26–27 mmHg) și exponent n (≈ 2.7).
            </p>

            <h3>2.3. Transportul oxigenului (Fick circulator)</h3>
            <div class="formula">
              DO₂ = Q × CaO₂ × 10
            </div>
            <div class="formula">
              VO₂ = Q × (CaO₂ − CvO₂) × 10
            </div>
            <p>
              DO₂ – livrarea globală de oxigen (ml/min), VO₂ – consumul global de oxigen (ml/min), Q – debitul cardiac (L/min).
            </p>

            <h3>2.4. Difuziunea prin membrană (Fick difuzional, extins cu f<sub>IW</sub>)</h3>
            <p>DL clasic (geometric) este dat de:</p>
            <div class="formula">
              DL<sub>clasic</sub> = (A / T) × D
            </div>
            <p>unde A este suprafața, T grosimea barierei, D coeficientul de difuziune al O₂ în apă.</p>
            <p>Modelul extins introduce un factor f<sub>IW</sub> al apei interfațiale:</p>
            <div class="formula">
              DL<sub>efectiv</sub> = DL<sub>clasic</sub> × f<sub>IW</sub>
            </div>
            <p>iar fluxul maxim difuzabil devine:</p>
            <div class="formula">
              VO₂<sup>max dif</sup> = DL<sub>efectiv</sub> × (PAO₂ − PvO₂)
            </div>
            <p>
              f<sub>IW</sub> agregă efectele posibile ale apei interfațiale asupra mobilității (D), distanței efective (T) și căilor preferențiale
              de migrație pentru O₂. f<sub>IW</sub> = 1 corespunde DL pur geometric; valori &lt;1 reduc DL funcțional (dezorganizare interfațială),
              valori &gt;1 îl cresc (organizare coezivă).
            </p>

            <h3>2.5. Șuntul (Qs/Qt)</h3>
            <div class="formula">
              Qs/Qt = (CcO₂ − CaO₂) / (CcO₂ − CvO₂)
            </div>
            <p>
              CcO₂ – conținutul de oxigen capilar ideal (din PAO₂, cu SaO₂ ≈ 100%), CaO₂ – conținut arterial, CvO₂ – conținut venos.
              Qs/Qt exprimă proporția de sânge care „ocoleste” unitățile bine ventilate (șunt adevărat + unități cu V/Q foarte mic).
            </p>
          </section>

          <section>
            <h2>3. Introducerea datelor</h2>
            <p>Medicul introduce sau ajustează:</p>
            <ul>
              <li><strong>FiO₂</strong>:
                <ul>
                  <li>manual sau prin selecție de mod de oxigenoterapie (aer, canulă, Venturi, mască simplă, mască cu rezervor);</li>
                </ul>
              </li>
              <li><strong>PaO₂</strong>, <strong>PaCO₂</strong> (din gazometrie);</li>
              <li><strong>SaO₂</strong> (opțional; dacă lipsesc, sunt calculate din PaO₂ prin curba Hill);</li>
              <li><strong>Hb</strong> (g/dL);</li>
              <li><strong>Q</strong> (debit cardiac, L/min);</li>
              <li><strong>VO₂</strong> (consum de oxigen, ml/min; dacă lipsește și există greutate, se estimează din MET-uri);</li>
              <li><strong>DL</strong> clasic (ml/min/mmHg, capacitate difuzională geometrică pentru O₂);</li>
              <li><strong>f<sub>IW</sub></strong> (factor de modulare interfațională a DL);</li>
              <li><strong>Greutate</strong> (kg, pentru estimarea VO₂ în funcție de efort);</li>
              <li><strong>Parametrii curbei Hill</strong>:
                <ul>
                  <li>P<sub>50</sub>, n (pentru situații cu modificări ale afinității Hb);</li>
                </ul>
              </li>
              <li><strong>Șunt introdus</strong> (0–40%, pentru simularea amestecului capilar–venos în cazuri severe).</li>
            </ul>
            <p>
              Opțiunea „plămân structural normal” stabilește dacă DL geometric crește fiziologic la efort (normal) sau rămâne constant
              (fibroză, ARDS, edem alveolar semnificativ). f<sub>IW</sub> poate varia independent, sugerând modificări rapide ale apei
              interfațiale (inflamație, reorganizare).
            </p>
          </section>

          <section>
            <h2>4. Modul de efort</h2>
            <p>
              Selectorul de efort (<em>Repaus / Ușor / Moderat / Intens</em>) aplică un profil fiziologic pentru:
            </p>
            <ul>
              <li>debit cardiac (Q);</li>
              <li>consum de oxigen (VO₂), în funcție de greutate; </li>
              <li>capacitate difuzională geometrică (DL clasic) – crește doar dacă plămânul este marcat ca „structural normal”;</li>
              <li>PaCO₂ – scade prin hiperventilație proporțională cu efortul.</li>
            </ul>
            <p>
              În bolile interstițiale, bifarea plămânului ca „nesănătos structural” <strong>blochează creșterea DL geometric la efort</strong>, ceea ce reproduce
              desaturarea la efort din fibroză: DO₂ crește, VO₂ crește, dar DL rămâne mic și devine limitant. f<sub>IW</sub> permite explorarea
              ipotezei că apa interfațională poate modula suplimentar DL funcțional (de exemplu, scădere în inflamație acută).
            </p>
          </section>

          <section>
            <h2>5. Rezultate și interpretare</h2>

            <h3>5.1. Gaz alveolar</h3>
            <ul>
              <li><strong>PAO₂</strong> – calculat prin ecuația gazului alveolar;</li>
              <li><strong>PaO₂</strong> – valoarea introdusă (din gazometrie);</li>
              <li><strong>Gradient A–a</strong> = PAO₂ − PaO₂.</li>
            </ul>
            <p>
              A–a normal în repaus la adult tânăr este aproximativ &lt; 10 mmHg; valori &gt; 30 mmHg indică patologie (V/Q mismatch, difuziune,
              șunt).
            </p>

            <h3>5.2. Oxigen arterial</h3>
            <ul>
              <li><strong>SaO₂</strong> – măsurată sau calculată prin curba Hill;</li>
              <li><strong>CaO₂</strong> – conținutul arterial de oxigen (ml/dL), integrând Hb și oxigenul dizolvat.</li>
            </ul>

            <h3>5.3. Transportul global de oxigen</h3>
            <ul>
              <li><strong>DO₂</strong> – livrarea de oxigen (ml/min);</li>
              <li><strong>VO₂</strong> – consumul de oxigen (ml/min);</li>
              <li><strong>VO₂/DO₂</strong> – gradul de extracție globală.</li>
            </ul>
            <p>Praguri utilizate pentru interpretare:</p>
            <ul>
              <li><strong>&lt; 0.25</strong> – rezervă de transport foarte bună (repaus tipic, verde);</li>
              <li><strong>0.25–0.40</strong> – extracție moderată (efort ușor–moderat, galben);</li>
              <li><strong>&gt; 0.40</strong> – extracție mare, rezervă redusă (aproape de DO₂ critic, roșu).</li>
            </ul>

            <h3>5.4. Componenta venoasă</h3>
            <ul>
              <li><strong>CvO₂</strong> – conținutul venos de oxigen (ml/dL);</li>
              <li><strong>SvO₂</strong> – saturația venoasă globală (%);</li>
              <li><strong>PvO₂</strong> – presiunea venoasă de oxigen (mmHg) estimată prin inversa curbei Hill.</li>
            </ul>
            <p>
              Valorile tipice în repaus la un individ sănătos sunt: SvO₂ ~70–75%, PvO₂ ~40 mmHg.
            </p>

            <h3>5.5. Difuziunea (DL + f<sub>IW</sub>)</h3>
            <ul>
              <li><strong>DL clasic</strong> – derivat din anatomie și parametrii geometrici;</li>
              <li><strong>f<sub>IW</sub></strong> – factor de modulare al apei interfațiale;</li>
              <li><strong>DL efectiv</strong> = DL<sub>clasic</sub> × f<sub>IW</sub>;</li>
              <li><strong>VO₂<sup>max dif</sup></strong> – fluxul maxim difuzabil (ml/min);</li>
              <li><strong>VO₂/VO₂<sup>max dif</sup></strong> – proporția din capacitatea difuzională utilizată.</li>
            </ul>
            <p>Interpretare:</p>
            <ul>
              <li><strong>&lt; 0.4</strong> – rezervă difuzională foarte bună (DL efectiv suficient);</li>
              <li><strong>0.4–0.8</strong> – rezervă moderată (posibilă limitare la efort intens);</li>
              <li><strong>&gt; 0.8</strong> – DL efectiv limitant pentru VO₂ curent (risc ridicat).</li>
            </ul>

            <h3>5.6. Șuntul (Qs/Qt)</h3>
            <ul>
              <li><strong>CcO₂</strong> – conținutul de oxigen capilar ideal, calculat din PAO₂;</li>
              <li><strong>Qs/Qt estimat</strong> – din relația standard (CcO₂, CaO₂, CvO₂);</li>
              <li><strong>CaO₂ prezis pentru șunt introdus</strong> – simulare a amestecului capilar–venos pentru procentul introdus.</li>
            </ul>
            <p>Interpretare a Qs/Qt estimat:</p>
            <ul>
              <li><strong>&lt; 10%</strong> – șunt mic, fiziologic sau V/Q ușor neomogen;</li>
              <li><strong>10–20%</strong> – șunt moderat, compatibil cu pneumonie localizată, edem moderat;</li>
              <li><strong>&gt; 20%</strong> – șunt important, sugerând ARDS, pneumonie extinsă, edem alveolar sever.</li>
            </ul>

            <h3>5.7. Răspunsul la oxigenoterapie</h3>
            <p>
              În funcție de FiO₂, gradientul A–a și Qs/Qt estimat, simulatorul indică:
            </p>
            <ul>
              <li><strong>răspuns bun la O₂</strong> – PaO₂ crește adecvat cu FiO₂, Qs/Qt mic;</li>
              <li><strong>răspuns slab la O₂</strong> – FiO₂ mare, PaO₂ persistent mică, A–a mare, Qs/Qt &gt; 20% (șunt dominant);</li>
              <li><strong>intermediar</strong> – combinații între aceste extreme, necesită corelare cu imaginea clinică.</li>
            </ul>
          </section>

          <section>
            <h2>6. Scenarii clinice recomandate</h2>

            <h3>6.1. Fibroză pulmonară – repaus</h3>
            <ul>
              <li>A–a moderat crescut;</li>
              <li>Qs/Qt estimat moderat (≈ 10–20%);</li>
              <li>DL geometric scăzut, dar suficient pentru VO₂ de repaus (VO₂/VO₂<sup>max dif</sup> &lt; 0.5);</li>
              <li>transport (DO₂) normal.</li>
            </ul>
            <p>
              Pacientul este stabil la repaus, deși are rezervă limitată pentru efort.
            </p>

            <h3>6.2. Fibroză pulmonară – efort</h3>
            <ul>
              <li>Q și VO₂ cresc;</li>
              <li>DL geometric rămâne mic (dacă plămânul nu este marcat „structural normal”);</li>
              <li>VO₂/VO₂<sup>max dif</sup> → 1.0;</li>
              <li>SaO₂ scade semnificativ.</li>
            </ul>
            <p>
              DL efectiv devine limitant; simulatorul marchează „DL limitant” și indică risc difuzional ridicat. f<sub>IW</sub> poate explora
              ipoteza unei reduceri suplimentare a DL prin dezorganizarea apei interfațiale în inflamație.
            </p>

            <h3>6.3. BPOC</h3>
            <ul>
              <li>DL relativ conservat sau moderat redus;</li>
              <li>A–a mare, Qs/Qt moderat prin V/Q neomogen;</li>
              <li>răspuns bun la FiO₂ crescută.</li>
            </ul>
            <p>
              Modelul evidențiază predominant V/Q mismatch, nu difuziune.
            </p>

            <h3>6.4. Anemie severă</h3>
            <ul>
              <li>PaO₂ și SaO₂ pot fi normale;</li>
              <li>CaO₂ redus prin Hb scăzută;</li>
              <li>DO₂ scade;</li>
              <li>VO₂/DO₂ crește spre valori critice;</li>
              <li>SvO₂ scade, PvO₂ scade.</li>
            </ul>
            <p>
              Limitarea este de transport (Hb/DO₂), nu pulmonară.
            </p>

            <h3>6.5. Edem alveolar / ARDS</h3>
            <ul>
              <li>Qs/Qt estimat &gt; 20–30%;</li>
              <li>A–a foarte mare;</li>
              <li>răspuns slab la oxigen chiar la FiO₂ ridicate;</li>
              <li>DL scăzut și șunt important.</li>
            </ul>
            <p>
              Simularea reproduce tabloul tipic de „hipoxemie refractară la O₂”.
            </p>
          </section>

          <section>
            <h2>7. Utilizare în context clinic</h2>
            <p>Simulatorul poate fi utilizat pentru:</p>
            <ul>
              <li>predare în fiziologie, pneumologie, ATI, cardiologie;</li>
              <li>training pentru rezidenți (interpretarea gazometriei și a mecanismelor de hipoxie);</li>
              <li>raționament diferențial între:
                <ul>
                  <li>difuziune limitată (DL geometric mic și/sau f<sub>IW</sub> &lt; 1);</li>
                  <li>V/Q mismatch;</li>
                  <li>șunt;</li>
                  <li>anemie / Hb scăzută;</li>
                  <li>debit cardiac scăzut (limitare circulatorie);</li>
                </ul>
              </li>
              <li>simularea efectelor efortului și oxigenoterapiei;</li>
              <li>discuții interdisciplinare (ATI – cardio – pneumo).</li>
            </ul>
            <p class="note">
              Simulatorul este un instrument de <strong>înțelegere mecanistică</strong>, nu un calculator de decizii. Rezultatele trebuie
              întotdeauna integrate cu tabloul clinic, imagistic, hemodinamic și laborator.
            </p>
          </section>

          <section>
            <h2>8. Limitări</h2>
            <ul>
              <li>Nu măsoară direct niciun parametru; depinde de datele introduse.</li>
              <li>DL este tratat ca parametru scalar global, nu ca distribuție regională.</li>
              <li>V/Q mismatch complex este redus la efectul său pe A–a și Qs/Qt.</li>
              <li>Modelul nu incorporează explicit hipertensiunea pulmonară sau patologiile vasculare segmentare.</li>
              <li>Q trebuie estimat sau cunoscut (ex. din ecografie, termodiluație, presupuneri fiziologice).</li>
              <li>Nu înlocuiește CPET, DLCO măsurat, CT de înaltă rezoluție sau alte investigații avansate.</li>
              <li>f<sub>IW</sub> este parametru conceptual; necesită validare experimentală pentru valori absolute.</li>
            </ul>
          </section>

          <section>
            <h2>9. Valori critice orientative</h2>
            <table>
              <thead>
                <tr>
                  <th>Indicator</th>
                  <th>Prag critic (aprox.)</th>
                  <th>Comentariu</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>VO₂/DO₂</td>
                  <td>&gt; 0.40</td>
                  <td>Extracție mare, rezervă de transport redusă</td>
                </tr>
                <tr>
                  <td>VO₂/VO₂<sup>max dif</sup></td>
                  <td>&gt; 0.80</td>
                  <td>DL efectiv limitant pentru VO₂ curent</td>
                </tr>
                <tr>
                  <td>Qs/Qt</td>
                  <td>&gt; 20%</td>
                  <td>Șunt semnificativ (ex. ARDS, pneumonie extinsă)</td>
                </tr>
                <tr>
                  <td>Gradient A–a (repaus)</td>
                  <td>&gt; 30 mmHg</td>
                  <td>Patologic (V/Q, difuziune sau șunt)</td>
                </tr>
                <tr>
                  <td>SvO₂ (repaus)</td>
                  <td>&lt; 60%</td>
                  <td>Extracție crescută, posibilă hipoperfuzie / DO₂ critic</td>
                </tr>
              </tbody>
            </table>
            <p class="small">
              Valorile sunt orientative și trebuie interpretate în context clinic.
            </p>
          </section>

          <section>
            <h2>10. Concluzie</h2>
            <p>
              Simulatorul integrat de fiziologie a oxigenului (v1.4) oferă:
            </p>
            <ul>
              <li>un model coerent al întregului traseu al O₂: alveolă → membrană → sânge → inimă → țesuturi;</li>
              <li>separarea mecanică a cauzelor hipoxiei: ventilatorie, difuzională, perfuzională, de transport;</li>
              <li>posibilitatea de a simula efort, anemie, boală pulmonară, șoc;</li>
              <li>un parametru suplimentar f<sub>IW</sub> pentru a explora rolul apei interfațiale în DL funcțional;</li>
              <li>interpretări automate bazate pe praguri fiziologice documentate.</li>
            </ul>
            <p>
              Este un instrument util pentru medici, rezidenți și fiziologi, cu valoare educațională și conceptuală în
              înțelegerea hipoxiei și a integrării ventilație–difuzie–perfuzie–metabolism.
            </p>
          </section>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* STATE CENTRAL (1A) */
    const state = {
      inputs: {
        fio2: 0.21,
        pb: 760,
        paco2: 40,
        pao2: 95,
        sao2Measured: null,
        vo2: 250,
        hb: 15,
        q: 5,
        dlClassic: 30,
        p50: 26.5,
        hillN: 2.7,
        weight: null,
        effortWeight: 70,
        lungHealthy: true,
        effortLevel: 'rest',
        o2Mode: 'air',
        shuntPct: 0,
        fIW: 1.0
      },
      results: {}
    };

    /* NAVIGARE TAB-URI & PDF */
    function showTab(id) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('tab-active'));
      document.getElementById(id).classList.add('tab-active');
      scrollTo(0, 0);
    }
    function printManual() {
      showTab('manualTab');
      setTimeout(() => window.print(), 80);
    }

    /* CONSTANTE FIZIOLOGICE */
    const PH2O = 47;
    const R = 0.8;
    const ALPHA = 0.0031;
    const HB_BIND = 1.34;

    function safeParseInput(id) {
      const raw = document.getElementById(id).value;
      const v = parseFloat(raw);
      return isNaN(v) ? null : v;
    }

    function hillSaturation(PO2, P50, n) {
      if (PO2 <= 0) return 0;
      const num = Math.pow(PO2, n);
      const den = Math.pow(P50, n) + num;
      return num / den;
    }

    function inverseHill(S, P50, n) {
      if (S <= 0.001) return 1;
      if (S >= 0.999) return 500;
      const ratio = S / (1 - S);
      const pow = Math.pow(ratio, 1.0 / n);
      return P50 * pow;
    }

    function readInputsIntoState() {
      const i = state.inputs;
      i.fio2 = safeParseInput('fio2') ?? 0.21;
      i.pb   = safeParseInput('pb')   ?? 760;
      i.paco2 = safeParseInput('paco2') ?? 40;
      i.pao2  = safeParseInput('pao2')  ?? 80;

      const sao2Box = document.getElementById('sao2').value;
      i.sao2Measured = sao2Box === '' ? null : (parseFloat(sao2Box) / 100);

      i.vo2 = safeParseInput('vo2');
      i.hb  = safeParseInput('hb')  ?? 14;
      i.q   = safeParseInput('q')   ?? 5;
      i.dlClassic = safeParseInput('dl') ?? 30;
      i.p50 = safeParseInput('p50') ?? 26.5;
      i.hillN = safeParseInput('hillN') ?? 2.7;
      i.weight = safeParseInput('weight');
      i.effortWeight = safeParseInput('effortWeight') ?? 70;
      i.lungHealthy = document.getElementById('lungHealthy').checked;
      i.effortLevel = document.getElementById('effortLevel').value;
      i.o2Mode = document.getElementById('o2Mode').value;
      i.shuntPct = safeParseInput('shunt') ?? 0;
      i.fIW = safeParseInput('fiw') ?? 1.0;

      if (i.vo2 == null && i.weight != null) {
        i.vo2 = 3.5 * i.weight;
      }
      if (i.vo2 == null) i.vo2 = 250;
    }

    function computeModel() {
      const i = state.inputs;
      const r = {};

      const fio2 = i.fio2;
      const pb   = i.pb;
      const paco2 = i.paco2;
      const pao2  = i.pao2;
      const hb  = i.hb;
      const q   = i.q;
      const dlClassic = i.dlClassic;
      const p50 = i.p50;
      const n   = i.hillN;
      const vo2 = i.vo2;
      const shuntSel = Math.max(0, Math.min(0.4, i.shuntPct / 100.0));
      const fIW = i.fIW;

      const PAO2 = fio2 * (pb - PH2O) - paco2 / R;
      const Aagrad = PAO2 - pao2;

      let sao2;
      if (i.sao2Measured != null && !isNaN(i.sao2Measured)) {
        sao2 = i.sao2Measured;
      } else {
        sao2 = hillSaturation(Math.max(pao2, 0), p50, n);
      }
      sao2 = Math.max(0, Math.min(1, sao2));

      const CaO2 = HB_BIND * hb * sao2 + ALPHA * Math.max(pao2, 0);
      const DO2 = q * 10 * CaO2;

      let CvO2 = CaO2;
      if (q > 0) {
        CvO2 = CaO2 - vo2 / (q * 10);
      }

      let SvO2 = 0;
      if (hb > 0) {
        SvO2 = CvO2 / (HB_BIND * hb);
      }
      SvO2 = Math.max(0, Math.min(1, SvO2));
      const PvO2 = inverseHill(SvO2, p50, n);

      const deltaP = Math.max(PAO2 - PvO2, 0);
      const DLeff = dlClassic * fIW;
      const VO2maxDiff = DLeff * deltaP;

      const VO2DO2 = DO2 > 0 ? (vo2 / DO2) : NaN;
      const VO2ratio = VO2maxDiff > 0 ? (vo2 / VO2maxDiff) : NaN;

      const ScO2 = hillSaturation(Math.max(PAO2, 0), p50, n);
      const CcO2 = HB_BIND * hb * ScO2 + ALPHA * Math.max(PAO2, 0);

      let shuntEst = NaN;
      if (CcO2 > CvO2 + 1e-6) {
        shuntEst = (CcO2 - CaO2) / (CcO2 - CvO2);
        shuntEst = Math.max(0, Math.min(1, shuntEst));
      }
      const CaO2_shuntSel = (1 - shuntSel) * CcO2 + shuntSel * CvO2;

      let transportStatus = '';
      let transportBadge = '';
      if (isFinite(VO2DO2)) {
        if (VO2DO2 < 0.25) {
          transportStatus = 'Rezervă de transport foarte bună (extracție globală mică).';
          transportBadge = 'ok';
        } else if (VO2DO2 < 0.4) {
          transportStatus = 'Rezervă moderată (extracție crescută, acceptabilă la efort).';
          transportBadge = 'warn';
        } else {
          transportStatus = 'Rezervă redusă (extracție mare, posibilă limitare de transport).';
          transportBadge = 'bad';
        }
      }

      let diffStatus = '';
      let diffBadge = '';
      if (isFinite(VO2ratio)) {
        if (VO2ratio < 0.4) {
          diffStatus = 'Rezervă de difuziune foarte bună (DL efectiv suficient pentru VO₂).';
          diffBadge = 'ok';
        } else if (VO2ratio < 0.8) {
          diffStatus = 'Rezervă moderată (posibilă limitare la efort intens).';
          diffBadge = 'warn';
        } else {
          diffStatus = 'Rezervă redusă (DL efectiv limitant pentru VO₂ curent).';
          diffBadge = 'bad';
        }
      }

      let o2RespText = '';
      if (fio2 <= 0.25) {
        o2RespText = 'FiO₂ joasă sau aer ambiental – folosește A–a și Qs/Qt estimat pentru a evalua mecanismul hipoxiei.';
      } else {
        if (isFinite(shuntEst) && shuntEst > 0.2 && Aagrad > 100 && pao2 < 60) {
          o2RespText = 'Răspuns foarte slab la O₂: Qs/Qt estimat > 20% sub FiO₂ crescută – șunt semnificativ (ex. ARDS, pneumonie, edem sever).';
        } else if (Aagrad < 100 && pao2 > 60) {
          o2RespText = 'Răspuns relativ bun la O₂ (PaO₂ adecvată pentru FiO₂; șunt major puțin probabil).';
        } else {
          o2RespText = 'Răspuns intermediar la O₂; corelează cu tabloul clinic, imagistica și Qs/Qt estimat.';
        }
      }

      let shuntStatus = '';
      if (isFinite(shuntEst)) {
        if (shuntEst < 0.1) {
          shuntStatus = 'Qs/Qt estimat mic (<10%) – șunt fiziologic sau V/Q ușor neomogen.';
        } else if (shuntEst < 0.2) {
          shuntStatus = 'Qs/Qt estimat moderat (10–20%) – șunt semnificativ, posibil pneumonie localizată/edem moderat.';
        } else {
          shuntStatus = 'Qs/Qt estimat mare (>20%) – șunt important (ex. ARDS, edem difuz, pneumonie extinsă).';
        }
      } else {
        shuntStatus = 'Nu se poate estima Qs/Qt (date insuficiente sau configurație numerică instabilă).';
      }

      r.PAO2 = PAO2;
      r.Aagrad = Aagrad;
      r.pao2 = pao2;
      r.sao2 = sao2;
      r.CaO2 = CaO2;
      r.DO2 = DO2;
      r.vo2 = vo2;
      r.VO2DO2 = VO2DO2;
      r.CvO2 = CvO2;
      r.SvO2 = SvO2;
      r.PvO2 = PvO2;
      r.DLclassic = dlClassic;
      r.fIW = fIW;
      r.DLeff = DLeff;
      r.VO2maxDiff = VO2maxDiff;
      r.VO2ratio = VO2ratio;
      r.transportStatus = transportStatus;
      r.transportBadge = transportBadge;
      r.diffStatus = diffStatus;
      r.diffBadge = diffBadge;
      r.o2RespText = o2RespText;
      r.CcO2 = CcO2;
      r.shuntEst = shuntEst;
      r.CaO2_shuntSel = CaO2_shuntSel;
      r.shuntStatus = shuntStatus;

      state.results = r;
    }

    function renderResults() {
      const r = state.results;
      const fmt = (x, d=1, suf='') =>
        (x != null && isFinite(x)) ? x.toFixed(d) + suf : '–';

      document.getElementById('resPAO2').textContent = fmt(r.PAO2, 1, ' mmHg');
      document.getElementById('resPaO2').textContent = fmt(r.pao2, 1, ' mmHg');
      document.getElementById('resAagrad').textContent = fmt(r.Aagrad, 1, ' mmHg');
      document.getElementById('resSaO2').textContent = fmt(r.sao2*100, 1, ' %');

      document.getElementById('resCaO2').textContent = fmt(r.CaO2, 2, ' ml/dL');
      document.getElementById('resDO2').textContent = fmt(r.DO2, 0, ' ml/min');
      document.getElementById('resVO2').textContent = fmt(r.vo2, 0, ' ml/min');
      document.getElementById('resVO2DO2').textContent = fmt(r.VO2DO2, 2, '');

      document.getElementById('resCvO2').textContent = fmt(r.CvO2, 2, ' ml/dL');
      document.getElementById('resSvO2').textContent = fmt(r.SvO2*100, 1, ' %');
      document.getElementById('resPvO2').textContent = fmt(r.PvO2, 1, ' mmHg');

      document.getElementById('resDLclassic').textContent = fmt(r.DLclassic, 1, ' ml/min/mmHg');
      document.getElementById('resFIW').textContent = fmt(r.fIW, 2, '');
      document.getElementById('resDLeff').textContent = fmt(r.DLeff, 1, ' ml/min/mmHg');
      document.getElementById('resVO2maxDiff').textContent = fmt(r.VO2maxDiff, 0, ' ml/min');
      document.getElementById('resVO2ratio').textContent = fmt(r.VO2ratio, 2, '');

      document.getElementById('resCcO2').textContent = fmt(r.CcO2, 2, ' ml/dL');
      document.getElementById('resShuntEst').textContent = (r.shuntEst != null && isFinite(r.shuntEst))
        ? (r.shuntEst*100).toFixed(1) + ' %' : '–';
      document.getElementById('resCaO2ShuntSel').textContent = fmt(r.CaO2_shuntSel, 2, ' ml/dL');

      const tEl = document.getElementById('resTransportStatus');
      tEl.textContent = '';
      if (r.transportStatus) {
        const spanText = document.createElement('span');
        spanText.textContent = r.transportStatus;
        tEl.appendChild(spanText);
        if (r.transportBadge) {
          const b = document.createElement('span');
          b.className = 'badge badge-' + r.transportBadge;
          b.textContent = r.transportBadge === 'ok' ? 'transport ok' :
                          r.transportBadge === 'warn' ? 'atenție' : 'risc';
          tEl.appendChild(b);
        }
      }

      const dEl = document.getElementById('resDiffStatus');
      dEl.textContent = '';
      if (r.diffStatus) {
        const spanText = document.createElement('span');
        spanText.textContent = r.diffStatus;
        dEl.appendChild(spanText);
        if (r.diffBadge) {
          const b = document.createElement('span');
          b.className = 'badge badge-' + r.diffBadge;
          b.textContent = r.diffBadge === 'ok' ? 'DL ok' :
                          r.diffBadge === 'warn' ? 'atenție' : 'risc';
          dEl.appendChild(b);
        }
      }

      document.getElementById('resO2Response').textContent = r.o2RespText;
      document.getElementById('resShuntStatus').textContent = r.shuntStatus;
    }

    function computeAll() {
      readInputsIntoState();
      computeModel();
      renderResults();
    }

    /* CONTROL f_IW */
    function syncFIWControls() {
      const v = state.inputs.fIW;
      document.getElementById('fiw').value = v.toFixed(2);
      document.getElementById('fiwRange').value = v.toFixed(2);
    }

    function onIWChangeFromRange() {
      const v = parseFloat(document.getElementById('fiwRange').value);
      state.inputs.fIW = isNaN(v) ? 1.0 : v;
      syncFIWControls();
      computeAll();
    }

    function onIWChangeFromBox() {
      const v = parseFloat(document.getElementById('fiw').value);
      let val = isNaN(v) ? 1.0 : v;
      if (val < 0.5) val = 0.5;
      if (val > 1.5) val = 1.5;
      state.inputs.fIW = val;
      syncFIWControls();
      computeAll();
    }

    /* PROFIL EFFORT & O2 MODE (scriu în DOM, apoi recit în state) */

    function applyEffortLevel() {
      const level = document.getElementById('effortLevel').value;
      const lungHealthy = document.getElementById('lungHealthy').checked;
      const weightEff = safeParseInput('effortWeight') ?? 70;
      const weight = safeParseInput('weight') ?? weightEff;

      if (level === 'custom') {
        computeAll();
        return;
      }

      let Q = 5;
      let VO2 = 3.5 * weight;
      let DL = 30;
      let PaCO2 = safeParseInput('paco2') ?? 40;

      if (level === 'rest') {
        Q = 5;
        VO2 = 3.5 * weight;
        DL = 30;
        PaCO2 = 40;
      } else if (level === 'light') {
        Q = 8;
        VO2 = 7 * weight;
        DL = 45;
        PaCO2 = 37;
      } else if (level === 'moderate') {
        Q = 12;
        VO2 = 14 * weight;
        DL = 60;
        PaCO2 = 35;
      } else if (level === 'intense') {
        Q = 16;
        VO2 = 20 * weight;
        DL = 75;
        PaCO2 = 32;
      }

      document.getElementById('q').value = Q.toFixed(1);
      document.getElementById('vo2').value = Math.round(VO2);
      if (lungHealthy) {
        document.getElementById('dl').value = Math.round(DL);
      }
      document.getElementById('paco2').value = PaCO2.toFixed(0);

      computeAll();
    }

    function applyOxygenMode() {
      const mode = document.getElementById('o2Mode').value;
      let fio2 = 0.21;
      switch (mode) {
        case 'air':        fio2 = 0.21; break;
        case 'nc2':        fio2 = 0.24; break;
        case 'nc4':        fio2 = 0.28; break;
        case 'venturi28':  fio2 = 0.28; break;
        case 'venturi40':  fio2 = 0.40; break;
        case 'mask40':     fio2 = 0.40; break;
        case 'mask60':     fio2 = 0.60; break;
        case 'nrbreather': fio2 = 0.90; break;
      }
      document.getElementById('fio2').value = fio2.toFixed(2);
      computeAll();
    }

    /* PRESETURI CLINICE */

    function loadNormalRest() {
      document.getElementById('fio2').value = 0.21;
      document.getElementById('pb').value = 760;
      document.getElementById('paco2').value = 40;
      document.getElementById('pao2').value = 95;
      document.getElementById('sao2').value = '';
      document.getElementById('vo2').value = 250;
      document.getElementById('hb').value = 15;
      document.getElementById('q').value = 5;
      document.getElementById('dl').value = 30;
      document.getElementById('p50').value = 26.5;
      document.getElementById('hillN').value = 2.7;
      document.getElementById('weight').value = 70;
      document.getElementById('effortWeight').value = 70;
      document.getElementById('lungHealthy').checked = true;
      document.getElementById('effortLevel').value = 'rest';
      document.getElementById('o2Mode').value = 'air';
      document.getElementById('shunt').value = 0;
      document.getElementById('fiw').value = 1.00;
      document.getElementById('fiwRange').value = 1.00;
      computeAll();
    }

    function loadNormalExercise() {
      document.getElementById('fio2').value = 0.21;
      document.getElementById('pb').value = 760;
      document.getElementById('paco2').value = 35;
      document.getElementById('pao2').value = 100;
      document.getElementById('sao2').value = '';
      document.getElementById('hb').value = 15;
      document.getElementById('p50').value = 26.5;
      document.getElementById('hillN').value = 2.7;
      document.getElementById('weight').value = 70;
      document.getElementById('effortWeight').value = 70;
      document.getElementById('lungHealthy').checked = true;
      document.getElementById('effortLevel').value = 'moderate';
      document.getElementById('o2Mode').value = 'air';
      document.getElementById('shunt').value = 0;
      document.getElementById('fiw').value = 1.00;
      document.getElementById('fiwRange').value = 1.00;
      applyEffortLevel();
    }

    function loadFibrosisRest() {
      document.getElementById('fio2').value = 0.21;
      document.getElementById('pb').value = 760;
      document.getElementById('paco2').value = 35;
      document.getElementById('pao2').value = 70;
      document.getElementById('sao2').value = '';
      document.getElementById('vo2').value = 250;
      document.getElementById('hb').value = 15;
      document.getElementById('q').value = 5;
      document.getElementById('dl').value = 10;
      document.getElementById('p50').value = 26.5;
      document.getElementById('hillN').value = 2.7;
      document.getElementById('weight').value = 70;
      document.getElementById('effortWeight').value = 70;
      document.getElementById('lungHealthy').checked = false;
      document.getElementById('effortLevel').value = 'custom';
      document.getElementById('o2Mode').value = 'air';
      document.getElementById('shunt').value = 0;
      document.getElementById('fiw').value = 1.00;
      document.getElementById('fiwRange').value = 1.00;
      computeAll();
    }

    function loadFibrosisExercise() {
      document.getElementById('fio2').value = 0.21;
      document.getElementById('pb').value = 760;
      document.getElementById('paco2').value = 32;
      document.getElementById('pao2').value = 60;
      document.getElementById('sao2').value = '';
      document.getElementById('vo2').value = 800;
      document.getElementById('hb').value = 15;
      document.getElementById('q').value = 12;
      document.getElementById('dl').value = 10;
      document.getElementById('p50').value = 26.5;
      document.getElementById('hillN').value = 2.7;
      document.getElementById('weight').value = 70;
      document.getElementById('effortWeight').value = 70;
      document.getElementById('lungHealthy').checked = false;
      document.getElementById('effortLevel').value = 'custom';
      document.getElementById('o2Mode').value = 'air';
      document.getElementById('shunt').value = 0;
      document.getElementById('fiw').value = 1.00;
      document.getElementById('fiwRange').value = 1.00;
      computeAll();
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadNormalRest();
      showTab('simulatorTab');
    });
  </script>

</body>
</html>
