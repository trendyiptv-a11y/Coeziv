<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <title>Simulator coeziv de transfer al oxigenului (v1.3 – efort + oxigen + șunt)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #111827;
    }
    header {
      padding: 1.5rem 2rem 1rem;
      background: #0f172a;
      color: #f9fafb;
    }
    header h1 {
      margin: 0 0 0.25rem;
      font-size: 1.4rem;
    }
    header p {
      margin: 0;
      font-size: 0.85rem;
      color: #cbd5f5;
    }
    main {
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1.15fr);
      gap: 1.5rem;
      padding: 1.5rem 2rem 3rem;
    }
    @media (max-width: 980px) {
      main {
        grid-template-columns: 1fr;
        padding: 1rem;
      }
    }
    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 12px 28px rgba(15,23,42,0.08);
    }
    h2 {
      margin-top: 0;
      font-size: 1.05rem;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.4rem;
      margin-bottom: 0.8rem;
    }
    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #4b5563;
      margin-top: 0.7rem;
      margin-bottom: 0.25rem;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem 1rem;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.75rem 1rem;
    }
    @media (max-width: 700px) {
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    label {
      font-size: 0.82rem;
      color: #374151;
    }
    .units {
      font-size: 0.72rem;
      color: #6b7280;
    }
    input, select {
      padding: 0.35rem 0.45rem;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.88rem;
      width: 100%;
      box-sizing: border-box;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
    }
    .btn-row {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    button {
      padding: 0.45rem 0.85rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }
    .btn-primary {
      background: #2563eb;
      color: #ffffff;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-secondary:hover {
      background: #d1d5db;
    }
    .result-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.86rem;
      padding: 0.22rem 0;
      border-bottom: 1px dashed #e5e7eb;
    }
    .result-row:last-child {
      border-bottom: none;
    }
    .result-label {
      color: #374151;
    }
    .result-value {
      font-variant-numeric: tabular-nums;
      font-weight: 500;
      margin-left: 0.7rem;
      white-space: nowrap;
    }
    .section-block {
      margin-top: 0.7rem;
      padding-top: 0.45rem;
      border-top: 1px solid #e5e7eb;
    }
    .badge {
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 500;
      margin-left: 0.4rem;
    }
    .badge-ok    { background: #dcfce7; color: #166534; }
    .badge-warn  { background: #fef9c3; color: #92400e; }
    .badge-bad   { background: #fee2e2; color: #b91c1c; }
    .pill {
      display: inline-block;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 0.1rem 0.5rem;
      font-size: 0.7rem;
      color: #374151;
      margin-left: 0.25rem;
    }
    .note {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.7rem;
    }
  </style>
</head>
<body>

<header>
  <h1>Simulator coeziv de transfer al oxigenului</h1>
  <p>v1.3 – efort + oxigenoterapie + șunt. Model integrat pentru uz educațional clinic.</p>
</header>

<main>
  <!-- INTRĂRI -->
  <section class="card">
    <h2>Parametri de intrare</h2>

    <div class="section-title">1. Mediul și gazometria</div>
    <div class="grid-3">
      <div class="field">
        <label for="fio2">FIO₂</label>
        <input id="fio2" type="number" step="0.01" value="0.21">
        <div class="units">fracție inspirată (0.21 aer, 0.5 O₂ 50%)</div>
      </div>
      <div class="field">
        <label for="pb">PB (presiune barometrică)</label>
        <input id="pb" type="number" step="1" value="760">
        <div class="units">mmHg (≈760 nivelul mării)</div>
      </div>
      <div class="field">
        <label for="paco2">PaCO₂</label>
        <input id="paco2" type="number" step="1" value="40">
        <div class="units">mmHg</div>
      </div>
    </div>

    <div class="grid-3" style="margin-top:0.75rem;">
      <div class="field">
        <label for="pao2">PaO₂ (din gazometrie)</label>
        <input id="pao2" type="number" step="1" value="95">
        <div class="units">mmHg</div>
      </div>
      <div class="field">
        <label for="sao2">SaO₂ măsurată (opțional)</label>
        <input id="sao2" type="number" step="0.1" value="">
        <div class="units">% (dacă e goală, se calculează din PaO₂)</div>
      </div>
      <div class="field">
        <label for="vo2">VO₂ (consum O₂)</label>
        <input id="vo2" type="number" step="10" value="250">
        <div class="units">ml/min (≈3.5 ml/kg/min în repaus)</div>
      </div>
    </div>

    <div class="section-title">2. Hemoglobină, debit cardiac, DL</div>
    <div class="grid-3">
      <div class="field">
        <label for="hb">Hemoglobină [Hb]</label>
        <input id="hb" type="number" step="0.1" value="15">
        <div class="units">g/dL</div>
      </div>
      <div class="field">
        <label for="q">Debit cardiac Q</label>
        <input id="q" type="number" step="0.1" value="5">
        <div class="units">L/min</div>
      </div>
      <div class="field">
        <label for="dl">DL,O₂ (capacitate difuziune)</label>
        <input id="dl" type="number" step="1" value="30">
        <div class="units">ml/min/mmHg (≈30 normal)</div>
      </div>
    </div>

    <div class="section-title">3. Curba Hb–O₂</div>
    <div class="grid-3">
      <div class="field">
        <label for="p50">P₅₀ <span class="pill">avansat</span></label>
        <input id="p50" type="number" step="0.5" value="26.5">
        <div class="units">mmHg (≈26–27 la pH 7.4)</div>
      </div>
      <div class="field">
        <label for="hillN">Exponent Hill n</label>
        <input id="hillN" type="number" step="0.1" value="2.7">
        <div class="units">≈2.7 fiziologic</div>
      </div>
      <div class="field">
        <label for="weight">Greutate pacient (opțional)</label>
        <input id="weight" type="number" step="1" value="">
        <div class="units">kg (pt. estimare VO₂ dacă lipsește)</div>
      </div>
    </div>

    <div class="section-title">4. Nivel de efort (profil generic)</div>
    <div class="grid-3">
      <div class="field">
        <label for="effortLevel">Nivel de efort</label>
        <select id="effortLevel" onchange="applyEffortLevel()">
          <option value="custom">Manual / necunoscut</option>
          <option value="rest">Repaus</option>
          <option value="light">Ușor</option>
          <option value="moderate">Moderat</option>
          <option value="intense">Intens</option>
        </select>
        <div class="units">Sugestii pentru Q, VO₂ și DL la plămân sănătos</div>
      </div>
      <div class="field">
        <label>
          <input type="checkbox" id="lungHealthy" checked>
          Plămân structural normal (DL crește la efort)
        </label>
        <div class="units">Debifează în fibroză/edem/ARDS</div>
      </div>
      <div class="field">
        <label for="effortWeight">Greutate pt. profil efort</label>
        <input id="effortWeight" type="number" step="1" value="70">
        <div class="units">kg</div>
      </div>
    </div>

    <div class="section-title">5. Oxigenoterapie (profil FiO₂)</div>
    <div class="grid-2">
      <div class="field">
        <label for="o2Mode">Mod de administrare O₂</label>
        <select id="o2Mode" onchange="applyOxygenMode()">
          <option value="air">Aer ambiental (fără O₂)</option>
          <option value="nc2">Canulă nazală 2 L/min (~24%)</option>
          <option value="nc4">Canulă nazală 4 L/min (~28%)</option>
          <option value="venturi28">Venturi 28%</option>
          <option value="venturi40">Venturi 40%</option>
          <option value="mask40">Masca simplă 40%</option>
          <option value="mask60">Masca simplă 60%</option>
          <option value="nrbreather">Masca cu rezervor (~90%)</option>
        </select>
        <div class="units">Setează automat FIO₂ aproximativă</div>
      </div>
      <div class="field">
        <label>Notă</label>
        <div class="units">
          PaO₂ trebuie introdusă din gazometria efectivă sub O₂ pentru a evalua răspunsul real.
        </div>
      </div>
    </div>

    <div class="section-title">6. Șunt (Qs/Qt)</div>
    <div class="grid-2">
      <div class="field">
        <label for="shunt">Șunt ipotetic Qs/Qt</label>
        <input id="shunt" type="number" step="1" value="0">
        <div class="units">% din debit (0–40%). Folosit pentru simulare amestec capilar–venos.</div>
      </div>
      <div class="field">
        <label>Explicație</label>
        <div class="units">
          Simulatorul estimează și Qs/Qt din date (CcO₂, CaO₂, CvO₂) și îl compară cu valoarea introdusă.
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn-primary" onclick="computeAll()">Calculează</button>
      <button class="btn-secondary" onclick="loadNormalRest()">Adult sănătos – repaus</button>
      <button class="btn-secondary" onclick="loadNormalExercise()">Adult sănătos – efort</button>
      <button class="btn-secondary" onclick="loadFibrosisRest()">Fibroză moderată – repaus</button>
      <button class="btn-secondary" onclick="loadFibrosisExercise()">Fibroză moderată – efort</button>
    </div>

    <div class="note">
      Simulator educațional pentru raționament fiziopatologic. Nu este dispozitiv medical și nu înlocuiește ghidurile sau decizia clinică.
    </div>
  </section>

  <!-- IEȘIRI -->
  <section class="card">
    <h2>Rezultate & interpretare</h2>

    <div class="section-block">
      <div class="section-title">1. Gaz alveolar și gradient A–a</div>
      <div class="result-row">
        <div class="result-label">PAO₂ (ecuația gazului alveolar)</div>
        <div class="result-value" id="resPAO2">–</div>
      </div>
      <div class="result-row">
        <div class="result-label">PaO₂ (intrare)</div>
        <div class="result-value" id="resPaO2">–</div>
      </div>
      <div class="result-row">
        <div class="result-label">Gradient A–a (PAO₂ − PaO₂)</div>
        <div class="result-value" id="resAagrad">–</div>
      </div>
      <div class="result-row">
        <div class="result-label">SaO₂ utilizată (măsurată/calculată)</div>
        <div class="result-value" id="resSaO2">–</div>
      </div>
    </div>

    <div class="section-block">
      <div class="section-title">2. Conținut arterial, livrare și extracție</div>
      <div class="result-row">
        <div class="result-label">CaO₂ (conținut arterial O₂)</div>
        <div class="result-value" id="resCaO2">–</div>
      </div>
      <div class="result-row">
        <div class="result-label">DO₂ (livrare O₂ = Q × CaO₂)</div>
        <div class="result-value" id="resDO2">–</div>
      </div>
      <div class="result-row">
        <div class="result-label">VO₂ (intrare/estimat)</div>
        <div class="result-value" id="resVO2">–</div>
      </div>
      <div class="result-row">
        <div class="result-label">Raport VO₂ / DO₂ (extracție globală)</div>
        <div class="result-value" id="resVO2DO2">–</div>
      </div>
      <div class="result-row">
        <div class="result-label">Status rezervă de transport</div>
        <div class="result-value" id="resTransportStatus">–</div>
      </div>
    </div>

    <div class="section-block">
      <div class="section-title">3. Componenta venoasă</div>
      <div class="result-row">
        <div class="result-label">CvO₂ (conținut venos de O₂)</div>
        <div class="result-value" id="resCvO2">–</div>
      </div>
      <div class="result-row">
        <div class="result-label">SvO₂ estimat</div>
        <div class="result-value" id="resSvO2">–</div>
      </div>
      <div class="result-row">
        <div class="result-label">PvO₂ estimat (din curba Hb–O₂)</div>
        <div class="result-value" id="resPvO2">–</div>
      </div>
    </div>

    <div class="section-block">
      <div class="section-title">4. Limitare de difuziune (DL) vs necesar metabolic</div>
      <div class="result-row">
        <div class="result-label">VO₂ maxim difuzabil (DL × (PAO₂ − PvO₂))</div>
        <div class="result-value" id="resVO2maxDiff">–</div>
      </div>
      <div class="result-row">
        <div class="result-label">Raport VO₂ / VO₂_max_diff</div>
        <div class="result-value" id="resVO2ratio">–</div>
      </div>
      <div class="result-row">
        <div class="result-label">Status rezervă de difuziune</div>
        <div class="result-value" id="resDiffStatus">–</div>
      </div>
    </div>

    <div class="section-block">
      <div class="section-title">5. Răspuns la oxigenoterapie (heuristic)</div>
      <div class="result-row">
        <div class="result-label">Interpretare răspuns la O₂</div>
        <div class="result-value" id="resO2Response">–</div>
      </div>
    </div>

    <div class="section-block">
      <div class="section-title">6. Analiza șuntului (Qs/Qt)</div>
      <div class="result-row">
        <div class="result-label">CcO₂ (capilar ideal, din PAO₂)</div>
        <div class="result-value" id="resCcO2">–</div>
      </div>
      <div class="result-row">
        <div class="result-label">Qs/Qt estimat din date</div>
        <div class="result-value" id="resShuntEst">–</div>
      </div>
      <div class="result-row">
        <div class="result-label">CaO₂ prezis pt. șunt introdus</div>
        <div class="result-value" id="resCaO2ShuntSel">–</div>
      </div>
      <div class="result-row">
        <div class="result-label">Status șunt</div>
        <div class="result-value" id="resShuntStatus">–</div>
      </div>
    </div>

    <div class="note">
      Heuristică: VO₂/DO₂ ≈ 0.25 în repaus, până spre 0.4 la efort; VO₂/VO₂_max_diff &lt; 0.5 sugerează rezervă bună de difuziune; Qs/Qt &gt; 20% sub FiO₂ crescută indică șunt semnificativ (ex. ARDS, pneumonie, edem sever).
    </div>
  </section>
</main>

<script>
  const PH2O = 47;
  const R = 0.8;
  const ALPHA = 0.0031;
  const HB_BIND = 1.34;

  function safeParse(id, fallback) {
    const raw = document.getElementById(id).value;
    const v = parseFloat(raw);
    return isNaN(v) ? fallback : v;
  }

  function hillSaturation(PO2, P50, n) {
    if (PO2 <= 0) return 0;
    const num = Math.pow(PO2, n);
    const den = Math.pow(P50, n) + num;
    return num / den;
  }

  function inverseHill(S, P50, n) {
    if (S <= 0.001) return 1;
    if (S >= 0.999) return 500;
    const ratio = S / (1 - S);
    const pow = Math.pow(ratio, 1.0 / n);
    return P50 * pow;
  }

  function computeAll() {
    const fio2  = safeParse('fio2', 0.21);
    const pb    = safeParse('pb', 760);
    const paco2 = safeParse('paco2', 40);
    const pao2  = safeParse('pao2', 80);
    const sao2Input = document.getElementById('sao2').value;
    let sao2 = sao2Input !== '' ? parseFloat(sao2Input)/100 : NaN;

    let vo2   = safeParse('vo2', NaN);
    const hb  = safeParse('hb', 14);
    const q   = safeParse('q', 5);
    const dl  = safeParse('dl', 30);
    const p50 = safeParse('p50', 26.5);
    const n   = safeParse('hillN', 2.7);
    const weight = safeParse('weight', NaN);
    const shuntInputPct = safeParse('shunt', 0);
    const shuntSel = Math.max(0, Math.min(0.4, shuntInputPct / 100.0));

    if (!isFinite(vo2) && isFinite(weight)) {
      vo2 = 3.5 * weight;
    }
    if (!isFinite(vo2)) {
      vo2 = 250;
    }

    const PAO2 = fio2 * (pb - PH2O) - paco2 / R;
    const Aagrad = PAO2 - pao2;

    if (!isFinite(sao2)) {
      sao2 = hillSaturation(Math.max(pao2, 0), p50, n);
    }
    sao2 = Math.max(0, Math.min(1, sao2));

    const CaO2 = HB_BIND * hb * sao2 + ALPHA * Math.max(pao2, 0);
    const DO2 = q * 10 * CaO2;

    let CvO2 = CaO2;
    if (q > 0) {
      CvO2 = CaO2 - vo2 / (q * 10);
    }

    let SvO2 = 0;
    if (hb > 0) {
      SvO2 = CvO2 / (HB_BIND * hb);
    }
    SvO2 = Math.max(0, Math.min(1, SvO2));

    const PvO2 = inverseHill(SvO2, p50, n);

    const deltaP = Math.max(PAO2 - PvO2, 0);
    const VO2maxDiff = dl * deltaP;

    const VO2DO2 = DO2 > 0 ? (vo2 / DO2) : NaN;
    const VO2ratio = VO2maxDiff > 0 ? (vo2 / VO2maxDiff) : NaN;

    // Capilar ideal (CcO2) din PAO2
    const ScO2 = hillSaturation(Math.max(PAO2, 0), p50, n);
    const CcO2 = HB_BIND * hb * ScO2 + ALPHA * Math.max(PAO2, 0);

    // Qs/Qt estimat din date: (CcO2 - CaO2)/(CcO2 - CvO2)
    let shuntEst = NaN;
    if (CcO2 > CvO2 + 1e-6) {
      shuntEst = (CcO2 - CaO2) / (CcO2 - CvO2);
      shuntEst = Math.max(0, Math.min(1, shuntEst));
    }

    // CaO2 prezis pentru șuntul selectat: (1-s)*CcO2 + s*CvO2
    const CaO2_shuntSel = (1 - shuntSel) * CcO2 + shuntSel * CvO2;

    // Interpretări
    let transportStatus = '';
    let transportBadge = '';
    if (isFinite(VO2DO2)) {
      if (VO2DO2 < 0.25) {
        transportStatus = 'Rezervă de transport foarte bună (extracție globală mică).';
        transportBadge = 'ok';
      } else if (VO2DO2 < 0.4) {
        transportStatus = 'Rezervă moderată (extracție crescută, acceptabilă la efort).';
        transportBadge = 'warn';
      } else {
        transportStatus = 'Rezervă redusă (extracție mare, posibilă limitare de transport).';
        transportBadge = 'bad';
      }
    }

    let diffStatus = '';
    let diffBadge = '';
    if (isFinite(VO2ratio)) {
      if (VO2ratio < 0.4) {
        diffStatus = 'Rezervă de difuziune foarte bună (DL suficient pentru VO₂).';
        diffBadge = 'ok';
      } else if (VO2ratio < 0.8) {
        diffStatus = 'Rezervă moderată (pot apărea limitări la efort intens).';
        diffBadge = 'warn';
      } else {
        diffStatus = 'Rezervă redusă (DL limitant pentru VO₂ curent).';
        diffBadge = 'bad';
      }
    }

    // Răspuns la O2, ajustat cu shunt estimat
    let o2RespText = '';
    if (fio2 <= 0.25) {
      o2RespText = 'FiO₂ joasă sau aer ambiental – folosește A–a și Qs/Qt estimat pentru a evalua mecanismul hipoxiei.';
    } else {
      if (isFinite(shuntEst) && shuntEst > 0.2 && Aagrad > 100 && pao2 < 60) {
        o2RespText = 'Răspuns foarte slab la O₂: Qs/Qt estimat > 20% sub FiO₂ crescută – șunt semnificativ (ex. ARDS, pneumonie, edem sever).';
      } else if (Aagrad < 100 && pao2 > 60) {
        o2RespText = 'Răspuns relativ bun la O₂ (PaO₂ adecvată pentru FiO₂; șunt major puțin probabil).';
      } else {
        o2RespText = 'Răspuns intermediar la O₂; corelează cu tabloul clinic, imagistica și Qs/Qt estimat.';
      }
    }

    // Status șunt în funcție de shuntEst
    let shuntStatus = '';
    if (isFinite(shuntEst)) {
      if (shuntEst < 0.1) {
        shuntStatus = 'Qs/Qt estimat mic (<10%) – șunt fiziologic sau V/Q ușor neomogen.';
      } else if (shuntEst < 0.2) {
        shuntStatus = 'Qs/Qt estimat moderat (10–20%) – șunt semnificativ, posibil pneumonie localizată/edem moderat.';
      } else {
        shuntStatus = 'Qs/Qt estimat mare (>20%) – șunt important (ex. ARDS, edem difuz, pneumonie extinsă).';
      }
    } else {
      shuntStatus = 'Nu se poate estima Qs/Qt (date insuficiente sau configurație numerică instabilă).';
    }

    const fmt = (x, d=1, suf='') =>
      isFinite(x) ? x.toFixed(d) + suf : '–';

    document.getElementById('resPAO2').textContent = fmt(PAO2, 1, ' mmHg');
    document.getElementById('resPaO2').textContent = fmt(pao2, 1, ' mmHg');
    document.getElementById('resAagrad').textContent = fmt(Aagrad, 1, ' mmHg');
    document.getElementById('resSaO2').textContent = fmt(sao2*100, 1, ' %');

    document.getElementById('resCaO2').textContent = fmt(CaO2, 2, ' ml/dL');
    document.getElementById('resDO2').textContent = fmt(DO2, 0, ' ml/min');
    document.getElementById('resVO2').textContent = fmt(vo2, 0, ' ml/min');
    document.getElementById('resVO2DO2').textContent = fmt(VO2DO2, 2, '');

    document.getElementById('resCvO2').textContent = fmt(CvO2, 2, ' ml/dL');
    document.getElementById('resSvO2').textContent = fmt(SvO2*100, 1, ' %');
    document.getElementById('resPvO2').textContent = fmt(PvO2, 1, ' mmHg');

    document.getElementById('resVO2maxDiff').textContent = fmt(VO2maxDiff, 0, ' ml/min');
    document.getElementById('resVO2ratio').textContent = fmt(VO2ratio, 2, '');

    document.getElementById('resCcO2').textContent = fmt(CcO2, 2, ' ml/dL');
    document.getElementById('resShuntEst').textContent = isFinite(shuntEst) ? (shuntEst*100).toFixed(1) + ' %' : '–';
    document.getElementById('resCaO2ShuntSel').textContent = fmt(CaO2_shuntSel, 2, ' ml/dL');

    const tEl = document.getElementById('resTransportStatus');
    tEl.textContent = '';
    if (transportStatus) {
      const spanText = document.createElement('span');
      spanText.textContent = transportStatus;
      tEl.appendChild(spanText);
      if (transportBadge) {
        const b = document.createElement('span');
        b.className = 'badge badge-' + transportBadge;
        b.textContent = transportBadge === 'ok' ? 'transport ok' :
                        transportBadge === 'warn' ? 'atenție' : 'risc';
        tEl.appendChild(b);
      }
    }

    const dEl = document.getElementById('resDiffStatus');
    dEl.textContent = '';
    if (diffStatus) {
      const spanText = document.createElement('span');
      spanText.textContent = diffStatus;
      dEl.appendChild(spanText);
      if (diffBadge) {
        const b = document.createElement('span');
        b.className = 'badge badge-' + diffBadge;
        b.textContent = diffBadge === 'ok' ? 'DL ok' :
                        diffBadge === 'warn' ? 'atenție' : 'risc';
        dEl.appendChild(b);
      }
    }

    document.getElementById('resO2Response').textContent = o2RespText;
    document.getElementById('resShuntStatus').textContent = shuntStatus;
  }

  // EFORT
  function applyEffortLevel() {
    const level = document.getElementById('effortLevel').value;
    const lungHealthy = document.getElementById('lungHealthy').checked;
    const weightEff = safeParse('effortWeight', 70);
    const weight = isFinite(weightEff) ? weightEff : safeParse('weight', 70);

    if (level === 'custom') return;

    let Q = 5;
    let VO2 = 3.5 * weight;
    let DL = 30;
    let PaCO2 = safeParse('paco2', 40);

    if (level === 'rest') {
      Q = 5;
      VO2 = 3.5 * weight;
      DL = 30;
      PaCO2 = 40;
    } else if (level === 'light') {
      Q = 8;
      VO2 = 7 * weight;
      DL = 45;
      PaCO2 = 37;
    } else if (level === 'moderate') {
      Q = 12;
      VO2 = 14 * weight;
      DL = 60;
      PaCO2 = 35;
    } else if (level === 'intense') {
      Q = 16;
      VO2 = 20 * weight;
      DL = 75;
      PaCO2 = 32;
    }

    document.getElementById('q').value = Q.toFixed(1);
    document.getElementById('vo2').value = Math.round(VO2);
    if (lungHealthy) {
      document.getElementById('dl').value = Math.round(DL);
    }
    document.getElementById('paco2').value = PaCO2.toFixed(0);

    computeAll();
  }

  // OXIGENOTERAPIE
  function applyOxygenMode() {
    const mode = document.getElementById('o2Mode').value;
    let fio2 = 0.21;
    switch (mode) {
      case 'air':        fio2 = 0.21; break;
      case 'nc2':        fio2 = 0.24; break;
      case 'nc4':        fio2 = 0.28; break;
      case 'venturi28':  fio2 = 0.28; break;
      case 'venturi40':  fio2 = 0.40; break;
      case 'mask40':     fio2 = 0.40; break;
      case 'mask60':     fio2 = 0.60; break;
      case 'nrbreather': fio2 = 0.90; break;
    }
    document.getElementById('fio2').value = fio2.toFixed(2);
    computeAll();
  }

  // Preseturi clinice
  function loadNormalRest() {
    document.getElementById('fio2').value = 0.21;
    document.getElementById('pb').value = 760;
    document.getElementById('paco2').value = 40;
    document.getElementById('pao2').value = 95;
    document.getElementById('sao2').value = '';
    document.getElementById('vo2').value = 250;
    document.getElementById('hb').value = 15;
    document.getElementById('q').value = 5;
    document.getElementById('dl').value = 30;
    document.getElementById('p50').value = 26.5;
    document.getElementById('hillN').value = 2.7;
    document.getElementById('weight').value = 70;
    document.getElementById('effortWeight').value = 70;
    document.getElementById('lungHealthy').checked = true;
    document.getElementById('effortLevel').value = 'rest';
    document.getElementById('o2Mode').value = 'air';
    document.getElementById('shunt').value = 0;
    applyEffortLevel();
  }

  function loadNormalExercise() {
    document.getElementById('fio2').value = 0.21;
    document.getElementById('pb').value = 760;
    document.getElementById('paco2').value = 35;
    document.getElementById('pao2').value = 100;
    document.getElementById('sao2').value = '';
    document.getElementById('hb').value = 15;
    document.getElementById('p50').value = 26.5;
    document.getElementById('hillN').value = 2.7;
    document.getElementById('weight').value = 70;
    document.getElementById('effortWeight').value = 70;
    document.getElementById('lungHealthy').checked = true;
    document.getElementById('effortLevel').value = 'moderate';
    document.getElementById('o2Mode').value = 'air';
    document.getElementById('shunt').value = 0;
    applyEffortLevel();
  }

  function loadFibrosisRest() {
    document.getElementById('fio2').value = 0.21;
    document.getElementById('pb').value = 760;
    document.getElementById('paco2').value = 35;
    document.getElementById('pao2').value = 70;
    document.getElementById('sao2').value = '';
    document.getElementById('vo2').value = 250;
    document.getElementById('hb').value = 15;
    document.getElementById('q').value = 5;
    document.getElementById('dl').value = 10;
    document.getElementById('p50').value = 26.5;
    document.getElementById('hillN').value = 2.7;
    document.getElementById('weight').value = 70;
    document.getElementById('effortWeight').value = 70;
    document.getElementById('lungHealthy').checked = false;
    document.getElementById('effortLevel').value = 'custom';
    document.getElementById('o2Mode').value = 'air';
    document.getElementById('shunt').value = 0;
    computeAll();
  }

  function loadFibrosisExercise() {
    document.getElementById('fio2').value = 0.21;
    document.getElementById('pb').value = 760;
    document.getElementById('paco2').value = 32;
    document.getElementById('pao2').value = 60;
    document.getElementById('sao2').value = '';
    document.getElementById('vo2').value = 800;
    document.getElementById('hb').value = 15;
    document.getElementById('q').value = 12;
    document.getElementById('dl').value = 10;
    document.getElementById('p50').value = 26.5;
    document.getElementById('hillN').value = 2.7;
    document.getElementById('weight').value = 70;
    document.getElementById('effortWeight').value = 70;
    document.getElementById('lungHealthy').checked = false;
    document.getElementById('effortLevel').value = 'custom';
    document.getElementById('o2Mode').value = 'air';
    document.getElementById('shunt').value = 0;
    computeAll();
  }

  window.addEventListener('DOMContentLoaded', loadNormalRest);
</script>

</body>
</html>
