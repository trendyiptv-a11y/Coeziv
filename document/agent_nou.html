<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asistent Coeziv 3.14</title>
  <style>
    :root{
      --bg:#0d1117;
      --panel:#111827;
      --border:#1f2937;
      --fg:#e6edf3;
      --muted:#9ca3af;
      --user:#0ea5e9;
      --ai:#1f2937;
      --send:#10b981;
      --copy:#3b82f6;
      --chipbg:#0f172a;
      --chipbd:#334155;
    }
    *{ box-sizing:border-box; }

    body{
      background:var(--bg);
      color:var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Inter", sans-serif;
      margin:0;
      padding:0;
      overflow-x:hidden;
    }

    .container{
      max-width: 780px;
      margin: 0 auto;
      padding: 18px;
      width: 92%;
    }

    h1{
      font-size: 1.8rem;
      font-weight: 800;
      display:flex;
      align-items:center;
      gap:10px;
      margin: 10px 0 6px;
    }
    p{
      margin: 0 0 14px;
      color: var(--muted);
      line-height: 1.4;
    }

    .card{
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(17,24,39,0.72);
      box-shadow: 0 16px 38px rgba(0,0,0,0.35);
      overflow:hidden;
    }

    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-bottom:1px solid var(--border);
    }

    .toolbar-left{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border:1px solid var(--chipbd);
      background: var(--chipbg);
      border-radius: 999px;
      color: var(--fg);
      font-size: 0.85rem;
      user-select:none;
      white-space:nowrap;
    }

    .switch{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border:1px solid var(--chipbd);
      background: var(--chipbg);
      border-radius: 999px;
      font-size: 0.85rem;
      user-select:none;
      white-space:nowrap;
    }
    .switch input{
      width: 16px;
      height: 16px;
      accent-color: var(--send);
      cursor:pointer;
    }

    #chat{
      padding: 14px 12px;
      height: 62vh;
      min-height: 380px;
      max-height: 640px;
      overflow-y:auto;
      background: var(--panel);
    }

    .divider{
      text-align:center;
      color: var(--muted);
      font-size: 0.85rem;
      margin: 8px 0 14px;
    }

    .bubble-row{
      display:flex;
      margin: 10px 0;
      width: 100%;
    }
    .bubble-row.user{ justify-content:flex-end; }
    .bubble-row.ai{ justify-content:flex-start; }

    .bubble{
      padding: 12px 14px;
      border-radius: 16px;
      max-width: 86%;
      font-size: 1rem;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .bubble.user{
      background: var(--user);
      color: #fff;
      border-bottom-right-radius: 6px;
    }
    .bubble.ai{
      background: var(--ai);
      color: var(--fg);
      border: 1px solid rgba(51,65,85,0.7);
      border-bottom-left-radius: 6px;
    }

    .bubble-meta{
      margin-top: 7px;
      padding-left: 2px;
      display:flex;
      gap: 6px;
      flex-wrap:wrap;
    }
    .meta-chip{
      background: var(--chipbg);
      border: 1px solid var(--chipbd);
      font-size: 12px;
      padding: 2px 7px;
      border-radius: 999px;
      color: var(--muted);
    }

    .footer{
      padding: 12px;
      border-top:1px solid var(--border);
      background: rgba(17,24,39,0.5);
    }

    .input-area{
      display:flex;
      gap:10px;
      flex-direction: column;
    }

    #q{
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid var(--chipbd);
      background: var(--chipbg);
      color: var(--fg);
      font-size: 1rem;
      outline:none;
      width: 100%;
    }
    #q::placeholder{ color:#64748b; }

    .btnrow{
      display:flex;
      gap:10px;
      flex-direction: column;
    }

    button{
      padding: 12px 16px;
      font-size: 1rem;
      border: none;
      border-radius: 999px;
      cursor:pointer;
      transition: 0.15s;
      width: 100%;
      font-weight: 650;
    }
    button:disabled{
      opacity: 0.55;
      cursor:not-allowed;
    }
    #send{
      background: var(--send);
      color:#04130f;
    }
    #copy{
      background: var(--copy);
      color:#fff;
    }
    #reset{
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--chipbd);
      font-weight: 600;
    }
    #reset:hover{
      color: var(--fg);
      border-color: rgba(148,163,184,0.65);
    }

    #status{
      margin-top: 10px;
      color: var(--muted);
      font-size: 0.9rem;
      min-height: 1.1em;
      word-break: break-word;
    }

    @media (min-width: 768px){
      .input-area{ flex-direction: row; align-items: flex-end; }
      #q{ flex: 1; }
      .btnrow{ flex-direction: row; width: auto; }
      button{ width: auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ¤– Asistent Coeziv 3.14</h1>
    <p>ÃŽntreabÄƒ despre Modelul Coeziunii, homeostazie, apÄƒ È™i interpretÄƒri coezive. (ConversaÈ›ia se goleÈ™te la refresh.)</p>

    <div class="card">
      <div class="toolbar">
        <div class="toolbar-left">
          <div class="pill">StructurÄƒ Â· Flux Â· Reorganizare Â· Noua structurÄƒ</div>
          <label class="switch" title="CÃ¢nd e ON, trimite cÄƒtre /api/ask browse=true. Agentul poate integra Serper dacÄƒ e activ.">
            <input id="browse" type="checkbox" />
            Browsing
          </label>
          <div class="pill" id="webBadge">Web: auto</div>
        </div>
        <button id="reset" type="button" title="È˜terge conversaÈ›ia din UI (nu È™terge memoria server).">Reset UI</button>
      </div>

      <div id="chat" aria-live="polite">
        <div class="divider">ÃŽncepe cu o Ã®ntrebare.</div>
      </div>

      <div class="footer">
        <div class="input-area">
          <input id="q" type="text" placeholder="Scrie Ã®ntrebarea ta aici..." autocomplete="off" />
          <div class="btnrow">
            <button id="send" type="button">Trimite</button>
            <button id="copy" type="button" disabled>CopiazÄƒ</button>
          </div>
        </div>
        <div id="status"></div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const chatEl   = document.getElementById("chat");
      const qEl      = document.getElementById("q");
      const sendBtn  = document.getElementById("send");
      const copyBtn  = document.getElementById("copy");
      const resetBtn = document.getElementById("reset");
      const statusEl = document.getElementById("status");
      const browseEl = document.getElementById("browse");
      const webBadge = document.getElementById("webBadge");

      // IMPORTANT: UI se goleÈ™te la refresh (nu folosim localStorage pentru history).
      let history = [];

      // userId stabil (pt. memoria server-side). Nu include conversaÈ›ia, doar ID.
      // DacÄƒ NU vrei deloc memorie per user, È™terge complet userId din payload.
      const userIdKey = "coeziv_user_id_v1";
      let userId = null;
      try {
        userId = localStorage.getItem(userIdKey);
        if (!userId) {
          userId = "u_" + Math.random().toString(36).slice(2) + "_" + Date.now().toString(36);
          localStorage.setItem(userIdKey, userId);
        }
      } catch {
        userId = "default";
      }

      function clearChatUI() {
        chatEl.innerHTML = '<div class="divider">ÃŽncepe cu o Ã®ntrebare.</div>';
        history = [];
        copyBtn.disabled = true;
        statusEl.textContent = "";
        qEl.focus();
      }

      function appendBubble(role, text, meta = null) {
        const row = document.createElement("div");
        row.className = "bubble-row " + role;

        const bubble = document.createElement("div");
        bubble.className = "bubble " + role;
        bubble.textContent = text;

        row.appendChild(bubble);

        if (meta) {
          const metaDiv = document.createElement("div");
          metaDiv.className = "bubble-meta";

          if (meta.J != null && !Number.isNaN(meta.J)) {
            const chip = document.createElement("span");
            chip.className = "meta-chip";
            chip.textContent = "J = " + Number(meta.J).toFixed(2);
            metaDiv.appendChild(chip);
          }
          if (meta.regime) {
            const chip = document.createElement("span");
            chip.className = "meta-chip";
            chip.textContent = "Regim: " + meta.regime;
            metaDiv.appendChild(chip);
          }
          if (meta.action) {
            const chip = document.createElement("span");
            chip.className = "meta-chip";
            chip.textContent = "AcÈ›iune: " + meta.action;
            metaDiv.appendChild(chip);
          }
          if (meta.webUsed != null) {
            const chip = document.createElement("span");
            chip.className = "meta-chip";
            chip.textContent = "Web: " + (meta.webUsed ? "DA" : "NU");
            metaDiv.appendChild(chip);
          }

          row.appendChild(metaDiv);
        }

        chatEl.appendChild(row);
        chatEl.scrollTop = chatEl.scrollHeight;
        return row;
      }

      function appendTyping() {
        const row = document.createElement("div");
        row.className = "bubble-row ai";

        const bubble = document.createElement("div");
        bubble.className = "bubble ai";
        bubble.textContent = "Se gÃ¢ndeÈ™teâ€¦";

        row.appendChild(bubble);
        chatEl.appendChild(row);
        chatEl.scrollTop = chatEl.scrollHeight;
        return row;
      }

      function currentChatText() {
        // ÃŽnlocuieÈ™te multiple spaÈ›ii / pÄƒstreazÄƒ lizibil
        return chatEl.innerText.trim();
      }

      copyBtn.addEventListener("click", async () => {
        try {
          const chatText = currentChatText();
          if (!chatText) return;
          await navigator.clipboard.writeText(chatText);
          alert("Chatul a fost copiat!");
        } catch (e) {
          alert("Eroare la copiere: " + (e?.message || String(e)));
        }
      });

      resetBtn.addEventListener("click", clearChatUI);

      function updateWebBadge() {
        // "auto" = off (agentul poate decide), "forced" = on (browse=true)
        webBadge.textContent = browseEl.checked ? "Web: forced" : "Web: auto";
      }
      browseEl.addEventListener("change", updateWebBadge);
      updateWebBadge();

      async function ask() {
        const q = qEl.value.trim();
        if (!q) return;

        statusEl.textContent = "";

        appendBubble("user", q);
        history.push({ role: "user", content: q });

        qEl.value = "";
        sendBtn.disabled = true;
        copyBtn.disabled = true;

        const typingRow = appendTyping();

        try {
          const payload = {
            message: q,
            history,
            browse: !!browseEl.checked,   // <â€” cheie: browsing din UI
            userId,                       // <â€” pentru memorie server-side
          };

          const res = await fetch("/api/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          let data = null;
          try {
            data = await res.json();
          } catch {
            const txt = await res.text();
            data = { assistant_reply: "Eroare: rÄƒspuns non-JSON: " + txt.slice(0, 250) };
          }

          typingRow.remove();

          const reply = data.assistant_reply || data.answer || "FÄƒrÄƒ rÄƒspuns valid.";

          const meta = {
            J: Number(data?.analysis?.j_state?.J),
            regime: data?.analysis?.j_state?.regime || "",
            action: data?.policy_output?.action || data?.analysis?.policy?.action || "",
            webUsed: !!data?.used_web_search
          };

          appendBubble("ai", reply, meta);
          history.push({ role: "assistant", content: reply });

          copyBtn.disabled = false;
        } catch (err) {
          try { typingRow.remove(); } catch {}
          appendBubble("ai", "Eroare de reÈ›ea. ÃŽncearcÄƒ din nou.");
          statusEl.textContent = err?.message || String(err);
        } finally {
          sendBtn.disabled = false;
          qEl.focus();
        }
      }

      sendBtn.addEventListener("click", ask);
      qEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          ask();
        }
      });

      // Focus iniÈ›ial
      qEl.focus();
    });
  </script>
</body>
</html>
