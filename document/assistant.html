<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asistent Coeziv 3.14</title>
  <style>
    :root {
      --emerald:#00ffb7;
      --accent:#10b981;
      --bg:#020617;
      --bg-elevated:#020617;
      --panel:#020617;
      --border:#1e293b;
      --fg:#e5e7eb;
      --muted:#9ca3af;
      --user:#38bdf8;
      --ai:#e5e7eb;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:stretch;
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
      color:var(--fg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .shell{
      width:100%;
      max-width:900px;
      padding:1.5rem;
      display:flex;
      flex-direction:column;
      gap:1rem;
    }

    header{
      text-align:center;
    }
    header h1{
      margin:0 0 .35rem;
      font-size:1.9rem;
      letter-spacing:.03em;
      color:var(--emerald);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.4rem;
    }
    header p{
      margin:0;
      color:var(--muted);
      font-size:.95rem;
    }

    .card{
      flex:1;
      display:flex;
      flex-direction:column;
      background:rgba(15,23,42,0.85);
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.35);
      box-shadow:0 18px 45px rgba(15,23,42,0.8);
      overflow:hidden;
      backdrop-filter: blur(14px);
    }

    .chat-header{
      padding:.75rem 1rem;
      border-bottom:1px solid rgba(15,23,42,1);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
    }
    .chat-header-left{
      display:flex;
      align-items:center;
      gap:.6rem;
    }
    .chat-pill{
      width:28px;
      height:28px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%, #22c55e, #0f172a);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.1rem;
    }
    .chat-title{
      font-size:.95rem;
      font-weight:600;
    }
    .chat-subtitle{
      font-size:.78rem;
      color:var(--muted);
    }
    .chip{
      padding:.18rem .55rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      font-size:.72rem;
      color:var(--muted);
      white-space:nowrap;
    }

    .chat-body{
      flex:1;
      display:flex;
      flex-direction:column;
      padding:.75rem 1rem;
      gap:.35rem;
      overflow-y:auto;
      scroll-behavior:smooth;
    }

    .bubble-row{
      display:flex;
      margin:.25rem 0;
    }
    .bubble-row.user{ justify-content:flex-end; }
    .bubble-row.ai{ justify-content:flex-start; }

    .bubble{
      max-width:80%;
      padding:.6rem .8rem .5rem;
      border-radius:1rem;
      font-size:.92rem;
      line-height:1.5;
      white-space:pre-wrap;
      word-break:break-word;
      position:relative;
    }
    .bubble.user{
      background:linear-gradient(135deg,#0ea5e9,#22d3ee);
      color:#0f172a;
      border-bottom-right-radius:.3rem;
    }
    .bubble.ai{
      background:rgba(15,23,42,0.85);
      border:1px solid rgba(30,64,175,0.55);
      color:var(--ai);
      border-bottom-left-radius:.3rem;
    }

    .bubble-meta{
      margin-top:.25rem;
      font-size:.73rem;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:.5rem;
      flex-wrap:wrap;
    }
    .meta-chip{
      padding:.12rem .5rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.3);
    }

    .typing{
      opacity:.7;
      font-style:italic;
    }

    .divider{
      text-align:center;
      margin:.2rem 0 .4rem;
      font-size:.72rem;
      color:var(--muted);
    }

    .chat-footer{
      padding:.6rem 1rem .8rem;
      border-top:1px solid rgba(15,23,42,1);
      display:flex;
      flex-direction:column;
      gap:.4rem;
    }

    .input-row{
      display:flex;
      gap:.55rem;
      align-items:flex-end;
    }
    .input-row input{
      flex:1;
      min-width:0;
      padding:.8rem .9rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--fg);
      outline:none;
      font-size:.92rem;
    }
    .input-row input::placeholder{ color:#64748b; }

    .input-row button{
      border:none;
      border-radius:999px;
      padding:.72rem 1.35rem;
      font-weight:600;
      font-size:.9rem;
      cursor:pointer;
      background:linear-gradient(135deg,#22c55e,#14b8a6);
      color:#020617;
      box-shadow:0 0 0 1px rgba(34,197,94,0.4),0 12px 25px rgba(16,185,129,0.45);
      transition:transform .08s ease, box-shadow .08s ease, opacity .15s ease;
    }
    .input-row button:hover:not([disabled]){
      transform:translateY(-1px);
      box-shadow:0 16px 36px rgba(16,185,129,0.65);
    }
    .input-row button:active:not([disabled]){
      transform:translateY(0);
      box-shadow:0 8px 18px rgba(16,185,129,0.5);
    }
    .input-row button[disabled]{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    .status{
      font-size:.78rem;
      color:var(--muted);
      min-height:1em;
    }

    .back-link{
      margin-top:.4rem;
      text-align:center;
      font-size:.82rem;
    }
    .back-link a{
      color:var(--emerald);
      text-decoration:none;
    }
    .back-link a:hover{ text-decoration:underline; }

    @media (max-width:640px){
      .shell{ padding:1rem .75rem; }
      .bubble{ max-width:100%; }
      header h1{ font-size:1.5rem; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <h1>ü§ñ Asistent Coeziv 3.14</h1>
      <p>√éntreabƒÉ despre Modelul Coeziunii, homeostazie, apƒÉ »ôi interpretƒÉri coezive.</p>
    </header>

    <section class="card" aria-label="Chat Asistent Coeziv 3.14">
      <div class="chat-header">
        <div class="chat-header-left">
          <div class="chat-pill">3.14</div>
          <div>
            <div class="chat-title">Canal Coeziv</div>
            <div class="chat-subtitle">StructurƒÉ ¬∑ Flux ¬∑ Reorganizare ¬∑ Noua structurƒÉ</div>
          </div>
        </div>
        <div class="chip">MVP ¬∑ CoezivWallet-AI</div>
      </div>

      <div id="chat" class="chat-body" aria-live="polite" aria-label="Istoric conversa»õie">
        <div class="divider">√éncepe cu o √Æntrebare. Modelul rƒÉspunde √Æn logica CoezivƒÉ.</div>
      </div>

      <div class="chat-footer">
        <div class="input-row">
          <input id="q" placeholder="Scrie √Æntrebarea ta aici..." autocomplete="off"/>
          <button id="send">Trimite</button>
        </div>
        <div id="status" class="status"></div>
      </div>
    </section>

    <div class="back-link">
      <a href="/document/index.html">‚Üê √énapoi la arhivƒÉ</a>
    </div>
  </div>

  <script>
    const chatEl   = document.getElementById("chat");
    const qEl      = document.getElementById("q");
    const sendBtn  = document.getElementById("send");
    const statusEl = document.getElementById("status");

    let history = [];

    function typewriter(el, fullText, speed = 12) {
      let i = 0;
      function step() {
        if (i <= fullText.length) {
          el.textContent = fullText.slice(0, i);
          i++;
          chatEl.scrollTop = chatEl.scrollHeight;
          setTimeout(step, speed);
        }
      }
      step();
    }

    function appendBubble(role, text, meta = null, options = {}) {
      const row = document.createElement("div");
      row.className = "bubble-row " + role;

      const bubble = document.createElement("div");
      bubble.className = "bubble " + role;

      if (role === "ai" && options.animate) {
        bubble.textContent = "";
      } else {
        bubble.textContent = text;
      }

      row.appendChild(bubble);

      if (meta) {
        const metaDiv = document.createElement("div");
        metaDiv.className = "bubble-meta";

        if (meta.J != null) {
          const jChip = document.createElement("span");
          jChip.className = "meta-chip";
          jChip.textContent = `J = ${meta.J.toFixed(2)}`;
          metaDiv.appendChild(jChip);
        }
        if (meta.regime) {
          const rChip = document.createElement("span");
          rChip.className = "meta-chip";
          rChip.textContent = `Regim: ${meta.regime}`;
          metaDiv.appendChild(rChip);
        }
        if (meta.action) {
          const aChip = document.createElement("span");
          aChip.className = "meta-chip";
          aChip.textContent = `Ac»õiune: ${meta.action}`;
          metaDiv.appendChild(aChip);
        }

        row.appendChild(metaDiv);
      }

      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;

      if (role === "ai" && options.animate) {
        typewriter(bubble, text);
      }

      return row;
    }

    function appendTyping(){
      const row = document.createElement("div");
      row.className = "bubble-row ai";
      const bubble = document.createElement("div");
      bubble.className = "bubble ai typing";
      bubble.textContent = "CoEziv AI se g√¢nde»ôte‚Ä¶";
      row.appendChild(bubble);
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
      return row;
<script>
    const chatEl   = document.getElementById("chat");
    const qEl      = document.getElementById("q");
    const sendBtn  = document.getElementById("send");
    const statusEl = document.getElementById("status");

    // Istoric doar √Æn memoria paginii (NU se mai salveazƒÉ √Æn localStorage)
    let history = [];

    function typewriter(el, fullText, speed = 12) {
      let i = 0;
      function step() {
        if (i <= fullText.length) {
          el.textContent = fullText.slice(0, i);
          i++;
          chatEl.scrollTop = chatEl.scrollHeight;
          setTimeout(step, speed);
        }
      }
      step();
    }

    function appendBubble(role, text, meta = null, options = {}) {
      const row = document.createElement("div");
      row.className = "bubble-row " + role;
<script>
    const chatEl   = document.getElementById("chat");
    const qEl      = document.getElementById("q");
    const sendBtn  = document.getElementById("send");
    const statusEl = document.getElementById("status");

    // Istoric doar √Æn memoria paginii (NU se mai salveazƒÉ √Æn localStorage)
    let history = [];

    function typewriter(el, fullText, speed = 12) {
      let i = 0;
      function step() {
        if (i <= fullText.length) {
          el.textContent = fullText.slice(0, i);
          i++;
          chatEl.scrollTop = chatEl.scrollHeight;
          setTimeout(step, speed);
        }
      }
      step();
    }

    function appendBubble(role, text, meta = null, options = {}) {
      const row = document.createElement("div");
      row.className = "bubble-row " + role;

      const bubble = document.createElement("div");
      bubble.className = "bubble " + role;

      if (role === "ai" && options.animate) {
        bubble.textContent = "";
      } else {
        bubble.textContent = text;
      }

      row.appendChild(bubble);

      if (meta) {
        const metaDiv = document.createElement("div");
        metaDiv.className = "bubble-meta";

        if (meta.J != null) {
          const jChip = document.createElement("span");
          jChip.className = "meta-chip";
          jChip.textContent = `J = ${meta.J.toFixed(2)}`;
          metaDiv.appendChild(jChip);
        }
        if (meta.regime) {
          const rChip = document.createElement("span");
          rChip.className = "meta-chip";
          rChip.textContent = `Regim: ${meta.regime}`;
          metaDiv.appendChild(rChip);
        }
        if (meta.action) {
          const aChip = document.createElement("span");
          aChip.className = "meta-chip";
          aChip.textContent = `Ac»õiune: ${meta.action}`;
          metaDiv.appendChild(aChip);
        }

        row.appendChild(metaDiv);
      }

      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;

      if (role === "ai" && options.animate) {
        typewriter(bubble, text);
      }

      return row;
    }

    function appendTyping(){
      const row = document.createElement("div");
      row.className = "bubble-row ai";
      const bubble = document.createElement("div");
      bubble.className = "bubble ai typing";
      bubble.textContent = "CoEziv AI se g√¢nde»ôte‚Ä¶";
      row.appendChild(bubble);
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
      return row;
    }

    async function ask(){
      const q = qEl.value.trim();
      if(!q) return;

      statusEl.textContent = "";
      appendBubble("user", q, null, { animate: false });
      history.push({ role: "user", content: q });

      qEl.value = "";
      sendBtn.disabled = true;

      const typingRow = appendTyping();

      try{
        const res = await fetch("/api/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: q, history })
        });

        let data;
        try{
          data = await res.json();
        }catch{
          const txt = await res.text();
          data = { assistant_reply: `Eroare: rƒÉspuns non-JSON: ${txt.slice(0,200)}‚Ä¶` };
        }

        typingRow.remove();

        const replyText =
          (typeof data.assistant_reply === "string" && data.assistant_reply.trim().length > 0)
            ? data.assistant_reply
            : "Nu am primit un rƒÉspuns inteligibil. Po»õi repeta, te rog, √Æntrebarea?";

        let meta = null;
        if(data.analysis && data.analysis.j_state){
          const Jraw = Number(data.analysis.j_state.J);
          if(!Number.isNaN(Jraw)){
            meta = {
              J: Jraw,
              regime: data.analysis.j_state.regime || "",
              action: data.policy_output?.action || data.analysis.policy?.action || ""
            };
          } else {
            meta = {
              regime: data.analysis.j_state.regime || "",
              action: data.policy_output?.action || data.analysis.policy?.action || ""
            };
          }
        }

        appendBubble("ai", replyText, meta, { animate: true });
        history.push({ role: "assistant", content: replyText, meta });

      } catch (e){
        typingRow.remove();
        appendBubble("ai", "A apƒÉrut o eroare de re»õea. √éncearcƒÉ din nou.", null, { animate: false });
        statusEl.textContent = e.message || String(e);
      } finally {
        sendBtn.disabled = false;
        qEl.focus();
      }
    }

    sendBtn.addEventListener("click", ask);
    qEl.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        ask();
      }
    });
  </script>
</body>
</html>
