<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>M3U Editor FAST – Multi Group</title>

<style>
:root{color-scheme:light dark}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0}
.wrap{max-width:1150px;margin:auto;padding:16px}
.card{border:1px solid rgba(127,127,127,.25);border-radius:16px;padding:14px}
h1{margin:0 0 10px;font-size:1.1rem}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select,button{padding:8px 10px;border-radius:12px;border:1px solid rgba(127,127,127,.35);background:transparent}
button:disabled{opacity:.5}
.meta{font-size:.9rem;opacity:.8}
.pill{display:inline-block;padding:2px 8px;border:1px solid rgba(127,127,127,.35);border-radius:999px;font-size:.8rem}

.progress{height:10px;border-radius:999px;border:1px solid rgba(127,127,127,.25);overflow:hidden;flex:1}
.bar{height:100%;width:0;background:rgba(255,170,0,.55)}

.split{display:grid;grid-template-columns:1.1fr .9fr;gap:12px;margin-top:12px}
@media(max-width:900px){.split{grid-template-columns:1fr}}

.list{max-height:520px;overflow:auto;border-radius:14px;border:1px solid rgba(127,127,127,.25)}
.item{display:grid;grid-template-columns:60px 1fr;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(127,127,127,.15);cursor:pointer}
.item.active{outline:2px solid rgba(255,170,0,.6);outline-offset:-2px}
.idx{opacity:.7;font-variant-numeric:tabular-nums}
.title{font-weight:650}
.sub{font-size:.85rem;opacity:.75;word-break:break-all}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:700px){.grid2{grid-template-columns:1fr}}

.warn{color:#c98000}
</style>
</head>

<body>
<div class="wrap">
<div class="card">
<h1>M3U Editor FAST (120 MB+) — multi-group</h1>

<div class="row">
<input id="file" type="file" accept=".m3u,.m3u8"/>
<button id="exportAll" disabled>⬇ Export all</button>
<button id="exportView" disabled>⬇ Export results</button>
<span class="meta" id="status">Încarcă un M3U mare (stream parsing).</span>
</div>

<div class="row" style="margin-top:8px">
<div class="progress"><div class="bar" id="bar"></div></div>
<span class="pill" id="stats">0 entries</span>
<span class="pill" id="groups">0 groups</span>
</div>

<div class="row" style="margin-top:10px">
<input id="q" type="text" placeholder="Caută (min 2 caractere)"/>
<select id="limit">
<option value="200">200</option>
<option value="500" selected>500</option>
<option value="2000">2000</option>
<option value="5000">5000</option>
</select>
<select id="minChars">
<option value="1">min 1</option>
<option value="2" selected>min 2</option>
<option value="3">min 3</option>
</select>
</div>

<!-- MULTI GROUP -->
<div style="margin-top:10px">
<input id="groupQ" type="text" placeholder="Filtrează grupuri (ex: RO)"/>
<div class="meta" style="margin:6px 0">
<label><input id="groupAll" type="checkbox" checked/> All groups</label>
<span class="pill" id="groupPicked">All</span>
</div>
<div id="groupBox" class="list" style="max-height:160px"></div>
</div>

<div class="split">
<div>
<div class="meta">Rezultate</div>
<div class="list" id="list"></div>
</div>

<div>
<div class="meta">Editare</div>
<div class="grid2">
<input id="eTitle" placeholder="Title"/>
<input id="eGroup" placeholder="Group"/>
</div>
<input id="eUrl" placeholder="URL" style="margin-top:8px"/>
<div class="row" style="margin-top:8px">
<button id="save" disabled>Save</button>
<button id="del" disabled>Delete</button>
<button id="clear" disabled>Clear</button>
</div>
</div>
</div>

</div>
</div>

<script>
const $=s=>document.querySelector(s);
const el={
file:$("#file"),status:$("#status"),bar:$("#bar"),
stats:$("#stats"),groups:$("#groups"),
exportAll:$("#exportAll"),exportView:$("#exportView"),
q:$("#q"),limit:$("#limit"),minChars:$("#minChars"),
groupQ:$("#groupQ"),groupAll:$("#groupAll"),
groupBox:$("#groupBox"),groupPicked:$("#groupPicked"),
list:$("#list"),
eTitle:$("#eTitle"),eGroup:$("#eGroup"),eUrl:$("#eUrl"),
save:$("#save"),del:$("#del"),clear:$("#clear")
};

let entries=[],groups=new Map(),selectedGroups=new Set();
let selectedIndex=-1,viewIdx=[];
const headerRe=/^\s*#+\s*(.*?)\s*#+\s*$/;
const DEBOUNCE=220;

function esc(s){return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]))}

function updateGroupPicked(){
el.groupPicked.textContent=selectedGroups.size===0?"All":`${selectedGroups.size} selected`;
}

function renderGroupBox(){
const q=(el.groupQ.value||"").toLowerCase();
el.groupBox.innerHTML="";
let shown=0;
for(const g of [...groups.keys()].sort()){
if(q && !g.toLowerCase().includes(q))continue;
shown++; if(shown>400)break;
const checked=selectedGroups.size===0||selectedGroups.has(g);
const row=document.createElement("div");
row.className="item";
row.style.gridTemplateColumns="28px 1fr";
row.innerHTML=`<div><input type="checkbox" ${checked?"checked":""}></div>
<div><div class="title">${esc(g)} <span class="pill">${groups.get(g)}</span></div></div>`;
row.querySelector("input").onchange=e=>{
if(selectedGroups.size===0&&!e.target.checked){
selectedGroups=new Set(groups.keys());selectedGroups.delete(g);
}else{
e.target.checked?selectedGroups.add(g):selectedGroups.delete(g);
if(selectedGroups.size===groups.size)selectedGroups.clear();
}
el.groupAll.checked=selectedGroups.size===0;
updateGroupPicked();schedule();
};
el.groupBox.appendChild(row);
}
}

function buildView(){
viewIdx=[];
const q=el.q.value.toLowerCase();
if(q.length<+el.minChars.value && selectedGroups.size===0){
el.list.innerHTML="<div class='item'><div class='idx'>ℹ</div><div class='title'>Caută întâi</div></div>";
return;
}
for(let i=0;i<entries.length;i++){
const e=entries[i];
if(selectedGroups.size && !selectedGroups.has(e.group))continue;
if(q && !(e.title+" "+e.url+" "+e.group).toLowerCase().includes(q))continue;
viewIdx.push(i);
if(viewIdx.length>=+el.limit.value)break;
}
renderList();
}

function renderList(){
el.list.innerHTML="";
for(const i of viewIdx){
const e=entries[i];
const d=document.createElement("div");
d.className="item"+(i===selectedIndex?" active":"");
d.innerHTML=`<div class="idx">#${i+1}</div><div><div class="title">${esc(e.title)}</div><div class="sub">${esc(e.group)} · ${esc(e.url)}</div></div>`;
d.onclick=()=>select(i);
el.list.appendChild(d);
}
el.exportView.disabled=viewIdx.length===0;
}

function select(i){
selectedIndex=i;
const e=entries[i];
el.eTitle.value=e.title;el.eGroup.value=e.group;el.eUrl.value=e.url;
el.save.disabled=false;el.del.disabled=false;el.clear.disabled=false;
renderList();
}

function schedule(){clearTimeout(window._t);window._t=setTimeout(buildView,DEBOUNCE)}

async function load(file){
entries=[];groups.clear();selectedGroups.clear();
el.bar.style.width="0%";el.status.textContent="Parsing...";
const dec=new TextDecoder();const r=file.stream().getReader();
let buf="",pt="",cg="Ungrouped",read=0;
while(true){
const {value,done}=await r.read(); if(done)break;
read+=value.byteLength;buf+=dec.decode(value,{stream:true});
let i;while((i=buf.indexOf("\n"))!=-1){
const line=buf.slice(0,i).trim();buf=buf.slice(i+1);
if(!line)continue;
if(line.startsWith("#EXTINF:")){pt=line.split(",").slice(1).join(",");continue;}
if(line.startsWith("#"))continue;
const m=pt.match(headerRe);
if(m){cg=m[1];pt="";continue;}
entries.push({title:pt||line,url:line,group:cg});
groups.set(cg,(groups.get(cg)||0)+1);pt="";
if(entries.length%8000===0){
el.bar.style.width=Math.round(read/file.size*100)+"%";
await new Promise(r=>setTimeout(r,0));
}
}
}
el.bar.style.width="100%";
el.stats.textContent=`${entries.length.toLocaleString()} entries`;
el.groups.textContent=`${groups.size} groups`;
el.exportAll.disabled=false;
renderGroupBox();updateGroupPicked();buildView();
}

el.file.onchange=e=>e.target.files[0]&&load(e.target.files[0]);
el.q.oninput=schedule;el.limit.onchange=schedule;el.minChars.onchange=schedule;
el.groupQ.oninput=renderGroupBox;
el.groupAll.onchange=()=>{
if(el.groupAll.checked)selectedGroups.clear();
else selectedGroups=new Set(groups.keys());
renderGroupBox();updateGroupPicked();schedule();
};

el.save.onclick=()=>{
if(selectedIndex<0)return;
entries[selectedIndex]={title:el.eTitle.value||el.eUrl.value,url:el.eUrl.value,group:el.eGroup.value||"Ungrouped"};
schedule();
};
el.del.onclick=()=>{
if(selectedIndex<0)return;
entries.splice(selectedIndex,1);selectedIndex=-1;schedule();
};
el.clear.onclick=()=>{selectedIndex=-1;el.eTitle.value=el.eGroup.value=el.eUrl.value="";el.save.disabled=el.del.disabled=el.clear.disabled=true;renderList()};

el.exportAll.onclick=()=>{
let o="#EXTM3U\n",lg=null;
for(const e of entries){
if(e.group!==lg){o+=`#EXTINF:-1,##### ${e.group} #####\n#\n`;lg=e.group;}
o+=`#EXTINF:-1,${e.title}\n${e.url}\n`;
}
const b=new Blob([o],{type:"audio/x-mpegurl"});
const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download="edited.m3u";a.click();
};

el.exportView.onclick=()=>{
const subset=viewIdx.map(i=>entries[i]);
let o="#EXTM3U\n",lg=null;
for(const e of subset){
if(e.group!==lg){o+=`#EXTINF:-1,##### ${e.group} #####\n#\n`;lg=e.group;}
o+=`#EXTINF:-1,${e.title}\n${e.url}\n`;
}
const b=new Blob([o],{type:"audio/x-mpegurl"});
const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download="results.m3u";a.click();
};
</script>
</body>
</html>
