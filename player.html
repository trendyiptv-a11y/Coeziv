<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M3U Editor FAST (120MB+)</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card { border: 1px solid rgba(127,127,127,.25); border-radius: 16px; padding: 14px; }
    h1 { margin: 0 0 10px; font-size: 1.1rem; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="file"] { max-width: 100%; }
    input[type="text"] {
      flex: 1 1 320px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.35);
      background: transparent;
      box-sizing: border-box;
    }
    button, select {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.35);
      background: transparent;
      cursor: pointer;
    }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .meta { font-size:.9rem; opacity:.8; }
    .pill { display:inline-block; padding: 2px 8px; border: 1px solid rgba(127,127,127,.35); border-radius: 999px; font-size:.8rem; opacity:.9; }

    .progress { height: 10px; border-radius: 999px; border: 1px solid rgba(127,127,127,.25); overflow:hidden; flex:1 1 360px; }
    .bar { height: 100%; width: 0%; background: rgba(255,170,0,.55); }

    .split { display:grid; grid-template-columns: 1.05fr .95fr; gap: 12px; margin-top: 12px; }
    @media (max-width: 940px){ .split{ grid-template-columns: 1fr; } }

    .list { max-height: 520px; overflow:auto; border-radius: 14px; border: 1px solid rgba(127,127,127,.25); }
    .item {
      display:grid;
      grid-template-columns: 70px 1fr;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(127,127,127,.14);
      cursor:pointer;
    }
    .item:last-child{ border-bottom:none; }
    .item.active { outline: 2px solid rgba(255,170,0,.6); outline-offset:-2px; }
    .idx { opacity:.7; font-variant-numeric: tabular-nums; }
    .title { font-weight: 650; }
    .sub { font-size:.84rem; opacity:.75; word-break: break-all; }

    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 700px){ .grid2 { grid-template-columns: 1fr; } }

    .warn { color: #c98000; }
    .ok { color: #2aa14a; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>M3U Editor FAST ‚Äî pentru playlist-uri mari (120MB+)</h1>

      <div class="row">
        <input id="file" type="file" accept=".m3u,.m3u8,text/plain,audio/x-mpegurl,application/vnd.apple.mpegurl" />
        <button id="exportAll" disabled>‚¨á Export all</button>
        <button id="exportView" disabled>‚¨á Export results</button>
        <span class="meta" id="status">√éncarcƒÉ un .m3u/.m3u8 (parsing streaming).</span>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="progress"><div class="bar" id="bar"></div></div>
        <span class="pill" id="stats">0 entries</span>
        <span class="pill" id="groups">0 groups</span>
      </div>

      <div class="row" style="margin-top:10px;">
        <input id="q" type="text" placeholder="CautƒÉ (min 2 caractere) ‚Äî title/url/group" />
        <select id="groupSel" style="min-width:220px;">
          <option value="__all__">All groups</option>
        </select>
        <select id="limit">
          <option value="200">200 results</option>
          <option value="500" selected>500 results</option>
          <option value="2000">2000 results</option>
          <option value="5000">5000 results</option>
        </select>
        <select id="minChars" title="C√¢te caractere minim pentru rezultate">
          <option value="1">min 1</option>
          <option value="2" selected>min 2</option>
          <option value="3">min 3</option>
        </select>
      </div>

      <div class="split">
        <div>
          <div class="meta" style="margin: 6px 0 8px;">Rezultate (nu randeazƒÉ nimic p√¢nƒÉ nu cau»õi)</div>
          <div class="list" id="list"></div>
          <div class="meta" id="hint" style="margin-top:8px;">
            <span class="warn">Tip:</span> pentru 120MB, cautƒÉ √Ænt√¢i (min 2-3 litere), altfel ar dura sƒÉ ‚Äúscaneze‚Äù fƒÉrƒÉ sens.
          </div>
        </div>

        <div>
          <div class="meta" style="margin: 6px 0 8px;">Editor intrare</div>

          <div class="grid2">
            <div>
              <div class="meta">Title</div>
              <input id="eTitle" type="text" placeholder="ex: RO - PRO CINEMA HD" />
            </div>
            <div>
              <div class="meta">Group</div>
              <input id="eGroup" type="text" placeholder="ex: RO - CINEMA" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="meta">URL</div>
            <input id="eUrl" type="text" placeholder="ex: http://..." />
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="save" disabled>üíæ Save</button>
            <button id="dup" disabled>‚éò Duplicate</button>
            <button id="del" disabled>üóë Delete</button>
            <button id="clear" disabled>Clear selection</button>
          </div>

          <div class="meta" style="margin-top:10px;">
            <span class="warn">NotƒÉ:</span> aceastƒÉ versiune pƒÉstreazƒÉ structura simplƒÉ (title/url/group). DacƒÉ ai `tvg-logo` etc. »ôi vrei pƒÉstrare completƒÉ, √Æ»õi dau varianta ‚Äúlossless‚Äù.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (s) => document.querySelector(s);

  const el = {
    file: $("#file"),
    status: $("#status"),
    bar: $("#bar"),
    stats: $("#stats"),
    groups: $("#groups"),

    exportAll: $("#exportAll"),
    exportView: $("#exportView"),

    q: $("#q"),
    groupSel: $("#groupSel"),
    limit: $("#limit"),
    minChars: $("#minChars"),

    list: $("#list"),
    hint: $("#hint"),

    eTitle: $("#eTitle"),
    eGroup: $("#eGroup"),
    eUrl: $("#eUrl"),
    save: $("#save"),
    dup: $("#dup"),
    del: $("#del"),
    clear: $("#clear"),
  };

  let entries = []; // {title,url,group}
  let selectedIndex = -1;

  let viewIdx = [];
  let groups = new Map(); // name -> count (for dropdown)
  const headerRe = /^\s*#+\s*(.*?)\s*#+\s*$/; // ##### GROUP #####

  const DEBOUNCE_MS = 220;

  function setStatus(t){ el.status.textContent = t; }
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function getLimit(){ return parseInt(el.limit.value, 10) || 500; }
  function minChars(){ return parseInt(el.minChars.value, 10) || 2; }

  function downloadText(filename, text, mime){
    const blob = new Blob([text], {type: mime || "audio/x-mpegurl"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  }

  function toM3U(list){
    let out = "#EXTM3U\n";
    let lastGroup = null;

    for (const e of list){
      const g = (e.group || "Ungrouped").trim() || "Ungrouped";
      if (g !== lastGroup){
        out += `#EXTINF:-1,##### ${g} #####\n`;
        out += `#\n`;
        lastGroup = g;
      }
      const title = (e.title || "").trim() || e.url;
      out += `#EXTINF:-1,${title}\n`;
      out += `${e.url}\n`;
    }
    return out;
  }

  function rebuildGroupSelectOnce(){
    const current = el.groupSel.value;
    el.groupSel.innerHTML = `<option value="__all__">All groups</option>`;
    const names = Array.from(groups.keys()).sort((a,b)=>a.localeCompare(b));
    for (const g of names){
      const opt = document.createElement("option");
      opt.value = g;
      opt.textContent = `${g} (${groups.get(g)})`;
      el.groupSel.appendChild(opt);
    }
    if ([...el.groupSel.options].some(o => o.value === current)) el.groupSel.value = current;
  }

  function clearSelection(){
    selectedIndex = -1;
    el.eTitle.value = "";
    el.eGroup.value = "";
    el.eUrl.value = "";

    el.save.disabled = true;
    el.dup.disabled = true;
    el.del.disabled = true;
    el.clear.disabled = true;
  }

  function enableEditor(){
    el.save.disabled = false;
    el.dup.disabled = false;
    el.del.disabled = false;
    el.clear.disabled = false;
  }

  function select(i){
    selectedIndex = i;
    const e = entries[i];
    el.eTitle.value = e.title || "";
    el.eGroup.value = e.group || "";
    el.eUrl.value = e.url || "";
    enableEditor();
    renderResults(); // highlight active
  }

  function renderResults(){
    el.stats.textContent = `${entries.length.toLocaleString("ro-RO")} entries`;
    el.groups.textContent = `${groups.size.toLocaleString("ro-RO")} groups`;

    el.exportAll.disabled = entries.length === 0;
    el.exportView.disabled = viewIdx.length === 0;

    el.list.innerHTML = "";

    const q = el.q.value.trim().toLowerCase();
    const gsel = el.groupSel.value;
    const min = minChars();

    if (entries.length === 0){
      el.list.innerHTML = `<div class="item"><div class="idx">‚Äî</div><div><div class="title">Nimic √ÆncƒÉrcat</div><div class="sub">√éncarcƒÉ un .m3u</div></div></div>`;
      return;
    }

    if (q.length < min && (gsel === "__all__")){
      el.list.innerHTML = `<div class="item">
        <div class="idx">‚ÑπÔ∏è</div>
        <div>
          <div class="title">Scrie minim ${min} caractere ca sƒÉ vezi rezultate</div>
          <div class="sub">E inten»õionat (playlist mare). DacƒÉ vrei, po»õi filtra direct pe un group.</div>
        </div>
      </div>`;
      return;
    }

    const lim = getLimit();
    viewIdx = buildViewIndexes(q, gsel, lim);

    if (!viewIdx.length){
      el.list.innerHTML = `<div class="item"><div class="idx">‚Äî</div><div><div class="title">Niciun rezultat</div><div class="sub">√éncearcƒÉ altƒÉ cƒÉutare / alt group.</div></div></div>`;
      el.exportView.disabled = true;
      return;
    }

    for (const i of viewIdx){
      const e = entries[i];
      const div = document.createElement("div");
      div.className = "item" + (i === selectedIndex ? " active" : "");
      div.innerHTML = `
        <div class="idx">#${i+1}</div>
        <div>
          <div class="title">${esc(e.title)}</div>
          <div class="sub">${esc(e.group)} ¬∑ ${esc(e.url)}</div>
        </div>
      `;
      div.addEventListener("click", () => select(i));
      el.list.appendChild(div);
    }

    el.exportView.disabled = false;
    el.hint.innerHTML = `Rezultate: <span class="pill">${viewIdx.length}</span> (limit ${lim}).`;
  }

  function buildViewIndexes(qLower, gsel, lim){
    const out = [];
    const groupFilter = (gsel && gsel !== "__all__") ? gsel : "";

    for (let i = 0; i < entries.length; i++){
      const e = entries[i];
      if (groupFilter && e.group !== groupFilter) continue;

      if (qLower){
        const hay = (e.title + " " + e.url + " " + (e.group || "")).toLowerCase();
        if (!hay.includes(qLower)) continue;
      }

      out.push(i);
      if (out.length >= lim) break;
    }
    return out;
  }

  // Streaming parser
  async function loadFileStreaming(file){
    setStatus(`Parsing ${file.name}...`);
    el.bar.style.width = "0%";
    entries = [];
    groups = new Map();
    viewIdx = [];
    clearSelection();
    renderResults();

    const decoder = new TextDecoder("utf-8", { fatal:false });
    const reader = file.stream().getReader();
    const total = file.size;
    let read = 0;

    let buffer = "";
    let pendingTitle = "";
    let currentGroup = "Ungrouped";

    const YIELD_EVERY = 8000;

    while (true){
      const {value, done} = await reader.read();
      if (done) break;

      read += value.byteLength;
      buffer += decoder.decode(value, {stream:true});

      let nl;
      while ((nl = buffer.indexOf("\n")) !== -1){
        const raw = buffer.slice(0, nl);
        buffer = buffer.slice(nl + 1);

        const line = raw.replace(/\r/g,"").trim();
        if (!line) continue;

        if (line.startsWith("#EXTINF:")){
          const comma = line.indexOf(",");
          pendingTitle = (comma !== -1) ? line.slice(comma + 1).trim() : "";
          continue;
        }

        if (line.startsWith("#")) continue;

        // URL line
        const m = pendingTitle.match(headerRe);
        if (m){
          const g = (m[1] || "").trim();
          if (g) currentGroup = g;
          pendingTitle = "";
          continue;
        }

        const entry = {
          title: pendingTitle || line,
          url: line,
          group: currentGroup || "Ungrouped"
        };
        entries.push(entry);

        // group counts
        const gname = entry.group;
        groups.set(gname, (groups.get(gname) || 0) + 1);

        pendingTitle = "";

        if (entries.length % YIELD_EVERY === 0){
          const pct = Math.min(100, Math.round((read / total) * 100));
          el.bar.style.width = pct + "%";
          el.stats.textContent = `${entries.length.toLocaleString("ro-RO")} entries`;
          el.groups.textContent = `${groups.size.toLocaleString("ro-RO")} groups`;
          setStatus(`Parsing... ${pct}%`);
          await new Promise(r => setTimeout(r, 0));
        }
      }
    }

    buffer += decoder.decode();
    el.bar.style.width = "100%";
    setStatus(`Gata: ${file.name} ¬∑ ${entries.length.toLocaleString("ro-RO")} intrƒÉri ¬∑ ${groups.size.toLocaleString("ro-RO")} groups`);
    rebuildGroupSelectOnce();
    renderResults();
  }

  // Debounced search
  let t = null;
  function scheduleRender(){
    clearTimeout(t);
    t = setTimeout(renderResults, DEBOUNCE_MS);
  }

  // Events
  el.file.addEventListener("change", async () => {
    const f = el.file.files?.[0];
    if (!f) return;
    await loadFileStreaming(f);
  });

  el.q.addEventListener("input", scheduleRender);
  el.groupSel.addEventListener("change", () => { scheduleRender(); });
  el.limit.addEventListener("change", () => { scheduleRender(); });
  el.minChars.addEventListener("change", () => { scheduleRender(); });

  el.save.addEventListener("click", () => {
    if (selectedIndex < 0) return;
    const url = el.eUrl.value.trim();
    if (!url) return alert("URL lipsƒÉ.");

    const title = el.eTitle.value.trim() || url;
    const group = el.eGroup.value.trim() || "Ungrouped";

    const oldGroup = entries[selectedIndex].group;

    entries[selectedIndex] = { title, url, group };

    // update group counts (simplu: recalculƒÉm doar c√¢nd se schimbƒÉ group)
    if (oldGroup !== group){
      groups.set(oldGroup, Math.max(0, (groups.get(oldGroup) || 1) - 1));
      if ((groups.get(oldGroup) || 0) === 0) groups.delete(oldGroup);

      groups.set(group, (groups.get(group) || 0) + 1);
      rebuildGroupSelectOnce();
    }

    setStatus("Salvat.");
    renderResults();
  });

  el.dup.addEventListener("click", () => {
    if (selectedIndex < 0) return;
    const copy = {...entries[selectedIndex]};
    entries.splice(selectedIndex + 1, 0, copy);
    groups.set(copy.group, (groups.get(copy.group) || 0) + 1);
    setStatus("Duplicat.");
    rebuildGroupSelectOnce();
    select(selectedIndex + 1);
  });

  el.del.addEventListener("click", () => {
    if (selectedIndex < 0) return;
    if (!confirm("»òtergi intrarea selectatƒÉ?")) return;
    const g = entries[selectedIndex].group;
    entries.splice(selectedIndex, 1);
    groups.set(g, Math.max(0, (groups.get(g) || 1) - 1));
    if ((groups.get(g) || 0) === 0) groups.delete(g);
    rebuildGroupSelectOnce();
    setStatus("»òters.");
    clearSelection();
    renderResults();
  });

  el.clear.addEventListener("click", () => {
    clearSelection();
    renderResults();
  });

  el.exportAll.addEventListener("click", () => {
    const m3u = toM3U(entries);
    downloadText("edited.m3u", m3u, "audio/x-mpegurl");
  });

  el.exportView.addEventListener("click", () => {
    const subset = viewIdx.map(i => entries[i]);
    const m3u = toM3U(subset);
    downloadText("results.m3u", m3u, "audio/x-mpegurl");
  });

  // initial
  renderResults();
</script>
</body>
</html>
