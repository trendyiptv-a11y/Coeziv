<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M3U Editor MEGA ‚Äì Multi Group + Export TS/UA/Ref</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .card { border: 1px solid rgba(127,127,127,.25); border-radius: 16px; padding: 14px; }
    h1 { margin: 0 0 10px; font-size: 1.1rem; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, select, button, textarea {
      padding: 8px 10px; border-radius: 12px;
      border: 1px solid rgba(127,127,127,.35);
      background: transparent;
      box-sizing: border-box;
    }
    input[type="file"] { max-width: 100%; }
    input[type="text"] { flex: 1 1 320px; }
    textarea { width: 100%; min-height: 90px; resize: vertical; }
    button { cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .meta { font-size: .9rem; opacity: .8; }
    .pill { display:inline-block; padding: 2px 8px; border: 1px solid rgba(127,127,127,.35); border-radius: 999px; font-size: .8rem; opacity: .9; }

    .progress { height: 10px; border-radius: 999px; border: 1px solid rgba(127,127,127,.25); overflow:hidden; flex: 1 1 360px; }
    .bar { height: 100%; width: 0%; background: rgba(255,170,0,.55); }

    .split { display:grid; grid-template-columns: 1.15fr .85fr; gap: 12px; margin-top: 12px; }
    @media (max-width: 920px){ .split{ grid-template-columns: 1fr; } }

    .list { max-height: 520px; overflow:auto; border-radius: 14px; border: 1px solid rgba(127,127,127,.25); }
    .item {
      display:grid; grid-template-columns: 72px 1fr;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(127,127,127,.14);
      cursor:pointer;
    }
    .item:last-child{ border-bottom:none; }
    .item.active { outline: 2px solid rgba(255,170,0,.6); outline-offset:-2px; }
    .idx { opacity:.7; font-variant-numeric: tabular-nums; }
    .title { font-weight: 650; }
    .sub { font-size:.85rem; opacity:.75; word-break: break-all; }

    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 700px){ .grid2{ grid-template-columns: 1fr; } }

    .groupBox { max-height: 180px; }
    .gRow {
      display:grid; grid-template-columns: 28px 1fr;
      gap: 10px;
      padding: 8px 10px;
      border-bottom: 1px solid rgba(127,127,127,.14);
      align-items:center;
    }
    .gRow:last-child { border-bottom: none; }
    .gTitle { font-weight: 650; }

    .panel { border: 1px solid rgba(127,127,127,.25); border-radius: 14px; padding: 10px; }
    .warn { color: #c98000; }
    .ok { color: #2aa14a; }
    .small { font-size: .85rem; opacity: .85; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>M3U Editor MEGA (120MB+) ‚Äî multi-grup + export ‚Äúforce TS / UA / referer‚Äù</h1>

      <div class="row">
        <input id="file" type="file" accept=".m3u,.m3u8,text/plain,audio/x-mpegurl,application/vnd.apple.mpegurl" />
        <button id="exportAll" disabled>‚¨á Export all</button>
        <button id="exportResults" disabled>‚¨á Export results</button>
        <span class="meta" id="status">√éncarcƒÉ un M3U mare (parsing streaming).</span>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="progress"><div class="bar" id="bar"></div></div>
        <span class="pill" id="stats">0 entries</span>
        <span class="pill" id="groupsCount">0 groups</span>
        <span class="pill" id="groupState">All</span>
      </div>

      <div class="split">
        <!-- LEFT -->
        <div>
          <div class="row" style="margin-top:6px;">
            <input id="q" type="text" placeholder="CautƒÉ (title/url/group) ‚Äî pentru fi»ôiere mari, min 2-3 caractere" />
            <select id="limit" title="Max rezultate afi»ôate">
              <option value="200">200</option>
              <option value="500" selected>500</option>
              <option value="2000">2000</option>
              <option value="5000">5000</option>
            </select>
            <select id="minChars" title="Min caractere pentru rezultate c√¢nd nu filtrezi grupuri">
              <option value="1">min 1</option>
              <option value="2" selected>min 2</option>
              <option value="3">min 3</option>
            </select>
          </div>

          <div class="panel" style="margin-top:10px;">
            <div class="row">
              <input id="groupQ" type="text" placeholder="FiltreazƒÉ lista de grupuri (ex: RO, EN, SPORT...)" />
              <label class="row" style="gap:8px; flex:0 0 auto;">
                <input id="allGroups" type="checkbox" checked />
                <span class="meta">All groups</span>
              </label>
              <button id="selectNone" type="button">None</button>
              <button id="selectAll" type="button">All</button>
            </div>

            <div class="list groupBox" id="groupBox" style="margin-top:8px;"></div>

            <div class="meta" style="margin-top:8px;">
              <span class="warn">Comportament:</span>
              All = fƒÉrƒÉ filtru. Debifezi All ‚Üí ‚ÄúNone selected‚Äù (nu trece nimic p√¢nƒÉ bifezi grupuri).
            </div>
          </div>

          <div class="meta" style="margin: 10px 0 8px;">Rezultate</div>
          <div class="list" id="results"></div>
          <div class="meta" id="resultsHint" style="margin-top:8px;"></div>
        </div>

        <!-- RIGHT -->
        <div>
          <div class="panel">
            <div class="meta" style="margin-bottom:8px;">Op»õiuni export (pentru compatibilitate √Æn aplica»õii IPTV)</div>

            <div class="row">
              <label class="row" style="gap:8px;">
                <input id="forceTs" type="checkbox" checked />
                <span>Force .ts dacƒÉ lipse»ôte extensia</span>
              </label>
            </div>

            <div class="row" style="margin-top:6px;">
              <label class="row" style="gap:8px;">
                <input id="forceM3u8" type="checkbox" />
                <span>Force .m3u8 dacƒÉ lipse»ôte extensia</span>
              </label>
            </div>

            <div class="meta small" style="margin-top:8px;">
              DacƒÉ bifezi ambele, are prioritate <b>.m3u8</b>. (Po»õi lƒÉsa doar TS.)
            </div>

            <hr style="opacity:.25; margin: 12px 0;">

            <div class="row">
              <label class="row" style="gap:8px;">
                <input id="addUA" type="checkbox" />
                <span>AdaugƒÉ User-Agent (EXTVLCOPT)</span>
              </label>
            </div>
            <input id="uaValue" type="text" placeholder="ex: VLC/3.0.20 LibVLC/3.0.20" style="margin-top:6px;" />

            <div class="row" style="margin-top:10px;">
              <label class="row" style="gap:8px;">
                <input id="addRef" type="checkbox" />
                <span>AdaugƒÉ Referrer (EXTVLCOPT)</span>
              </label>
            </div>
            <input id="refValue" type="text" placeholder="ex: http://site.tld/" style="margin-top:6px;" />

            <div class="meta small" style="margin-top:10px;">
              Unele aplica»õii ignorƒÉ EXTVLCOPT. DacƒÉ merge pe Xtream dar nu pe M3U, acest hack uneori ajutƒÉ.
            </div>
          </div>

          <div class="panel" style="margin-top:12px;">
            <div class="meta" style="margin-bottom:8px;">Editare intrare</div>

            <div class="grid2">
              <div>
                <div class="meta">Title</div>
                <input id="eTitle" type="text" />
              </div>
              <div>
                <div class="meta">Group</div>
                <input id="eGroup" type="text" />
              </div>
            </div>

            <div style="margin-top:10px;">
              <div class="meta">URL</div>
              <input id="eUrl" type="text" />
            </div>

            <div class="row" style="margin-top:10px;">
              <button id="save" disabled>üíæ Save</button>
              <button id="duplicate" disabled>‚éò Duplicate</button>
              <button id="remove" disabled>üóë Delete</button>
              <button id="clearSel" disabled>Clear selection</button>
            </div>

            <div class="meta small" style="margin-top:10px;">
              NotƒÉ: acest editor exportƒÉ format simplu (#EXTINF + URL + headere ‚Äú##### GROUP #####‚Äù).
              DacƒÉ vrei export <span class="ok">lossless</span> (cu tvg-logo, tvg-id etc.), pot extinde.
            </div>
          </div>

          <div class="panel" style="margin-top:12px;">
            <div class="meta" style="margin-bottom:8px;">Test rapid (diagnostic)</div>
            <div class="meta small">
              DacƒÉ aplica»õia √Æ»õi ‚Äú√ÆncarcƒÉ M3U‚Äù dar nu redƒÉ:
              √ÆncearcƒÉ export cu <b>Force .ts</b> ON »ôi, dacƒÉ tot nu, √ÆncearcƒÉ »ôi cu User-Agent.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (s) => document.querySelector(s);

  const el = {
    file: $("#file"),
    exportAll: $("#exportAll"),
    exportResults: $("#exportResults"),
    status: $("#status"),
    bar: $("#bar"),
    stats: $("#stats"),
    groupsCount: $("#groupsCount"),
    groupState: $("#groupState"),

    q: $("#q"),
    limit: $("#limit"),
    minChars: $("#minChars"),

    groupQ: $("#groupQ"),
    allGroups: $("#allGroups"),
    selectNone: $("#selectNone"),
    selectAll: $("#selectAll"),
    groupBox: $("#groupBox"),

    results: $("#results"),
    resultsHint: $("#resultsHint"),

    forceTs: $("#forceTs"),
    forceM3u8: $("#forceM3u8"),
    addUA: $("#addUA"),
    uaValue: $("#uaValue"),
    addRef: $("#addRef"),
    refValue: $("#refValue"),

    eTitle: $("#eTitle"),
    eGroup: $("#eGroup"),
    eUrl: $("#eUrl"),
    save: $("#save"),
    duplicate: $("#duplicate"),
    remove: $("#remove"),
    clearSel: $("#clearSel"),
  };

  /** @typedef {{title:string,url:string,group:string}} Entry */

  // ----- State -----
  /** @type {Entry[]} */
  let entries = [];
  /** groupName -> count */
  let groupCounts = new Map();
  /** @type {number[]} */
  let viewIdx = [];
  let selectedIndex = -1;

  /**
   * groupMode:
   *  - "all": nu aplicƒÉm filtru de grup (toate incluse)
   *  - "none": nimic selectat -> 0 rezultate
   *  - "some": doar grupurile din selectedGroups
   */
  let groupMode = "all";
  /** @type {Set<string>} */
  let selectedGroups = new Set();

  const HEADER_RE = /^\s*#+\s*(.*?)\s*#+\s*$/; // ##### GROUP #####
  const YIELD_EVERY = 8000;
  const GROUP_UI_MAX = 600;
  const SEARCH_DEBOUNCE_MS = 220;

  function setStatus(t){ el.status.textContent = t; }
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function getLimit(){ return parseInt(el.limit.value, 10) || 500; }
  function getMinChars(){ return parseInt(el.minChars.value, 10) || 2; }

  function groupStateLabel(){
    if (groupMode === "all") return "All";
    if (groupMode === "none") return "None";
    return `${selectedGroups.size} selected`;
  }

  function syncHeaderPills(){
    el.groupsCount.textContent = `${groupCounts.size.toLocaleString("ro-RO")} groups`;
    el.groupState.textContent = groupStateLabel();
    el.allGroups.checked = (groupMode === "all");
  }

  function passesGroupFilter(entry){
    if (groupMode === "all") return true;
    if (groupMode === "none") return false;
    return selectedGroups.has(entry.group);
  }

  // ----- Streaming parse -----
  async function loadFileStreaming(file){
    entries = [];
    groupCounts = new Map();
    viewIdx = [];
    clearSelection(true);

    groupMode = "all";
    selectedGroups = new Set();

    el.bar.style.width = "0%";
    el.results.innerHTML = "";
    el.resultsHint.textContent = "";
    syncHeaderPills();

    setStatus(`Parsing ${file.name}...`);

    const decoder = new TextDecoder("utf-8", { fatal:false });
    const reader = file.stream().getReader();
    const total = file.size;
    let read = 0;

    let buffer = "";
    let pendingTitle = "";
    let currentGroup = "Ungrouped";

    while (true){
      const { value, done } = await reader.read();
      if (done) break;

      read += value.byteLength;
      buffer += decoder.decode(value, { stream:true });

      let nl;
      while ((nl = buffer.indexOf("\n")) !== -1){
        const raw = buffer.slice(0, nl);
        buffer = buffer.slice(nl + 1);

        const line = raw.replace(/\r/g,"").trim();
        if (!line) continue;

        if (line.startsWith("#EXTINF:")){
          const comma = line.indexOf(",");
          pendingTitle = (comma !== -1) ? line.slice(comma + 1).trim() : "";
          continue;
        }
        if (line.startsWith("#")) continue;

        const m = pendingTitle.match(HEADER_RE);
        if (m){
          const g = (m[1] || "").trim();
          if (g) currentGroup = g;
          pendingTitle = "";
          continue;
        }

        const entry = {
          title: pendingTitle || line,
          url: line,
          group: currentGroup || "Ungrouped"
        };
        entries.push(entry);
        groupCounts.set(entry.group, (groupCounts.get(entry.group) || 0) + 1);
        pendingTitle = "";

        if (entries.length % YIELD_EVERY === 0){
          const pct = Math.min(100, Math.round((read / total) * 100));
          el.bar.style.width = pct + "%";
          el.stats.textContent = `${entries.length.toLocaleString("ro-RO")} entries`;
          syncHeaderPills();
          setStatus(`Parsing... ${pct}%`);
          await new Promise(r => setTimeout(r, 0));
        }
      }
    }

    buffer += decoder.decode();
    el.bar.style.width = "100%";
    el.stats.textContent = `${entries.length.toLocaleString("ro-RO")} entries`;
    syncHeaderPills();

    setStatus(`Gata: ${file.name} ¬∑ ${entries.length.toLocaleString("ro-RO")} intrƒÉri ¬∑ ${groupCounts.size.toLocaleString("ro-RO")} groups`);

    renderGroupBox();
    buildAndRenderResults();

    el.exportAll.disabled = (entries.length === 0);
  }

  // ----- Group UI -----
  function renderGroupBox(){
    const q = (el.groupQ.value || "").trim().toLowerCase();
    const names = Array.from(groupCounts.keys()).sort((a,b)=>a.localeCompare(b));

    el.groupBox.innerHTML = "";
    let shown = 0;

    for (const g of names){
      if (q && !g.toLowerCase().includes(q)) continue;
      shown++;
      if (shown > GROUP_UI_MAX) break;

      const count = groupCounts.get(g) || 0;
      let checked = false;
      if (groupMode === "all") checked = true;
      else if (groupMode === "none") checked = false;
      else checked = selectedGroups.has(g);

      const row = document.createElement("div");
      row.className = "gRow";
      row.innerHTML = `
        <div><input type="checkbox" /></div>
        <div><div class="gTitle">${esc(g)} <span class="pill">${count}</span></div></div>
      `;
      const cb = row.querySelector("input");
      cb.checked = checked;

      cb.addEventListener("change", () => onToggleGroup(g, cb.checked));
      el.groupBox.appendChild(row);
    }

    if (shown >= GROUP_UI_MAX){
      const hint = document.createElement("div");
      hint.className = "meta";
      hint.style.padding = "8px 10px";
      hint.textContent = `Afi»ôez max ${GROUP_UI_MAX} grupuri. Folose»ôte filtrul de grupuri pentru restul.`;
      el.groupBox.appendChild(hint);
    }
  }

  function onToggleGroup(groupName, isChecked){
    // logic curat:
    // - all + debifezi un grup => some = toate minus acel grup
    // - none + bifezi => some = {grup}
    // - some => add/remove; dacƒÉ 0 => none; dacƒÉ toate => all
    if (groupMode === "all"){
      if (isChecked) return;
      groupMode = "some";
      selectedGroups = new Set(groupCounts.keys());
      selectedGroups.delete(groupName);
      if (selectedGroups.size === 0) groupMode = "none";
    } else if (groupMode === "none"){
      if (!isChecked) return;
      groupMode = "some";
      selectedGroups = new Set([groupName]);
    } else {
      if (isChecked) selectedGroups.add(groupName);
      else selectedGroups.delete(groupName);

      if (selectedGroups.size === 0){
        groupMode = "none";
      } else if (selectedGroups.size === groupCounts.size){
        groupMode = "all";
        selectedGroups.clear();
      }
    }

    syncHeaderPills();
    renderGroupBox();
    scheduleRebuildResults();
  }

  function setGroupModeAll(){
    groupMode = "all";
    selectedGroups.clear();
    syncHeaderPills();
    renderGroupBox();
    scheduleRebuildResults();
  }

  function setGroupModeNone(){
    groupMode = "none";
    selectedGroups.clear();
    syncHeaderPills();
    renderGroupBox();
    scheduleRebuildResults();
  }

  function onAllGroupsChanged(){
    if (el.allGroups.checked) setGroupModeAll();
    else setGroupModeNone();
  }

  // ----- Results -----
  function buildViewIndexes(){
    viewIdx = [];
    const q = (el.q.value || "").trim().toLowerCase();
    const hasQuery = q.length > 0;
    const min = getMinChars();
    const lim = getLimit();

    if (entries.length === 0) return;
    if (groupMode === "none") return;

    // UX: dacƒÉ nu ai query »ôi e»ôti pe "all", nu scana (fi»ôier mare)
    if (!hasQuery && groupMode === "all") return;

    // dacƒÉ e»ôti pe "all", cerem query minim
    if (groupMode === "all" && hasQuery && q.length < min) return;

    for (let i = 0; i < entries.length; i++){
      const e = entries[i];
      if (!passesGroupFilter(e)) continue;

      if (hasQuery){
        const hay = (e.title + " " + e.url + " " + e.group).toLowerCase();
        if (!hay.includes(q)) continue;
      }

      viewIdx.push(i);
      if (viewIdx.length >= lim) break;
    }
  }

  function renderResults(){
    el.results.innerHTML = "";
    el.exportResults.disabled = true;

    if (entries.length === 0){
      el.results.innerHTML = `<div class="item"><div class="idx">‚Äî</div><div><div class="title">Nimic √ÆncƒÉrcat</div><div class="sub">√éncarcƒÉ un .m3u/.m3u8</div></div></div>`;
      el.resultsHint.textContent = "";
      return;
    }

    const q = (el.q.value || "").trim();
    const min = getMinChars();

    if (groupMode === "none"){
      el.results.innerHTML = `<div class="item"><div class="idx">‚ÑπÔ∏è</div><div><div class="title">None selected</div><div class="sub">BifeazƒÉ grupuri sau activeazƒÉ All.</div></div></div>`;
      el.resultsHint.textContent = "";
      return;
    }

    if (groupMode === "all" && q.length < min){
      el.results.innerHTML = `<div class="item"><div class="idx">‚ÑπÔ∏è</div><div><div class="title">Scrie minim ${min} caractere</div><div class="sub">Playlist mare: evitƒÉm scanarea fƒÉrƒÉ query sau filtru de grup.</div></div></div>`;
      el.resultsHint.textContent = "";
      return;
    }

    if (viewIdx.length === 0){
      el.results.innerHTML = `<div class="item"><div class="idx">‚Äî</div><div><div class="title">Niciun rezultat</div><div class="sub">SchimbƒÉ cƒÉutarea sau grupurile.</div></div></div>`;
      el.resultsHint.textContent = "";
      return;
    }

    for (const i of viewIdx){
      const e = entries[i];
      const div = document.createElement("div");
      div.className = "item" + (i === selectedIndex ? " active" : "");
      div.innerHTML = `
        <div class="idx">#${i+1}</div>
        <div>
          <div class="title">${esc(e.title)}</div>
          <div class="sub">${esc(e.group)} ¬∑ ${esc(e.url)}</div>
        </div>
      `;
      div.addEventListener("click", () => selectEntry(i));
      el.results.appendChild(div);
    }

    el.exportResults.disabled = false;
    el.resultsHint.textContent = `Rezultate: ${viewIdx.length} (limit ${getLimit()}) ¬∑ Group: ${groupStateLabel()}`;
  }

  function buildAndRenderResults(){
    buildViewIndexes();
    renderResults();
  }

  // ----- Selection / Editor -----
  function clearSelection(skipRender){
    selectedIndex = -1;
    el.eTitle.value = "";
    el.eGroup.value = "";
    el.eUrl.value = "";

    el.save.disabled = true;
    el.duplicate.disabled = true;
    el.remove.disabled = true;
    el.clearSel.disabled = true;

    if (!skipRender) renderResults();
  }

  function selectEntry(i){
    selectedIndex = i;
    const e = entries[i];
    el.eTitle.value = e.title;
    el.eGroup.value = e.group;
    el.eUrl.value = e.url;

    el.save.disabled = false;
    el.duplicate.disabled = false;
    el.remove.disabled = false;
    el.clearSel.disabled = false;

    renderResults();
  }

  function saveSelected(){
    if (selectedIndex < 0) return;
    const url = (el.eUrl.value || "").trim();
    if (!url) { alert("URL lipsƒÉ."); return; }

    const title = (el.eTitle.value || "").trim() || url;
    const group = (el.eGroup.value || "").trim() || "Ungrouped";

    const oldGroup = entries[selectedIndex].group;
    entries[selectedIndex] = { title, url, group };

    if (oldGroup !== group){
      groupCounts.set(oldGroup, Math.max(0, (groupCounts.get(oldGroup) || 1) - 1));
      if ((groupCounts.get(oldGroup) || 0) === 0) groupCounts.delete(oldGroup);
      groupCounts.set(group, (groupCounts.get(group) || 0) + 1);

      // dacƒÉ e»ôti √Æn "some" »ôi ai schimbat group-ul, nu schimbƒÉm selec»õia automat
      syncHeaderPills();
      renderGroupBox();
    }

    setStatus("Salvat.");
    scheduleRebuildResults();
  }

  function duplicateSelected(){
    if (selectedIndex < 0) return;
    const copy = { ...entries[selectedIndex] };
    entries.splice(selectedIndex + 1, 0, copy);
    groupCounts.set(copy.group, (groupCounts.get(copy.group) || 0) + 1);

    setStatus("Duplicat.");
    syncHeaderPills();
    renderGroupBox();

    selectEntry(selectedIndex + 1);
    scheduleRebuildResults();
  }

  function deleteSelected(){
    if (selectedIndex < 0) return;
    if (!confirm("»òtergi intrarea selectatƒÉ?")) return;

    const g = entries[selectedIndex].group;
    entries.splice(selectedIndex, 1);

    groupCounts.set(g, Math.max(0, (groupCounts.get(g) || 1) - 1));
    if ((groupCounts.get(g) || 0) === 0) groupCounts.delete(g);

    setStatus("»òters.");
    syncHeaderPills();
    renderGroupBox();

    clearSelection(true);
    scheduleRebuildResults();
  }

  // ----- Export helpers -----
  function normalizeUrl(url){
    // pƒÉstreazƒÉ querystring intact
    const parts = url.split("?");
    const base = parts[0];
    const qs = parts.length > 1 ? "?" + parts.slice(1).join("?") : "";

    const lower = base.toLowerCase();

    const hasKnownExt =
      lower.endsWith(".ts") || lower.endsWith(".m3u8") ||
      lower.endsWith(".mp4") || lower.endsWith(".webm") ||
      lower.endsWith(".mp3") || lower.endsWith(".aac") ||
      lower.endsWith(".m4a") || lower.endsWith(".ogg") ||
      lower.endsWith(".wav") || lower.endsWith(".flac");

    if (hasKnownExt) return base + qs;

    // dacƒÉ nu are extensie:
    if (el.forceM3u8.checked) return base + ".m3u8" + qs;
    if (el.forceTs.checked) return base + ".ts" + qs;

    return base + qs;
  }

  function maybeVlcOptsLines(){
    const lines = [];
    if (el.addUA.checked){
      const ua = (el.uaValue.value || "").trim();
      if (ua) lines.push(`#EXTVLCOPT:http-user-agent=${ua}`);
    }
    if (el.addRef.checked){
      const ref = (el.refValue.value || "").trim();
      if (ref) lines.push(`#EXTVLCOPT:http-referrer=${ref}`);
    }
    return lines;
  }

  function toM3U(list){
    // format simplu:
    // #EXTM3U
    // #EXTINF:-1,##### GROUP #####
    // #
    // (op»õional EXTVLCOPT)
    // #EXTINF:-1,Title
    // URL (normalizat)
    let out = "#EXTM3U\n";
    let lastGroup = null;

    const vlcOptLines = maybeVlcOptsLines();

    for (const e of list){
      const g = (e.group || "Ungrouped").trim() || "Ungrouped";
      if (g !== lastGroup){
        out += `#EXTINF:-1,##### ${g} #####\n`;
        out += `#\n`;
        lastGroup = g;
      }

      // op»õiuni VLC √Ænainte de item (unii clien»õi cer exact aici)
      for (const l of vlcOptLines) out += l + "\n";

      const title = (e.title || "").trim() || e.url;
      out += `#EXTINF:-1,${title}\n`;
      out += `${normalizeUrl(e.url)}\n`;
    }
    return out;
  }

  function exportAll(){
    const m3u = toM3U(entries);
    const name = "edited.m3u";
    const mime = "audio/x-mpegurl";
    const blob = new Blob([m3u], {type:mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  }

  function exportResults(){
    const subset = viewIdx.map(i => entries[i]);
    const m3u = toM3U(subset);
    const name = "results.m3u";
    const mime = "audio/x-mpegurl";
    const blob = new Blob([m3u], {type:mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  }

  // ----- Debounce -----
  let t = null;
  function scheduleRebuildResults(){
    clearTimeout(t);
    t = setTimeout(buildAndRenderResults, SEARCH_DEBOUNCE_MS);
  }

  // ----- Wire events -----
  el.file.addEventListener("change", async () => {
    const f = el.file.files?.[0];
    if (!f) return;
    await loadFileStreaming(f);
  });

  el.q.addEventListener("input", scheduleRebuildResults);
  el.limit.addEventListener("change", scheduleRebuildResults);
  el.minChars.addEventListener("change", scheduleRebuildResults);

  el.groupQ.addEventListener("input", () => renderGroupBox());
  el.allGroups.addEventListener("change", onAllGroupsChanged);
  el.selectNone.addEventListener("click", setGroupModeNone);
  el.selectAll.addEventListener("click", setGroupModeAll);

  el.save.addEventListener("click", saveSelected);
  el.duplicate.addEventListener("click", duplicateSelected);
  el.remove.addEventListener("click", deleteSelected);
  el.clearSel.addEventListener("click", () => clearSelection(false));

  el.exportAll.addEventListener("click", exportAll);
  el.exportResults.addEventListener("click", exportResults);

  // c√¢nd schimbi op»õiuni export, nu e nevoie sƒÉ regenerezi rezultate; doar exportul se schimbƒÉ.
  // (nimic de fƒÉcut)

  // init
  el.stats.textContent = "0 entries";
  syncHeaderPills();
  renderGroupBox();
  renderResults();

})();
</script>
</body>
</html>
