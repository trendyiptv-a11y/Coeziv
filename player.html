<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M3U Mega Player (Audio + Video)</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; }
    .wrap { max-width: 1150px; margin: 0 auto; padding: 16px; }
    .card { border: 1px solid rgba(127,127,127,.25); border-radius: 16px; padding: 14px; }
    h1 { margin: 0 0 10px; font-size: 1.1rem; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="file"] { max-width: 100%; }
    input[type="text"] {
      flex: 1 1 320px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.35);
      background: transparent;
    }
    button, select {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.35);
      background: transparent;
      cursor: pointer;
    }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .meta { font-size:.9rem; opacity:.8; }
    .pill { display:inline-block; padding: 2px 8px; border: 1px solid rgba(127,127,127,.35); border-radius: 999px; font-size:.8rem; opacity:.9; }
    .split { display:grid; grid-template-columns: 1.05fr .95fr; gap: 12px; margin-top: 12px; }
    @media (max-width: 940px){ .split{ grid-template-columns: 1fr; } }

    .list { max-height: 520px; overflow:auto; border-radius: 14px; border: 1px solid rgba(127,127,127,.25); }
    .item {
      display:grid;
      grid-template-columns: 64px 1fr 120px;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(127,127,127,.14);
      cursor:pointer;
    }
    .item:last-child{ border-bottom:none; }
    .item.active { outline: 2px solid rgba(255,170,0,.6); outline-offset:-2px; }
    .idx { opacity:.7; font-variant-numeric: tabular-nums; }
    .title { font-weight: 650; }
    .url { font-size:.84rem; opacity:.75; word-break: break-all; }
    .right { text-align:right; font-size:.84rem; opacity:.85; }
    .tag { display:inline-block; padding: 1px 8px; border: 1px solid rgba(127,127,127,.35); border-radius: 999px; font-size:.75rem; margin-left: 6px; opacity:.9; }

    .playerBox { display:grid; gap: 10px; }
    audio, video { width: 100%; border-radius: 12px; }
    .kv { display:grid; gap: 6px; font-size: .9rem; }
    .kv div { display:flex; gap:8px; align-items:baseline; }
    .kv b { min-width: 92px; opacity:.9; }
    .warn { color: #c98000; }

    .progress { height: 10px; border-radius: 999px; border: 1px solid rgba(127,127,127,.25); overflow:hidden; }
    .bar { height: 100%; width: 0%; background: rgba(255,170,0,.55); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>M3U Mega Player ‚Äî optimizat pentru playlist-uri uria»ôe (Audio + Video)</h1>

      <div class="row">
        <input id="file" type="file" accept=".m3u,.m3u8,text/plain,audio/x-mpegurl,application/vnd.apple.mpegurl" />
        <button id="stop" disabled>‚èπ Stop</button>
        <button id="open" disabled>‚Üó Open tab</button>
        <button id="copy" disabled>üìã Copy URL</button>

        <select id="mode" title="Audio vs Video">
          <option value="auto">Auto</option>
          <option value="audio">For»õeazƒÉ Audio</option>
          <option value="video">For»õeazƒÉ Video</option>
        </select>

        <span class="meta" id="status">√éncarcƒÉ fi»ôierul .m3u (stream parsing, fƒÉrƒÉ freeze).</span>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="progress" style="flex:1 1 360px;">
          <div class="bar" id="bar"></div>
        </div>
        <span class="pill" id="stats">0 intrƒÉri</span>
        <span class="pill" id="now">Nimic redat</span>
      </div>

      <div class="row" style="margin-top:10px;">
        <input id="q" type="text" placeholder="CautƒÉ (titlu / url / group) ‚Äî cautƒÉ √Æn indexul din RAM" />
        <select id="groupSel" title="Sari la group (din ##### ... #####)" style="min-width:220px;">
          <option value="__all__">All groups</option>
        </select>

        <select id="filterType" title="Filtru tip media">
          <option value="all">All</option>
          <option value="audio">Audio</option>
          <option value="video">Video</option>
          <option value="hls">HLS (.m3u8)</option>
        </select>

        <select id="pageSize" title="C√¢te rezultate afi»ôƒÉm pe paginƒÉ">
          <option value="50">50 / page</option>
          <option value="100" selected>100 / page</option>
          <option value="200">200 / page</option>
        </select>

        <button id="prevPage" disabled>‚óÄ Page</button>
        <button id="nextPage" disabled>Page ‚ñ∂</button>
      </div>

      <div class="split">
        <div>
          <div class="meta" style="margin: 6px 0 8px;">
            ListƒÉ rezultate (randeazƒÉ doar o paginƒÉ, ca sƒÉ nu moarƒÉ DOM-ul)
          </div>
          <div class="list" id="list"></div>
          <div class="meta" id="listHint" style="margin-top:8px;">
            NotƒÉ: pentru playlist-uri cu CORS/tokens, redarea poate e»ôua √Æn paginƒÉ ‚Üí folose»ôte <span class="pill">Open tab</span>.
          </div>
        </div>

        <div class="playerBox">
          <div class="meta">Player</div>
          <audio id="audio" controls></audio>
          <video id="video" controls playsinline style="display:none"></video>

          <div class="kv">
            <div><b>Titlu</b><span id="mTitle">‚Äî</span></div>
            <div><b>Group</b><span id="mGroup">‚Äî</span></div>
            <div><b>Tip</b><span id="mType">‚Äî</span></div>
            <div><b>DuratƒÉ</b><span id="mDur">‚Äî</span></div>
            <div><b>Video</b><span id="mDims">‚Äî</span></div>
          </div>

          <div class="meta" id="hint">
            DacƒÉ un stream nu porne»ôte: probabil CORS/headers/tokens. Browserul nu permite setarea de User-Agent/Referer din JS.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <script>
    const $ = (s) => document.querySelector(s);

    // UI
    const el = {
      file: $("#file"),
      status: $("#status"),
      bar: $("#bar"),
      stats: $("#stats"),
      now: $("#now"),
      q: $("#q"),
      groupSel: $("#groupSel"),
      filterType: $("#filterType"),
      pageSize: $("#pageSize"),
      prevPage: $("#prevPage"),
      nextPage: $("#nextPage"),
      list: $("#list"),
      listHint: $("#listHint"),

      mode: $("#mode"),
      stop: $("#stop"),
      open: $("#open"),
      copy: $("#copy"),

      audio: $("#audio"),
      video: $("#video"),
      mTitle: $("#mTitle"),
      mGroup: $("#mGroup"),
      mType: $("#mType"),
      mDur: $("#mDur"),
      mDims: $("#mDims"),
      hint: $("#hint"),
    };

    // State
    let entries = [];      // {title,url,group,type,meta:{duration,w,h}}
    let current = -1;

    // index / view
    let matchIdx = [];     // listƒÉ de indexe √Æn entries dupƒÉ filtrare
    let page = 0;
    const MAX_MATCHES = 5000; // ca sƒÉ nu faci query care √Ænghea»õƒÉ
    const DEBOUNCE_MS = 220;

    // groups from ##### ... ##### markers
    // groupName -> firstEntryIndex
    let groups = new Map();

    let hls = null;
    function destroyHls(){ if (hls){ try{ hls.destroy(); }catch{} } hls = null; }

    function stripQuery(url){ return (url || "").split("?")[0].toLowerCase(); }
    function isHls(url){
      const u = stripQuery(url);
      return u.endsWith(".m3u8") || u.includes("m3u8");
    }
    function isVideoFile(url){
      const u = stripQuery(url);
      return u.endsWith(".mp4") || u.endsWith(".webm") || u.endsWith(".mov") || u.endsWith(".mkv") || u.endsWith(".m4v");
    }
    function isAudioFile(url){
      const u = stripQuery(url);
      return u.endsWith(".mp3") || u.endsWith(".aac") || u.endsWith(".m4a") || u.endsWith(".ogg") || u.endsWith(".wav") || u.endsWith(".flac");
    }
    function inferType(e){
      if (isHls(e.url)) return "hls";
      if (isVideoFile(e.url)) return "video";
      if (isAudioFile(e.url)) return "audio";
      return "other";
    }
    function preferMedia(url){
      const m = el.mode.value;
      if (m === "audio") return "audio";
      if (m === "video") return "video";
      // auto:
      if (isHls(url) || isVideoFile(url)) return "video";
      return "audio";
    }
    function setPlayerVisibility(useVideo){
      el.video.style.display = useVideo ? "" : "none";
      el.audio.style.display = useVideo ? "none" : "";
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function formatTime(sec){
      if (!Number.isFinite(sec)) return "‚Äî";
      const s = Math.max(0, Math.floor(sec));
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const r = s % 60;
      if (h > 0) return `${h}:${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
      return `${m}:${String(r).padStart(2,"0")}`;
    }

    function setMetaPanel(e){
      el.mTitle.textContent = e?.title || "‚Äî";
      el.mGroup.textContent = e?.group || "‚Äî";
      el.mType.textContent = e?.type || "‚Äî";
      el.mDur.textContent = e?.meta?.duration ? formatTime(e.meta.duration) : "‚Äî";
      if (e?.meta?.w && e?.meta?.h) el.mDims.textContent = `${e.meta.w}√ó${e.meta.h}`;
      else el.mDims.textContent = "‚Äî";
    }

    function playUrl(url){
      destroyHls();
      const pref = preferMedia(url);
      const hlsNeeded = isHls(url);

      if (pref === "video"){
        setPlayerVisibility(true);

        if (hlsNeeded && window.Hls && window.Hls.isSupported()){
          hls = new Hls({ lowLatencyMode: true });
          hls.loadSource(url);
          hls.attachMedia(el.video);
          el.video.play().catch(()=>{});
          return;
        }

        el.video.src = url; // Safari HLS nativ sau video direct
        el.video.play().catch(()=>{});
        return;
      }

      setPlayerVisibility(false);
      el.audio.src = url;
      el.audio.play().catch(()=>{});
    }

    function selectAndPlay(entryIndex){
      if (entryIndex < 0 || entryIndex >= entries.length) return;
      current = entryIndex;
      const e = entries[current];

      el.now.textContent = `Redau: ${e.title}`;
      setMetaPanel(e);

      playUrl(e.url);

      el.stop.disabled = false;
      el.open.disabled = false;
      el.copy.disabled = false;

      renderPage(); // ca sƒÉ marcheze active
    }

    function stop(){
      destroyHls();
      el.audio.pause(); el.video.pause();
      el.audio.removeAttribute("src"); el.video.removeAttribute("src");
      el.now.textContent = "Oprit";
      setMetaPanel(null);

      el.stop.disabled = true;
      el.open.disabled = true;
      el.copy.disabled = true;
    }

    // --- Rendering paginat ---
    function getPageSize(){ return parseInt(el.pageSize.value, 10) || 100; }

    function renderPage(){
      const size = getPageSize();
      const total = matchIdx.length;
      const pages = Math.max(1, Math.ceil(total / size));
      if (page >= pages) page = pages - 1;
      if (page < 0) page = 0;

      el.prevPage.disabled = (page <= 0);
      el.nextPage.disabled = (page >= pages - 1);

      el.list.innerHTML = "";
      if (!total){
        el.list.innerHTML = `<div class="item">
          <div class="idx">‚Äî</div>
          <div>
            <div class="title">Niciun rezultat</div>
            <div class="url">√éncearcƒÉ alt text / alt group / alt filtru.</div>
          </div>
          <div class="right"></div>
        </div>`;
        el.listHint.innerHTML = `CƒÉutarea e limitatƒÉ la <span class="pill">${MAX_MATCHES}</span> rezultate max pentru performan»õƒÉ.`;
        return;
      }

      const start = page * size;
      const end = Math.min(total, start + size);

      for (let k = start; k < end; k++){
        const i = matchIdx[k];
        const e = entries[i];
        const div = document.createElement("div");
        div.className = "item" + (i === current ? " active" : "");
        div.innerHTML = `
          <div class="idx">#${i+1}</div>
          <div>
            <div class="title">${esc(e.title)}<span class="tag">${esc(e.type.toUpperCase())}</span></div>
            <div class="url">${esc(e.url)}</div>
          </div>
          <div class="right">${esc(e.group || "")}</div>
        `;
        div.addEventListener("click", () => selectAndPlay(i));
        el.list.appendChild(div);
      }

      el.listHint.innerHTML =
        `Rezultate: <span class="pill">${total}</span> ¬∑ Pagina <span class="pill">${page+1}/${pages}</span> (afi»ôez ${start+1}-${end})`;
    }

    // --- Filtrare / cƒÉutare ---
    function passesTypeFilter(e){
      const f = el.filterType.value;
      if (f === "all") return true;
      if (f === "hls") return e.type === "hls";
      return e.type === f;
    }

    function passesGroupFilter(e){
      const g = el.groupSel.value;
      if (!g || g === "__all__") return true;
      return e.group === g;
    }

    function buildMatches(){
      const q = el.q.value.trim().toLowerCase();
      matchIdx = [];

      // pentru performan»õƒÉ: parcurgem o singurƒÉ datƒÉ, oprim la MAX_MATCHES
      for (let i = 0; i < entries.length; i++){
        const e = entries[i];
        if (!passesTypeFilter(e)) continue;
        if (!passesGroupFilter(e)) continue;

        if (q){
          const hay = (e.title + " " + e.url + " " + (e.group || "")).toLowerCase();
          if (!hay.includes(q)) continue;
        }

        matchIdx.push(i);
        if (matchIdx.length >= MAX_MATCHES) break;
      }

      page = 0;
      renderPage();
    }

    let debounceTimer = null;
    function debounceRebuild(){
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(buildMatches, DEBOUNCE_MS);
    }

    // --- Grupuri (din ##### ... #####) ---
    function rebuildGroupSelect(){
      el.groupSel.innerHTML = `<option value="__all__">All groups</option>`;
      for (const [g] of groups){
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        el.groupSel.appendChild(opt);
      }
    }

    // --- M3U streaming parser (File.stream + TextDecoder) ---
    // DetectƒÉm ‚Äúheader group‚Äù: ##### NAME #####
    const headerRe = /^\s*#+\s*(.*?)\s*#+\s*$/;

    async function parseFileStreaming(file){
      entries = [];
      groups = new Map();
      matchIdx = [];
      page = 0;
      current = -1;
      stop();

      el.status.textContent = `Citesc: ${file.name} (streaming) ...`;
      el.stats.textContent = `0 intrƒÉri`;
      el.bar.style.width = "0%";

      const totalBytes = file.size;
      let readBytes = 0;

      const decoder = new TextDecoder("utf-8", { fatal:false });
      const reader = file.stream().getReader();

      let buffer = "";
      let pendingTitle = "";
      let currentGroup = "";

      // parse line-by-line din chunk-uri
      while (true){
        const { value, done } = await reader.read();
        if (done) break;

        readBytes += value.byteLength;
        buffer += decoder.decode(value, { stream:true });

        // extrage linii complete
        let idx;
        while ((idx = buffer.indexOf("\n")) !== -1){
          const lineRaw = buffer.slice(0, idx);
          buffer = buffer.slice(idx + 1);

          const line = lineRaw.replace(/\r/g,"").trim();
          if (!line) continue;

          if (line.startsWith("#EXTINF:")){
            // #EXTINF:-1,Title
            const comma = line.indexOf(",");
            pendingTitle = (comma !== -1) ? line.slice(comma + 1).trim() : "";
            continue;
          }

          if (line.startsWith("#")) continue;

          // URL
          // dacƒÉ titlul e de forma ##### ... ##### => tratƒÉm ca group marker »ôi NU adƒÉugƒÉm intrare
          const m = pendingTitle.match(headerRe);
          if (m){
            const g = (m[1] || "").trim();
            if (g){
              currentGroup = g;
              if (!groups.has(g)) groups.set(g, entries.length);
            }
            pendingTitle = "";
            continue;
          }

          const title = pendingTitle || line;
          const e = {
            title,
            url: line,
            group: currentGroup || "Ungrouped",
            type: "other",
            meta: { duration:null, w:null, h:null }
          };
          e.type = inferType(e);

          entries.push(e);
          pendingTitle = "";

          // update UI (rar, ca sƒÉ nu √ÆncetineascƒÉ)
          if ((entries.length % 5000) === 0){
            const pct = Math.min(100, Math.round((readBytes / totalBytes) * 100));
            el.bar.style.width = pct + "%";
            el.stats.textContent = `${entries.length.toLocaleString("ro-RO")} intrƒÉri`;
            el.status.textContent = `Parsing... ${pct}%`;
            await new Promise(r => setTimeout(r, 0)); // yield
          }
        }
      }

      // flush final decode
      buffer += decoder.decode();
      // nu mai procesƒÉm ultima linie incompletƒÉ √Æn detaliu (nu e critic pentru M3U)

      el.bar.style.width = "100%";
      el.stats.textContent = `${entries.length.toLocaleString("ro-RO")} intrƒÉri`;
      el.status.textContent = `Gata: ${file.name} ¬∑ ${entries.length.toLocaleString("ro-RO")} intrƒÉri ¬∑ ${groups.size} groups`;
      rebuildGroupSelect();
      buildMatches();
    }

    // --- Metadata listeners ---
    el.audio.addEventListener("loadedmetadata", () => {
      if (current < 0) return;
      const e = entries[current];
      if (Number.isFinite(el.audio.duration)) e.meta.duration = el.audio.duration;
      setMetaPanel(e);
      renderPage();
    });
    el.video.addEventListener("loadedmetadata", () => {
      if (current < 0) return;
      const e = entries[current];
      if (Number.isFinite(el.video.duration)) e.meta.duration = el.video.duration;
      if (el.video.videoWidth && el.video.videoHeight){
        e.meta.w = el.video.videoWidth;
        e.meta.h = el.video.videoHeight;
      }
      setMetaPanel(e);
      renderPage();
    });

    el.audio.addEventListener("error", () => {
      el.hint.innerHTML = `<span class="warn">Audio error.</span> Probabil CORS / URL invalid. √éncearcƒÉ <span class="pill">Open tab</span>.`;
    });
    el.video.addEventListener("error", () => {
      el.hint.innerHTML = `<span class="warn">Video error.</span> Probabil CORS / tokens / headers. √éncearcƒÉ <span class="pill">Open tab</span>.`;
    });

    // --- UI events ---
    el.file.addEventListener("change", async () => {
      const f = el.file.files?.[0];
      if (!f) return;
      await parseFileStreaming(f);
    });

    el.q.addEventListener("input", debounceRebuild);
    el.filterType.addEventListener("change", buildMatches);
    el.groupSel.addEventListener("change", () => {
      // dacƒÉ selectezi un group, putem sƒÉ ‚ÄúsƒÉrim‚Äù aproape de √Ænceputul lui (ca UX)
      const g = el.groupSel.value;
      if (g && g !== "__all__" && groups.has(g)){
        // preset: punem search empty »ôi filtrare pe group
        el.q.value = "";
      }
      buildMatches();
    });
    el.pageSize.addEventListener("change", () => { page = 0; renderPage(); });

    el.prevPage.addEventListener("click", () => { page--; renderPage(); });
    el.nextPage.addEventListener("click", () => { page++; renderPage(); });

    el.stop.addEventListener("click", stop);

    el.open.addEventListener("click", () => {
      if (current < 0) return;
      window.open(entries[current].url, "_blank", "noopener,noreferrer");
    });

    el.copy.addEventListener("click", async () => {
      if (current < 0) return;
      const url = entries[current].url;
      try{
        await navigator.clipboard.writeText(url);
        el.status.textContent = "URL copiat.";
      }catch{
        alert(url);
      }
    });

    // enable paging buttons only after matches exist
    const origRenderPage = renderPage;
    renderPage = function(){
      origRenderPage();
      const total = matchIdx.length;
      const size = getPageSize();
      const pages = Math.max(1, Math.ceil(total / size));
      el.prevPage.disabled = (total === 0 || page <= 0);
      el.nextPage.disabled = (total === 0 || page >= pages - 1);
    };

    // click on list hint controls? (no)
  </script>
</body>
</html>
