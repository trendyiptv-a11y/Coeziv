<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M3U Editor (HTML)</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card { border: 1px solid rgba(127,127,127,.25); border-radius: 16px; padding: 14px; }
    h1 { margin: 0 0 10px; font-size: 1.1rem; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="file"] { max-width: 100%; }
    input[type="text"], textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.35);
      background: transparent;
      box-sizing: border-box;
    }
    textarea { min-height: 160px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    button, select {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.35);
      background: transparent;
      cursor: pointer;
    }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .meta { font-size:.9rem; opacity:.8; }
    .pill { display:inline-block; padding: 2px 8px; border: 1px solid rgba(127,127,127,.35); border-radius: 999px; font-size:.8rem; opacity:.9; }

    .split { display:grid; grid-template-columns: 1.05fr .95fr; gap: 12px; margin-top: 12px; }
    @media (max-width: 940px){ .split{ grid-template-columns: 1fr; } }

    .list { max-height: 520px; overflow:auto; border-radius: 14px; border: 1px solid rgba(127,127,127,.25); }
    .item {
      display:grid;
      grid-template-columns: 64px 1fr;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(127,127,127,.14);
      cursor:pointer;
    }
    .item:last-child{ border-bottom:none; }
    .item.active { outline: 2px solid rgba(255,170,0,.6); outline-offset:-2px; }
    .idx { opacity:.7; font-variant-numeric: tabular-nums; }
    .title { font-weight: 650; }
    .sub { font-size:.84rem; opacity:.75; word-break: break-all; }

    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 700px){ .grid2 { grid-template-columns: 1fr; } }

    .warn { color: #c98000; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>M3U Editor (HTML) ‚Äî editeazƒÉ Title / URL / Group »ôi exportƒÉ .m3u</h1>

      <div class="row">
        <input id="file" type="file" accept=".m3u,.m3u8,text/plain,audio/x-mpegurl,application/vnd.apple.mpegurl" />
        <button id="newEmpty">New</button>
        <button id="export" disabled>‚¨á Export .m3u</button>
        <button id="exportSel" disabled>‚¨á Export selection</button>
        <span class="meta" id="status">√éncarcƒÉ un .m3u/.m3u8.</span>
      </div>

      <div class="row" style="margin-top:10px;">
        <input id="q" type="text" placeholder="CautƒÉ (title / url / group) ‚Äî aratƒÉ doar rezultatele cƒÉutƒÉrii" />
        <select id="groupSel" style="min-width:220px;">
          <option value="__all__">All groups</option>
        </select>
        <select id="limit" title="C√¢te rezultate afi»ôƒÉm">
          <option value="100">100 results</option>
          <option value="500" selected>500 results</option>
          <option value="2000">2000 results</option>
          <option value="5000">5000 results</option>
        </select>
        <span class="pill" id="stats">0 entries</span>
      </div>

      <div class="split">
        <div>
          <div class="meta" style="margin: 6px 0 8px;">Rezultate (click pentru editare)</div>
          <div class="list" id="list"></div>
          <div class="meta" style="margin-top:8px;">
            Pentru playlist-uri uria»ôe: folose»ôte cƒÉutarea + filtrele (nu √Æncerca sƒÉ vezi ‚Äútot‚Äù).
          </div>
        </div>

        <div>
          <div class="meta" style="margin: 6px 0 8px;">Editor intrare</div>

          <div class="grid2">
            <div>
              <div class="meta">Title</div>
              <input id="eTitle" type="text" placeholder="ex: RO - PRO CINEMA HD" />
            </div>
            <div>
              <div class="meta">Group</div>
              <input id="eGroup" type="text" placeholder="ex: RO - CINEMA" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="meta">URL</div>
            <input id="eUrl" type="text" placeholder="ex: http://..." />
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="save" disabled>üíæ Save</button>
            <button id="duplicate" disabled>‚éò Duplicate</button>
            <button id="remove" disabled>üóë Delete</button>
            <button id="moveUp" disabled>‚Üë Move up</button>
            <button id="moveDown" disabled>‚Üì Move down</button>
            <button id="clearSel" disabled>Clear selection</button>
          </div>

          <div class="meta" style="margin-top:10px;">
            <span class="warn">NotƒÉ:</span> editorul pƒÉstreazƒÉ formatul simplu (#EXTINF + URL). DacƒÉ ai atribute complexe (tvg-logo etc.), pot fi pierdute √Æn aceastƒÉ versiune.
            DacƒÉ vrei sƒÉ pƒÉstrƒÉm atributele, √Æ»õi fac o versiune ‚Äúlossless‚Äù.
          </div>

          <hr style="opacity:.25; margin: 14px 0;">

          <div class="meta">Mod rapid (raw): editeazƒÉ textul »ôi re-parseazƒÉ</div>
          <textarea id="raw" placeholder="#EXTM3U ..."></textarea>
          <div class="row" style="margin-top:10px;">
            <button id="parseRaw">Parse raw</button>
            <button id="refreshRaw" disabled>Refresh raw from model</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);

    // UI
    const el = {
      file: $("#file"),
      newEmpty: $("#newEmpty"),
      export: $("#export"),
      exportSel: $("#exportSel"),
      status: $("#status"),
      q: $("#q"),
      groupSel: $("#groupSel"),
      limit: $("#limit"),
      stats: $("#stats"),
      list: $("#list"),

      eTitle: $("#eTitle"),
      eGroup: $("#eGroup"),
      eUrl: $("#eUrl"),
      save: $("#save"),
      duplicate: $("#duplicate"),
      remove: $("#remove"),
      moveUp: $("#moveUp"),
      moveDown: $("#moveDown"),
      clearSel: $("#clearSel"),

      raw: $("#raw"),
      parseRaw: $("#parseRaw"),
      refreshRaw: $("#refreshRaw"),
    };

    // Model
    // IMPORTANT: aici pƒÉstrƒÉm doar title/url/group √Æn versiunea simplƒÉ.
    // (DacƒÉ vrei lossless cu tvg-logo etc., √Æ»õi fac imediat.)
    let entries = []; // {title,url,group}
    let selectedIndex = -1; // index √Æn entries
    let viewIdx = []; // indexe √Æn entries (dupƒÉ filtrare)

    const headerRe = /^\s*#+\s*(.*?)\s*#+\s*$/; // ##### GROUP #####

    function setStatus(t){ el.status.textContent = t; }
    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function rebuildGroupSelect(){
      const groups = new Set(entries.map(e => (e.group || "").trim()).filter(Boolean));
      const arr = ["__all__", ...Array.from(groups).sort((a,b)=>a.localeCompare(b))];

      const current = el.groupSel.value;
      el.groupSel.innerHTML = "";
      for (const g of arr){
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = (g === "__all__") ? "All groups" : g;
        el.groupSel.appendChild(opt);
      }
      // restore
      if (arr.includes(current)) el.groupSel.value = current;
    }

    function parseM3U(text){
      const lines = text.replace(/\r/g, "").split("\n");
      const out = [];
      let pendingTitle = "";
      let currentGroup = "Ungrouped";

      for (const raw of lines){
        const line = raw.trim();
        if (!line) continue;

        if (line.startsWith("#EXTINF:")){
          const comma = line.indexOf(",");
          pendingTitle = (comma !== -1) ? line.slice(comma + 1).trim() : "";
          continue;
        }

        if (line.startsWith("#")) {
          // ignore other tags (#EXTM3U, #KODIPROP etc.)
          continue;
        }

        // URL line
        const m = pendingTitle.match(headerRe);
        if (m){
          const g = (m[1] || "").trim();
          if (g) currentGroup = g;
          pendingTitle = "";
          continue;
        }

        out.push({
          title: pendingTitle || line,
          url: line,
          group: currentGroup || "Ungrouped",
        });
        pendingTitle = "";
      }
      return out;
    }

    function toM3U(list){
      // Export format:
      // #EXTM3U
      // ##### GROUP #####
      // #EXTINF:-1,Title
      // URL
      let out = "#EXTM3U\n";
      let lastGroup = null;

      for (const e of list){
        const g = (e.group || "Ungrouped").trim() || "Ungrouped";
        if (g !== lastGroup){
          out += `#EXTINF:-1,##### ${g} #####\n`;
          out += `#\n`; // separator comment (optional)
          lastGroup = g;
        }
        const title = (e.title || "").trim() || e.url;
        out += `#EXTINF:-1,${title}\n`;
        out += `${e.url}\n`;
      }
      return out;
    }

    function downloadText(filename, text, mime){
      const blob = new Blob([text], {type: mime || "text/plain"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    }

    function getLimit(){ return parseInt(el.limit.value, 10) || 500; }

    function passesFilters(e){
      const q = el.q.value.trim().toLowerCase();
      const gsel = el.groupSel.value;

      if (gsel && gsel !== "__all__"){
        if ((e.group || "") !== gsel) return false;
      }

      if (!q) return true;
      const hay = (e.title + " " + e.url + " " + (e.group || "")).toLowerCase();
      return hay.includes(q);
    }

    function render(){
      el.stats.textContent = `${entries.length.toLocaleString("ro-RO")} entries`;
      el.export.disabled = entries.length === 0;
      el.refreshRaw.disabled = entries.length === 0;

      rebuildGroupSelect();

      // build view
      viewIdx = [];
      const lim = getLimit();
      for (let i = 0; i < entries.length; i++){
        if (!passesFilters(entries[i])) continue;
        viewIdx.push(i);
        if (viewIdx.length >= lim) break;
      }

      el.exportSel.disabled = viewIdx.length === 0;

      el.list.innerHTML = "";
      if (viewIdx.length === 0){
        el.list.innerHTML = `<div class="item">
          <div class="idx">‚Äî</div>
          <div>
            <div class="title">Niciun rezultat</div>
            <div class="sub">SchimbƒÉ cƒÉutarea / group / limit.</div>
          </div>
        </div>`;
        return;
      }

      for (let k = 0; k < viewIdx.length; k++){
        const i = viewIdx[k];
        const e = entries[i];
        const div = document.createElement("div");
        div.className = "item" + (i === selectedIndex ? " active" : "");
        div.innerHTML = `
          <div class="idx">#${i+1}</div>
          <div>
            <div class="title">${esc(e.title)}</div>
            <div class="sub">${esc(e.group)} ¬∑ ${esc(e.url)}</div>
          </div>
        `;
        div.addEventListener("click", () => select(i));
        el.list.appendChild(div);
      }

      setStatus(`Afi»ôez ${viewIdx.length} rezultate (din ${entries.length.toLocaleString("ro-RO")}).`);
    }

    function select(i){
      selectedIndex = i;
      const e = entries[i];

      el.eTitle.value = e.title || "";
      el.eGroup.value = e.group || "";
      el.eUrl.value = e.url || "";

      el.save.disabled = false;
      el.duplicate.disabled = false;
      el.remove.disabled = false;
      el.moveUp.disabled = (i <= 0);
      el.moveDown.disabled = (i >= entries.length - 1);
      el.clearSel.disabled = false;

      render();
    }

    function clearSelection(){
      selectedIndex = -1;
      el.eTitle.value = "";
      el.eGroup.value = "";
      el.eUrl.value = "";

      el.save.disabled = true;
      el.duplicate.disabled = true;
      el.remove.disabled = true;
      el.moveUp.disabled = true;
      el.moveDown.disabled = true;
      el.clearSel.disabled = true;

      render();
    }

    // Events
    el.file.addEventListener("change", async () => {
      const f = el.file.files?.[0];
      if (!f) return;
      const txt = await f.text();
      entries = parseM3U(txt);
      clearSelection();
      el.raw.value = txt;
      setStatus(`√éncƒÉrcat: ${f.name} ¬∑ ${entries.length.toLocaleString("ro-RO")} intrƒÉri`);
      render();
    });

    el.newEmpty.addEventListener("click", () => {
      entries = [];
      el.raw.value = "#EXTM3U\n";
      clearSelection();
      setStatus("Playlist nou (gol).");
      render();
    });

    el.q.addEventListener("input", () => render());
    el.groupSel.addEventListener("change", () => render());
    el.limit.addEventListener("change", () => render());

    el.save.addEventListener("click", () => {
      if (selectedIndex < 0) return;
      const title = el.eTitle.value.trim();
      const group = el.eGroup.value.trim() || "Ungrouped";
      const url = el.eUrl.value.trim();

      if (!url){
        alert("URL lipsƒÉ.");
        return;
      }

      entries[selectedIndex] = { title: title || url, group, url };
      setStatus("Salvat.");
      render();
    });

    el.duplicate.addEventListener("click", () => {
      if (selectedIndex < 0) return;
      const copy = {...entries[selectedIndex]};
      entries.splice(selectedIndex + 1, 0, copy);
      setStatus("Duplicat.");
      select(selectedIndex + 1);
    });

    el.remove.addEventListener("click", () => {
      if (selectedIndex < 0) return;
      const ok = confirm("»òtergi intrarea selectatƒÉ?");
      if (!ok) return;
      entries.splice(selectedIndex, 1);
      setStatus("»òters.");
      clearSelection();
    });

    el.moveUp.addEventListener("click", () => {
      if (selectedIndex <= 0) return;
      const i = selectedIndex;
      [entries[i-1], entries[i]] = [entries[i], entries[i-1]];
      select(i - 1);
      setStatus("Mutat √Æn sus.");
    });

    el.moveDown.addEventListener("click", () => {
      if (selectedIndex < 0 || selectedIndex >= entries.length - 1) return;
      const i = selectedIndex;
      [entries[i], entries[i+1]] = [entries[i+1], entries[i]];
      select(i + 1);
      setStatus("Mutat √Æn jos.");
    });

    el.clearSel.addEventListener("click", clearSelection);

    el.export.addEventListener("click", () => {
      const m3u = toM3U(entries);
      downloadText("edited.m3u", m3u, "audio/x-mpegurl");
    });

    el.exportSel.addEventListener("click", () => {
      const subset = viewIdx.map(i => entries[i]);
      const m3u = toM3U(subset);
      downloadText("selection.m3u", m3u, "audio/x-mpegurl");
    });

    el.parseRaw.addEventListener("click", () => {
      const txt = el.raw.value || "";
      entries = parseM3U(txt);
      clearSelection();
      setStatus(`Parsed raw: ${entries.length.toLocaleString("ro-RO")} intrƒÉri`);
      render();
    });

    el.refreshRaw.addEventListener("click", () => {
      const m3u = toM3U(entries);
      el.raw.value = m3u;
      setStatus("Raw refresh fƒÉcut din model.");
    });

    // init
    render();
  </script>
</body>
</html>
